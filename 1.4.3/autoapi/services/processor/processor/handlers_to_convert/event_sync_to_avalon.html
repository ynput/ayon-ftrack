<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=prev href=event_sync_links.html><link rel=next href=../lib/index.html><link rel=icon href=../../../../../img/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.9"><title>event_sync_to_avalon - ayon-ftrack</title><link rel=stylesheet href=../../../../../assets/stylesheets/main.4af4bdda.min.css><link rel=stylesheet href=../../../../../assets/stylesheets/palette.06af60db.min.css><script src=https://unpkg.com/iframe-worker/shim></script><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../../../../assets/_mkdocstrings.css><link rel=stylesheet href=../../../../../css/custom.css><script>__md_scope=new URL("../../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../../../../index.html title=ayon-ftrack class="md-header__button md-logo" aria-label=ayon-ftrack data-md-component=logo> <img src=../../../../../img/ay-symbol-blackw-full.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> ayon-ftrack </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> event_sync_to_avalon </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ynput/ayon-ftrack title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../../../../index.html title=ayon-ftrack class="md-nav__button md-logo" aria-label=ayon-ftrack data-md-component=logo> <img src=../../../../../img/ay-symbol-blackw-full.png alt=logo> </a> ayon-ftrack </label> <div class=md-nav__source> <a href=https://github.com/ynput/ayon-ftrack title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../../../index.html class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../../../../license.html class=md-nav__link> <span class=md-ellipsis> License </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../client/ayon_ftrack/common/constants.html class=md-nav__link> <span class=md-ellipsis> client </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../server/ftrack_session.html class=md-nav__link> <span class=md-ellipsis> server </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../../service_tools/main.html class=md-nav__link> <span class=md-ellipsis> service_tools </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4 checked> <label class=md-nav__link for=__nav_3_4 id=__nav_3_4_label tabindex=0> <span class=md-ellipsis> services </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_4_label aria-expanded=true> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> services </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../leecher/leecher/__main__.html class=md-nav__link> <span class=md-ellipsis> leecher </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4_2 checked> <label class=md-nav__link for=__nav_3_4_2 id=__nav_3_4_2_label tabindex=0> <span class=md-ellipsis> processor </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_4_2_label aria-expanded=true> <label class=md-nav__title for=__nav_3_4_2> <span class="md-nav__icon md-icon"></span> processor </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4_2_1 checked> <div class="md-nav__link md-nav__container"> <a href=../index.html class="md-nav__link "> <span class=md-ellipsis> processor </span> </a> <label class="md-nav__link " for=__nav_3_4_2_1 id=__nav_3_4_2_1_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=4 aria-labelledby=__nav_3_4_2_1_label aria-expanded=true> <label class=md-nav__title for=__nav_3_4_2_1> <span class="md-nav__icon md-icon"></span> processor </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../__main__.html class=md-nav__link> <span class=md-ellipsis> __main__ </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../default_handlers/action_clone_review_session.html class=md-nav__link> <span class=md-ellipsis> default_handlers </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../download_utils.html class=md-nav__link> <span class=md-ellipsis> download_utils </span> </a> </li> <li class=md-nav__item> <a href=../ftrack_session.html class=md-nav__link> <span class=md-ellipsis> ftrack_session </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_4_2_1_5 checked> <div class="md-nav__link md-nav__container"> <a href=index.html class="md-nav__link "> <span class=md-ellipsis> handlers_to_convert </span> </a> <label class="md-nav__link " for=__nav_3_4_2_1_5 id=__nav_3_4_2_1_5_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=5 aria-labelledby=__nav_3_4_2_1_5_label aria-expanded=true> <label class=md-nav__title for=__nav_3_4_2_1_5> <span class="md-nav__icon md-icon"></span> handlers_to_convert </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=action_create_review_session.html class=md-nav__link> <span class=md-ellipsis> action_create_review_session </span> </a> </li> <li class=md-nav__item> <a href=event_del_avalon_id_from_new.html class=md-nav__link> <span class=md-ellipsis> event_del_avalon_id_from_new </span> </a> </li> <li class=md-nav__item> <a href=event_sync_links.html class=md-nav__link> <span class=md-ellipsis> event_sync_links </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> event_sync_to_avalon </span> <span class="md-nav__icon md-icon"></span> </label> <a href=event_sync_to_avalon.html class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> event_sync_to_avalon </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon class=md-nav__link> <span class=md-ellipsis> event_sync_to_avalon </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent class=md-nav__link> <span class=md-ellipsis> SyncToAvalonEvent </span> </a> <nav class=md-nav aria-label=SyncToAvalonEvent> <ul class=md-nav__list> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.changeability_by_mongo_id class=md-nav__link> <span class=md-ellipsis> changeability_by_mongo_id </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.check_names_synchronizable class=md-nav__link> <span class=md-ellipsis> check_names_synchronizable </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.debug_logs class=md-nav__link> <span class=md-ellipsis> debug_logs </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.get_ent_path class=md-nav__link> <span class=md-ellipsis> get_ent_path </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.launch class=md-nav__link> <span class=md-ellipsis> launch </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_moved class=md-nav__link> <span class=md-ellipsis> process_moved </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_removed class=md-nav__link> <span class=md-ellipsis> process_removed </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_task_updates class=md-nav__link> <span class=md-ellipsis> process_task_updates </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_updated class=md-nav__link> <span class=md-ellipsis> process_updated </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.reset_variables class=md-nav__link> <span class=md-ellipsis> reset_variables </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.update_entities class=md-nav__link> <span class=md-ellipsis> update_entities </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../lib/sync_from_ftrack.html class=md-nav__link> <span class=md-ellipsis> lib </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../server.html class=md-nav__link> <span class=md-ellipsis> server </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../../transmitter/transmitter/__main__.html class=md-nav__link> <span class=md-ellipsis> transmitter </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon class=md-nav__link> <span class=md-ellipsis> event_sync_to_avalon </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent class=md-nav__link> <span class=md-ellipsis> SyncToAvalonEvent </span> </a> <nav class=md-nav aria-label=SyncToAvalonEvent> <ul class=md-nav__list> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.changeability_by_mongo_id class=md-nav__link> <span class=md-ellipsis> changeability_by_mongo_id </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.__init__ class=md-nav__link> <span class=md-ellipsis> __init__ </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.check_names_synchronizable class=md-nav__link> <span class=md-ellipsis> check_names_synchronizable </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.debug_logs class=md-nav__link> <span class=md-ellipsis> debug_logs </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.get_ent_path class=md-nav__link> <span class=md-ellipsis> get_ent_path </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.launch class=md-nav__link> <span class=md-ellipsis> launch </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_moved class=md-nav__link> <span class=md-ellipsis> process_moved </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_removed class=md-nav__link> <span class=md-ellipsis> process_removed </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_task_updates class=md-nav__link> <span class=md-ellipsis> process_task_updates </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_updated class=md-nav__link> <span class=md-ellipsis> process_updated </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.reset_variables class=md-nav__link> <span class=md-ellipsis> reset_variables </span> </a> </li> <li class=md-nav__item> <a href=#services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.update_entities class=md-nav__link> <span class=md-ellipsis> update_entities </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1>event_sync_to_avalon</h1> <div class="doc doc-object doc-module"> <a id=services.processor.processor.handlers_to_convert.event_sync_to_avalon></a> <div class="doc doc-contents first"> <div class="doc doc-children"> <div class="doc doc-object doc-class"> <h2 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent class="doc doc-heading"> <code>SyncToAvalonEvent</code> </h2> <div class="doc doc-contents "> <p class="doc doc-class-bases"> Bases: <code><span title=ftrack_common.BaseEventHandler>BaseEventHandler</span></code></p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>  43</span>
<span class=normal>  44</span>
<span class=normal>  45</span>
<span class=normal>  46</span>
<span class=normal>  47</span>
<span class=normal>  48</span>
<span class=normal>  49</span>
<span class=normal>  50</span>
<span class=normal>  51</span>
<span class=normal>  52</span>
<span class=normal>  53</span>
<span class=normal>  54</span>
<span class=normal>  55</span>
<span class=normal>  56</span>
<span class=normal>  57</span>
<span class=normal>  58</span>
<span class=normal>  59</span>
<span class=normal>  60</span>
<span class=normal>  61</span>
<span class=normal>  62</span>
<span class=normal>  63</span>
<span class=normal>  64</span>
<span class=normal>  65</span>
<span class=normal>  66</span>
<span class=normal>  67</span>
<span class=normal>  68</span>
<span class=normal>  69</span>
<span class=normal>  70</span>
<span class=normal>  71</span>
<span class=normal>  72</span>
<span class=normal>  73</span>
<span class=normal>  74</span>
<span class=normal>  75</span>
<span class=normal>  76</span>
<span class=normal>  77</span>
<span class=normal>  78</span>
<span class=normal>  79</span>
<span class=normal>  80</span>
<span class=normal>  81</span>
<span class=normal>  82</span>
<span class=normal>  83</span>
<span class=normal>  84</span>
<span class=normal>  85</span>
<span class=normal>  86</span>
<span class=normal>  87</span>
<span class=normal>  88</span>
<span class=normal>  89</span>
<span class=normal>  90</span>
<span class=normal>  91</span>
<span class=normal>  92</span>
<span class=normal>  93</span>
<span class=normal>  94</span>
<span class=normal>  95</span>
<span class=normal>  96</span>
<span class=normal>  97</span>
<span class=normal>  98</span>
<span class=normal>  99</span>
<span class=normal> 100</span>
<span class=normal> 101</span>
<span class=normal> 102</span>
<span class=normal> 103</span>
<span class=normal> 104</span>
<span class=normal> 105</span>
<span class=normal> 106</span>
<span class=normal> 107</span>
<span class=normal> 108</span>
<span class=normal> 109</span>
<span class=normal> 110</span>
<span class=normal> 111</span>
<span class=normal> 112</span>
<span class=normal> 113</span>
<span class=normal> 114</span>
<span class=normal> 115</span>
<span class=normal> 116</span>
<span class=normal> 117</span>
<span class=normal> 118</span>
<span class=normal> 119</span>
<span class=normal> 120</span>
<span class=normal> 121</span>
<span class=normal> 122</span>
<span class=normal> 123</span>
<span class=normal> 124</span>
<span class=normal> 125</span>
<span class=normal> 126</span>
<span class=normal> 127</span>
<span class=normal> 128</span>
<span class=normal> 129</span>
<span class=normal> 130</span>
<span class=normal> 131</span>
<span class=normal> 132</span>
<span class=normal> 133</span>
<span class=normal> 134</span>
<span class=normal> 135</span>
<span class=normal> 136</span>
<span class=normal> 137</span>
<span class=normal> 138</span>
<span class=normal> 139</span>
<span class=normal> 140</span>
<span class=normal> 141</span>
<span class=normal> 142</span>
<span class=normal> 143</span>
<span class=normal> 144</span>
<span class=normal> 145</span>
<span class=normal> 146</span>
<span class=normal> 147</span>
<span class=normal> 148</span>
<span class=normal> 149</span>
<span class=normal> 150</span>
<span class=normal> 151</span>
<span class=normal> 152</span>
<span class=normal> 153</span>
<span class=normal> 154</span>
<span class=normal> 155</span>
<span class=normal> 156</span>
<span class=normal> 157</span>
<span class=normal> 158</span>
<span class=normal> 159</span>
<span class=normal> 160</span>
<span class=normal> 161</span>
<span class=normal> 162</span>
<span class=normal> 163</span>
<span class=normal> 164</span>
<span class=normal> 165</span>
<span class=normal> 166</span>
<span class=normal> 167</span>
<span class=normal> 168</span>
<span class=normal> 169</span>
<span class=normal> 170</span>
<span class=normal> 171</span>
<span class=normal> 172</span>
<span class=normal> 173</span>
<span class=normal> 174</span>
<span class=normal> 175</span>
<span class=normal> 176</span>
<span class=normal> 177</span>
<span class=normal> 178</span>
<span class=normal> 179</span>
<span class=normal> 180</span>
<span class=normal> 181</span>
<span class=normal> 182</span>
<span class=normal> 183</span>
<span class=normal> 184</span>
<span class=normal> 185</span>
<span class=normal> 186</span>
<span class=normal> 187</span>
<span class=normal> 188</span>
<span class=normal> 189</span>
<span class=normal> 190</span>
<span class=normal> 191</span>
<span class=normal> 192</span>
<span class=normal> 193</span>
<span class=normal> 194</span>
<span class=normal> 195</span>
<span class=normal> 196</span>
<span class=normal> 197</span>
<span class=normal> 198</span>
<span class=normal> 199</span>
<span class=normal> 200</span>
<span class=normal> 201</span>
<span class=normal> 202</span>
<span class=normal> 203</span>
<span class=normal> 204</span>
<span class=normal> 205</span>
<span class=normal> 206</span>
<span class=normal> 207</span>
<span class=normal> 208</span>
<span class=normal> 209</span>
<span class=normal> 210</span>
<span class=normal> 211</span>
<span class=normal> 212</span>
<span class=normal> 213</span>
<span class=normal> 214</span>
<span class=normal> 215</span>
<span class=normal> 216</span>
<span class=normal> 217</span>
<span class=normal> 218</span>
<span class=normal> 219</span>
<span class=normal> 220</span>
<span class=normal> 221</span>
<span class=normal> 222</span>
<span class=normal> 223</span>
<span class=normal> 224</span>
<span class=normal> 225</span>
<span class=normal> 226</span>
<span class=normal> 227</span>
<span class=normal> 228</span>
<span class=normal> 229</span>
<span class=normal> 230</span>
<span class=normal> 231</span>
<span class=normal> 232</span>
<span class=normal> 233</span>
<span class=normal> 234</span>
<span class=normal> 235</span>
<span class=normal> 236</span>
<span class=normal> 237</span>
<span class=normal> 238</span>
<span class=normal> 239</span>
<span class=normal> 240</span>
<span class=normal> 241</span>
<span class=normal> 242</span>
<span class=normal> 243</span>
<span class=normal> 244</span>
<span class=normal> 245</span>
<span class=normal> 246</span>
<span class=normal> 247</span>
<span class=normal> 248</span>
<span class=normal> 249</span>
<span class=normal> 250</span>
<span class=normal> 251</span>
<span class=normal> 252</span>
<span class=normal> 253</span>
<span class=normal> 254</span>
<span class=normal> 255</span>
<span class=normal> 256</span>
<span class=normal> 257</span>
<span class=normal> 258</span>
<span class=normal> 259</span>
<span class=normal> 260</span>
<span class=normal> 261</span>
<span class=normal> 262</span>
<span class=normal> 263</span>
<span class=normal> 264</span>
<span class=normal> 265</span>
<span class=normal> 266</span>
<span class=normal> 267</span>
<span class=normal> 268</span>
<span class=normal> 269</span>
<span class=normal> 270</span>
<span class=normal> 271</span>
<span class=normal> 272</span>
<span class=normal> 273</span>
<span class=normal> 274</span>
<span class=normal> 275</span>
<span class=normal> 276</span>
<span class=normal> 277</span>
<span class=normal> 278</span>
<span class=normal> 279</span>
<span class=normal> 280</span>
<span class=normal> 281</span>
<span class=normal> 282</span>
<span class=normal> 283</span>
<span class=normal> 284</span>
<span class=normal> 285</span>
<span class=normal> 286</span>
<span class=normal> 287</span>
<span class=normal> 288</span>
<span class=normal> 289</span>
<span class=normal> 290</span>
<span class=normal> 291</span>
<span class=normal> 292</span>
<span class=normal> 293</span>
<span class=normal> 294</span>
<span class=normal> 295</span>
<span class=normal> 296</span>
<span class=normal> 297</span>
<span class=normal> 298</span>
<span class=normal> 299</span>
<span class=normal> 300</span>
<span class=normal> 301</span>
<span class=normal> 302</span>
<span class=normal> 303</span>
<span class=normal> 304</span>
<span class=normal> 305</span>
<span class=normal> 306</span>
<span class=normal> 307</span>
<span class=normal> 308</span>
<span class=normal> 309</span>
<span class=normal> 310</span>
<span class=normal> 311</span>
<span class=normal> 312</span>
<span class=normal> 313</span>
<span class=normal> 314</span>
<span class=normal> 315</span>
<span class=normal> 316</span>
<span class=normal> 317</span>
<span class=normal> 318</span>
<span class=normal> 319</span>
<span class=normal> 320</span>
<span class=normal> 321</span>
<span class=normal> 322</span>
<span class=normal> 323</span>
<span class=normal> 324</span>
<span class=normal> 325</span>
<span class=normal> 326</span>
<span class=normal> 327</span>
<span class=normal> 328</span>
<span class=normal> 329</span>
<span class=normal> 330</span>
<span class=normal> 331</span>
<span class=normal> 332</span>
<span class=normal> 333</span>
<span class=normal> 334</span>
<span class=normal> 335</span>
<span class=normal> 336</span>
<span class=normal> 337</span>
<span class=normal> 338</span>
<span class=normal> 339</span>
<span class=normal> 340</span>
<span class=normal> 341</span>
<span class=normal> 342</span>
<span class=normal> 343</span>
<span class=normal> 344</span>
<span class=normal> 345</span>
<span class=normal> 346</span>
<span class=normal> 347</span>
<span class=normal> 348</span>
<span class=normal> 349</span>
<span class=normal> 350</span>
<span class=normal> 351</span>
<span class=normal> 352</span>
<span class=normal> 353</span>
<span class=normal> 354</span>
<span class=normal> 355</span>
<span class=normal> 356</span>
<span class=normal> 357</span>
<span class=normal> 358</span>
<span class=normal> 359</span>
<span class=normal> 360</span>
<span class=normal> 361</span>
<span class=normal> 362</span>
<span class=normal> 363</span>
<span class=normal> 364</span>
<span class=normal> 365</span>
<span class=normal> 366</span>
<span class=normal> 367</span>
<span class=normal> 368</span>
<span class=normal> 369</span>
<span class=normal> 370</span>
<span class=normal> 371</span>
<span class=normal> 372</span>
<span class=normal> 373</span>
<span class=normal> 374</span>
<span class=normal> 375</span>
<span class=normal> 376</span>
<span class=normal> 377</span>
<span class=normal> 378</span>
<span class=normal> 379</span>
<span class=normal> 380</span>
<span class=normal> 381</span>
<span class=normal> 382</span>
<span class=normal> 383</span>
<span class=normal> 384</span>
<span class=normal> 385</span>
<span class=normal> 386</span>
<span class=normal> 387</span>
<span class=normal> 388</span>
<span class=normal> 389</span>
<span class=normal> 390</span>
<span class=normal> 391</span>
<span class=normal> 392</span>
<span class=normal> 393</span>
<span class=normal> 394</span>
<span class=normal> 395</span>
<span class=normal> 396</span>
<span class=normal> 397</span>
<span class=normal> 398</span>
<span class=normal> 399</span>
<span class=normal> 400</span>
<span class=normal> 401</span>
<span class=normal> 402</span>
<span class=normal> 403</span>
<span class=normal> 404</span>
<span class=normal> 405</span>
<span class=normal> 406</span>
<span class=normal> 407</span>
<span class=normal> 408</span>
<span class=normal> 409</span>
<span class=normal> 410</span>
<span class=normal> 411</span>
<span class=normal> 412</span>
<span class=normal> 413</span>
<span class=normal> 414</span>
<span class=normal> 415</span>
<span class=normal> 416</span>
<span class=normal> 417</span>
<span class=normal> 418</span>
<span class=normal> 419</span>
<span class=normal> 420</span>
<span class=normal> 421</span>
<span class=normal> 422</span>
<span class=normal> 423</span>
<span class=normal> 424</span>
<span class=normal> 425</span>
<span class=normal> 426</span>
<span class=normal> 427</span>
<span class=normal> 428</span>
<span class=normal> 429</span>
<span class=normal> 430</span>
<span class=normal> 431</span>
<span class=normal> 432</span>
<span class=normal> 433</span>
<span class=normal> 434</span>
<span class=normal> 435</span>
<span class=normal> 436</span>
<span class=normal> 437</span>
<span class=normal> 438</span>
<span class=normal> 439</span>
<span class=normal> 440</span>
<span class=normal> 441</span>
<span class=normal> 442</span>
<span class=normal> 443</span>
<span class=normal> 444</span>
<span class=normal> 445</span>
<span class=normal> 446</span>
<span class=normal> 447</span>
<span class=normal> 448</span>
<span class=normal> 449</span>
<span class=normal> 450</span>
<span class=normal> 451</span>
<span class=normal> 452</span>
<span class=normal> 453</span>
<span class=normal> 454</span>
<span class=normal> 455</span>
<span class=normal> 456</span>
<span class=normal> 457</span>
<span class=normal> 458</span>
<span class=normal> 459</span>
<span class=normal> 460</span>
<span class=normal> 461</span>
<span class=normal> 462</span>
<span class=normal> 463</span>
<span class=normal> 464</span>
<span class=normal> 465</span>
<span class=normal> 466</span>
<span class=normal> 467</span>
<span class=normal> 468</span>
<span class=normal> 469</span>
<span class=normal> 470</span>
<span class=normal> 471</span>
<span class=normal> 472</span>
<span class=normal> 473</span>
<span class=normal> 474</span>
<span class=normal> 475</span>
<span class=normal> 476</span>
<span class=normal> 477</span>
<span class=normal> 478</span>
<span class=normal> 479</span>
<span class=normal> 480</span>
<span class=normal> 481</span>
<span class=normal> 482</span>
<span class=normal> 483</span>
<span class=normal> 484</span>
<span class=normal> 485</span>
<span class=normal> 486</span>
<span class=normal> 487</span>
<span class=normal> 488</span>
<span class=normal> 489</span>
<span class=normal> 490</span>
<span class=normal> 491</span>
<span class=normal> 492</span>
<span class=normal> 493</span>
<span class=normal> 494</span>
<span class=normal> 495</span>
<span class=normal> 496</span>
<span class=normal> 497</span>
<span class=normal> 498</span>
<span class=normal> 499</span>
<span class=normal> 500</span>
<span class=normal> 501</span>
<span class=normal> 502</span>
<span class=normal> 503</span>
<span class=normal> 504</span>
<span class=normal> 505</span>
<span class=normal> 506</span>
<span class=normal> 507</span>
<span class=normal> 508</span>
<span class=normal> 509</span>
<span class=normal> 510</span>
<span class=normal> 511</span>
<span class=normal> 512</span>
<span class=normal> 513</span>
<span class=normal> 514</span>
<span class=normal> 515</span>
<span class=normal> 516</span>
<span class=normal> 517</span>
<span class=normal> 518</span>
<span class=normal> 519</span>
<span class=normal> 520</span>
<span class=normal> 521</span>
<span class=normal> 522</span>
<span class=normal> 523</span>
<span class=normal> 524</span>
<span class=normal> 525</span>
<span class=normal> 526</span>
<span class=normal> 527</span>
<span class=normal> 528</span>
<span class=normal> 529</span>
<span class=normal> 530</span>
<span class=normal> 531</span>
<span class=normal> 532</span>
<span class=normal> 533</span>
<span class=normal> 534</span>
<span class=normal> 535</span>
<span class=normal> 536</span>
<span class=normal> 537</span>
<span class=normal> 538</span>
<span class=normal> 539</span>
<span class=normal> 540</span>
<span class=normal> 541</span>
<span class=normal> 542</span>
<span class=normal> 543</span>
<span class=normal> 544</span>
<span class=normal> 545</span>
<span class=normal> 546</span>
<span class=normal> 547</span>
<span class=normal> 548</span>
<span class=normal> 549</span>
<span class=normal> 550</span>
<span class=normal> 551</span>
<span class=normal> 552</span>
<span class=normal> 553</span>
<span class=normal> 554</span>
<span class=normal> 555</span>
<span class=normal> 556</span>
<span class=normal> 557</span>
<span class=normal> 558</span>
<span class=normal> 559</span>
<span class=normal> 560</span>
<span class=normal> 561</span>
<span class=normal> 562</span>
<span class=normal> 563</span>
<span class=normal> 564</span>
<span class=normal> 565</span>
<span class=normal> 566</span>
<span class=normal> 567</span>
<span class=normal> 568</span>
<span class=normal> 569</span>
<span class=normal> 570</span>
<span class=normal> 571</span>
<span class=normal> 572</span>
<span class=normal> 573</span>
<span class=normal> 574</span>
<span class=normal> 575</span>
<span class=normal> 576</span>
<span class=normal> 577</span>
<span class=normal> 578</span>
<span class=normal> 579</span>
<span class=normal> 580</span>
<span class=normal> 581</span>
<span class=normal> 582</span>
<span class=normal> 583</span>
<span class=normal> 584</span>
<span class=normal> 585</span>
<span class=normal> 586</span>
<span class=normal> 587</span>
<span class=normal> 588</span>
<span class=normal> 589</span>
<span class=normal> 590</span>
<span class=normal> 591</span>
<span class=normal> 592</span>
<span class=normal> 593</span>
<span class=normal> 594</span>
<span class=normal> 595</span>
<span class=normal> 596</span>
<span class=normal> 597</span>
<span class=normal> 598</span>
<span class=normal> 599</span>
<span class=normal> 600</span>
<span class=normal> 601</span>
<span class=normal> 602</span>
<span class=normal> 603</span>
<span class=normal> 604</span>
<span class=normal> 605</span>
<span class=normal> 606</span>
<span class=normal> 607</span>
<span class=normal> 608</span>
<span class=normal> 609</span>
<span class=normal> 610</span>
<span class=normal> 611</span>
<span class=normal> 612</span>
<span class=normal> 613</span>
<span class=normal> 614</span>
<span class=normal> 615</span>
<span class=normal> 616</span>
<span class=normal> 617</span>
<span class=normal> 618</span>
<span class=normal> 619</span>
<span class=normal> 620</span>
<span class=normal> 621</span>
<span class=normal> 622</span>
<span class=normal> 623</span>
<span class=normal> 624</span>
<span class=normal> 625</span>
<span class=normal> 626</span>
<span class=normal> 627</span>
<span class=normal> 628</span>
<span class=normal> 629</span>
<span class=normal> 630</span>
<span class=normal> 631</span>
<span class=normal> 632</span>
<span class=normal> 633</span>
<span class=normal> 634</span>
<span class=normal> 635</span>
<span class=normal> 636</span>
<span class=normal> 637</span>
<span class=normal> 638</span>
<span class=normal> 639</span>
<span class=normal> 640</span>
<span class=normal> 641</span>
<span class=normal> 642</span>
<span class=normal> 643</span>
<span class=normal> 644</span>
<span class=normal> 645</span>
<span class=normal> 646</span>
<span class=normal> 647</span>
<span class=normal> 648</span>
<span class=normal> 649</span>
<span class=normal> 650</span>
<span class=normal> 651</span>
<span class=normal> 652</span>
<span class=normal> 653</span>
<span class=normal> 654</span>
<span class=normal> 655</span>
<span class=normal> 656</span>
<span class=normal> 657</span>
<span class=normal> 658</span>
<span class=normal> 659</span>
<span class=normal> 660</span>
<span class=normal> 661</span>
<span class=normal> 662</span>
<span class=normal> 663</span>
<span class=normal> 664</span>
<span class=normal> 665</span>
<span class=normal> 666</span>
<span class=normal> 667</span>
<span class=normal> 668</span>
<span class=normal> 669</span>
<span class=normal> 670</span>
<span class=normal> 671</span>
<span class=normal> 672</span>
<span class=normal> 673</span>
<span class=normal> 674</span>
<span class=normal> 675</span>
<span class=normal> 676</span>
<span class=normal> 677</span>
<span class=normal> 678</span>
<span class=normal> 679</span>
<span class=normal> 680</span>
<span class=normal> 681</span>
<span class=normal> 682</span>
<span class=normal> 683</span>
<span class=normal> 684</span>
<span class=normal> 685</span>
<span class=normal> 686</span>
<span class=normal> 687</span>
<span class=normal> 688</span>
<span class=normal> 689</span>
<span class=normal> 690</span>
<span class=normal> 691</span>
<span class=normal> 692</span>
<span class=normal> 693</span>
<span class=normal> 694</span>
<span class=normal> 695</span>
<span class=normal> 696</span>
<span class=normal> 697</span>
<span class=normal> 698</span>
<span class=normal> 699</span>
<span class=normal> 700</span>
<span class=normal> 701</span>
<span class=normal> 702</span>
<span class=normal> 703</span>
<span class=normal> 704</span>
<span class=normal> 705</span>
<span class=normal> 706</span>
<span class=normal> 707</span>
<span class=normal> 708</span>
<span class=normal> 709</span>
<span class=normal> 710</span>
<span class=normal> 711</span>
<span class=normal> 712</span>
<span class=normal> 713</span>
<span class=normal> 714</span>
<span class=normal> 715</span>
<span class=normal> 716</span>
<span class=normal> 717</span>
<span class=normal> 718</span>
<span class=normal> 719</span>
<span class=normal> 720</span>
<span class=normal> 721</span>
<span class=normal> 722</span>
<span class=normal> 723</span>
<span class=normal> 724</span>
<span class=normal> 725</span>
<span class=normal> 726</span>
<span class=normal> 727</span>
<span class=normal> 728</span>
<span class=normal> 729</span>
<span class=normal> 730</span>
<span class=normal> 731</span>
<span class=normal> 732</span>
<span class=normal> 733</span>
<span class=normal> 734</span>
<span class=normal> 735</span>
<span class=normal> 736</span>
<span class=normal> 737</span>
<span class=normal> 738</span>
<span class=normal> 739</span>
<span class=normal> 740</span>
<span class=normal> 741</span>
<span class=normal> 742</span>
<span class=normal> 743</span>
<span class=normal> 744</span>
<span class=normal> 745</span>
<span class=normal> 746</span>
<span class=normal> 747</span>
<span class=normal> 748</span>
<span class=normal> 749</span>
<span class=normal> 750</span>
<span class=normal> 751</span>
<span class=normal> 752</span>
<span class=normal> 753</span>
<span class=normal> 754</span>
<span class=normal> 755</span>
<span class=normal> 756</span>
<span class=normal> 757</span>
<span class=normal> 758</span>
<span class=normal> 759</span>
<span class=normal> 760</span>
<span class=normal> 761</span>
<span class=normal> 762</span>
<span class=normal> 763</span>
<span class=normal> 764</span>
<span class=normal> 765</span>
<span class=normal> 766</span>
<span class=normal> 767</span>
<span class=normal> 768</span>
<span class=normal> 769</span>
<span class=normal> 770</span>
<span class=normal> 771</span>
<span class=normal> 772</span>
<span class=normal> 773</span>
<span class=normal> 774</span>
<span class=normal> 775</span>
<span class=normal> 776</span>
<span class=normal> 777</span>
<span class=normal> 778</span>
<span class=normal> 779</span>
<span class=normal> 780</span>
<span class=normal> 781</span>
<span class=normal> 782</span>
<span class=normal> 783</span>
<span class=normal> 784</span>
<span class=normal> 785</span>
<span class=normal> 786</span>
<span class=normal> 787</span>
<span class=normal> 788</span>
<span class=normal> 789</span>
<span class=normal> 790</span>
<span class=normal> 791</span>
<span class=normal> 792</span>
<span class=normal> 793</span>
<span class=normal> 794</span>
<span class=normal> 795</span>
<span class=normal> 796</span>
<span class=normal> 797</span>
<span class=normal> 798</span>
<span class=normal> 799</span>
<span class=normal> 800</span>
<span class=normal> 801</span>
<span class=normal> 802</span>
<span class=normal> 803</span>
<span class=normal> 804</span>
<span class=normal> 805</span>
<span class=normal> 806</span>
<span class=normal> 807</span>
<span class=normal> 808</span>
<span class=normal> 809</span>
<span class=normal> 810</span>
<span class=normal> 811</span>
<span class=normal> 812</span>
<span class=normal> 813</span>
<span class=normal> 814</span>
<span class=normal> 815</span>
<span class=normal> 816</span>
<span class=normal> 817</span>
<span class=normal> 818</span>
<span class=normal> 819</span>
<span class=normal> 820</span>
<span class=normal> 821</span>
<span class=normal> 822</span>
<span class=normal> 823</span>
<span class=normal> 824</span>
<span class=normal> 825</span>
<span class=normal> 826</span>
<span class=normal> 827</span>
<span class=normal> 828</span>
<span class=normal> 829</span>
<span class=normal> 830</span>
<span class=normal> 831</span>
<span class=normal> 832</span>
<span class=normal> 833</span>
<span class=normal> 834</span>
<span class=normal> 835</span>
<span class=normal> 836</span>
<span class=normal> 837</span>
<span class=normal> 838</span>
<span class=normal> 839</span>
<span class=normal> 840</span>
<span class=normal> 841</span>
<span class=normal> 842</span>
<span class=normal> 843</span>
<span class=normal> 844</span>
<span class=normal> 845</span>
<span class=normal> 846</span>
<span class=normal> 847</span>
<span class=normal> 848</span>
<span class=normal> 849</span>
<span class=normal> 850</span>
<span class=normal> 851</span>
<span class=normal> 852</span>
<span class=normal> 853</span>
<span class=normal> 854</span>
<span class=normal> 855</span>
<span class=normal> 856</span>
<span class=normal> 857</span>
<span class=normal> 858</span>
<span class=normal> 859</span>
<span class=normal> 860</span>
<span class=normal> 861</span>
<span class=normal> 862</span>
<span class=normal> 863</span>
<span class=normal> 864</span>
<span class=normal> 865</span>
<span class=normal> 866</span>
<span class=normal> 867</span>
<span class=normal> 868</span>
<span class=normal> 869</span>
<span class=normal> 870</span>
<span class=normal> 871</span>
<span class=normal> 872</span>
<span class=normal> 873</span>
<span class=normal> 874</span>
<span class=normal> 875</span>
<span class=normal> 876</span>
<span class=normal> 877</span>
<span class=normal> 878</span>
<span class=normal> 879</span>
<span class=normal> 880</span>
<span class=normal> 881</span>
<span class=normal> 882</span>
<span class=normal> 883</span>
<span class=normal> 884</span>
<span class=normal> 885</span>
<span class=normal> 886</span>
<span class=normal> 887</span>
<span class=normal> 888</span>
<span class=normal> 889</span>
<span class=normal> 890</span>
<span class=normal> 891</span>
<span class=normal> 892</span>
<span class=normal> 893</span>
<span class=normal> 894</span>
<span class=normal> 895</span>
<span class=normal> 896</span>
<span class=normal> 897</span>
<span class=normal> 898</span>
<span class=normal> 899</span>
<span class=normal> 900</span>
<span class=normal> 901</span>
<span class=normal> 902</span>
<span class=normal> 903</span>
<span class=normal> 904</span>
<span class=normal> 905</span>
<span class=normal> 906</span>
<span class=normal> 907</span>
<span class=normal> 908</span>
<span class=normal> 909</span>
<span class=normal> 910</span>
<span class=normal> 911</span>
<span class=normal> 912</span>
<span class=normal> 913</span>
<span class=normal> 914</span>
<span class=normal> 915</span>
<span class=normal> 916</span>
<span class=normal> 917</span>
<span class=normal> 918</span>
<span class=normal> 919</span>
<span class=normal> 920</span>
<span class=normal> 921</span>
<span class=normal> 922</span>
<span class=normal> 923</span>
<span class=normal> 924</span>
<span class=normal> 925</span>
<span class=normal> 926</span>
<span class=normal> 927</span>
<span class=normal> 928</span>
<span class=normal> 929</span>
<span class=normal> 930</span>
<span class=normal> 931</span>
<span class=normal> 932</span>
<span class=normal> 933</span>
<span class=normal> 934</span>
<span class=normal> 935</span>
<span class=normal> 936</span>
<span class=normal> 937</span>
<span class=normal> 938</span>
<span class=normal> 939</span>
<span class=normal> 940</span>
<span class=normal> 941</span>
<span class=normal> 942</span>
<span class=normal> 943</span>
<span class=normal> 944</span>
<span class=normal> 945</span>
<span class=normal> 946</span>
<span class=normal> 947</span>
<span class=normal> 948</span>
<span class=normal> 949</span>
<span class=normal> 950</span>
<span class=normal> 951</span>
<span class=normal> 952</span>
<span class=normal> 953</span>
<span class=normal> 954</span>
<span class=normal> 955</span>
<span class=normal> 956</span>
<span class=normal> 957</span>
<span class=normal> 958</span>
<span class=normal> 959</span>
<span class=normal> 960</span>
<span class=normal> 961</span>
<span class=normal> 962</span>
<span class=normal> 963</span>
<span class=normal> 964</span>
<span class=normal> 965</span>
<span class=normal> 966</span>
<span class=normal> 967</span>
<span class=normal> 968</span>
<span class=normal> 969</span>
<span class=normal> 970</span>
<span class=normal> 971</span>
<span class=normal> 972</span>
<span class=normal> 973</span>
<span class=normal> 974</span>
<span class=normal> 975</span>
<span class=normal> 976</span>
<span class=normal> 977</span>
<span class=normal> 978</span>
<span class=normal> 979</span>
<span class=normal> 980</span>
<span class=normal> 981</span>
<span class=normal> 982</span>
<span class=normal> 983</span>
<span class=normal> 984</span>
<span class=normal> 985</span>
<span class=normal> 986</span>
<span class=normal> 987</span>
<span class=normal> 988</span>
<span class=normal> 989</span>
<span class=normal> 990</span>
<span class=normal> 991</span>
<span class=normal> 992</span>
<span class=normal> 993</span>
<span class=normal> 994</span>
<span class=normal> 995</span>
<span class=normal> 996</span>
<span class=normal> 997</span>
<span class=normal> 998</span>
<span class=normal> 999</span>
<span class=normal>1000</span>
<span class=normal>1001</span>
<span class=normal>1002</span>
<span class=normal>1003</span>
<span class=normal>1004</span>
<span class=normal>1005</span>
<span class=normal>1006</span>
<span class=normal>1007</span>
<span class=normal>1008</span>
<span class=normal>1009</span>
<span class=normal>1010</span>
<span class=normal>1011</span>
<span class=normal>1012</span>
<span class=normal>1013</span>
<span class=normal>1014</span>
<span class=normal>1015</span>
<span class=normal>1016</span>
<span class=normal>1017</span>
<span class=normal>1018</span>
<span class=normal>1019</span>
<span class=normal>1020</span>
<span class=normal>1021</span>
<span class=normal>1022</span>
<span class=normal>1023</span>
<span class=normal>1024</span>
<span class=normal>1025</span>
<span class=normal>1026</span>
<span class=normal>1027</span>
<span class=normal>1028</span>
<span class=normal>1029</span>
<span class=normal>1030</span>
<span class=normal>1031</span>
<span class=normal>1032</span>
<span class=normal>1033</span>
<span class=normal>1034</span>
<span class=normal>1035</span>
<span class=normal>1036</span>
<span class=normal>1037</span>
<span class=normal>1038</span>
<span class=normal>1039</span>
<span class=normal>1040</span>
<span class=normal>1041</span>
<span class=normal>1042</span>
<span class=normal>1043</span>
<span class=normal>1044</span>
<span class=normal>1045</span>
<span class=normal>1046</span>
<span class=normal>1047</span>
<span class=normal>1048</span>
<span class=normal>1049</span>
<span class=normal>1050</span>
<span class=normal>1051</span>
<span class=normal>1052</span>
<span class=normal>1053</span>
<span class=normal>1054</span>
<span class=normal>1055</span>
<span class=normal>1056</span>
<span class=normal>1057</span>
<span class=normal>1058</span>
<span class=normal>1059</span>
<span class=normal>1060</span>
<span class=normal>1061</span>
<span class=normal>1062</span>
<span class=normal>1063</span>
<span class=normal>1064</span>
<span class=normal>1065</span>
<span class=normal>1066</span>
<span class=normal>1067</span>
<span class=normal>1068</span>
<span class=normal>1069</span>
<span class=normal>1070</span>
<span class=normal>1071</span>
<span class=normal>1072</span>
<span class=normal>1073</span>
<span class=normal>1074</span>
<span class=normal>1075</span>
<span class=normal>1076</span>
<span class=normal>1077</span>
<span class=normal>1078</span>
<span class=normal>1079</span>
<span class=normal>1080</span>
<span class=normal>1081</span>
<span class=normal>1082</span>
<span class=normal>1083</span>
<span class=normal>1084</span>
<span class=normal>1085</span>
<span class=normal>1086</span>
<span class=normal>1087</span>
<span class=normal>1088</span>
<span class=normal>1089</span>
<span class=normal>1090</span>
<span class=normal>1091</span>
<span class=normal>1092</span>
<span class=normal>1093</span>
<span class=normal>1094</span>
<span class=normal>1095</span>
<span class=normal>1096</span>
<span class=normal>1097</span>
<span class=normal>1098</span>
<span class=normal>1099</span>
<span class=normal>1100</span>
<span class=normal>1101</span>
<span class=normal>1102</span>
<span class=normal>1103</span>
<span class=normal>1104</span>
<span class=normal>1105</span>
<span class=normal>1106</span>
<span class=normal>1107</span>
<span class=normal>1108</span>
<span class=normal>1109</span>
<span class=normal>1110</span>
<span class=normal>1111</span>
<span class=normal>1112</span>
<span class=normal>1113</span>
<span class=normal>1114</span>
<span class=normal>1115</span>
<span class=normal>1116</span>
<span class=normal>1117</span>
<span class=normal>1118</span>
<span class=normal>1119</span>
<span class=normal>1120</span>
<span class=normal>1121</span>
<span class=normal>1122</span>
<span class=normal>1123</span>
<span class=normal>1124</span>
<span class=normal>1125</span>
<span class=normal>1126</span>
<span class=normal>1127</span>
<span class=normal>1128</span>
<span class=normal>1129</span>
<span class=normal>1130</span>
<span class=normal>1131</span>
<span class=normal>1132</span>
<span class=normal>1133</span>
<span class=normal>1134</span>
<span class=normal>1135</span>
<span class=normal>1136</span>
<span class=normal>1137</span>
<span class=normal>1138</span>
<span class=normal>1139</span>
<span class=normal>1140</span>
<span class=normal>1141</span>
<span class=normal>1142</span>
<span class=normal>1143</span>
<span class=normal>1144</span>
<span class=normal>1145</span>
<span class=normal>1146</span>
<span class=normal>1147</span>
<span class=normal>1148</span>
<span class=normal>1149</span>
<span class=normal>1150</span>
<span class=normal>1151</span>
<span class=normal>1152</span>
<span class=normal>1153</span>
<span class=normal>1154</span>
<span class=normal>1155</span>
<span class=normal>1156</span>
<span class=normal>1157</span>
<span class=normal>1158</span>
<span class=normal>1159</span>
<span class=normal>1160</span>
<span class=normal>1161</span>
<span class=normal>1162</span>
<span class=normal>1163</span>
<span class=normal>1164</span>
<span class=normal>1165</span>
<span class=normal>1166</span>
<span class=normal>1167</span>
<span class=normal>1168</span>
<span class=normal>1169</span>
<span class=normal>1170</span>
<span class=normal>1171</span>
<span class=normal>1172</span>
<span class=normal>1173</span>
<span class=normal>1174</span>
<span class=normal>1175</span>
<span class=normal>1176</span>
<span class=normal>1177</span>
<span class=normal>1178</span>
<span class=normal>1179</span>
<span class=normal>1180</span>
<span class=normal>1181</span>
<span class=normal>1182</span>
<span class=normal>1183</span>
<span class=normal>1184</span>
<span class=normal>1185</span>
<span class=normal>1186</span>
<span class=normal>1187</span>
<span class=normal>1188</span>
<span class=normal>1189</span>
<span class=normal>1190</span>
<span class=normal>1191</span>
<span class=normal>1192</span>
<span class=normal>1193</span>
<span class=normal>1194</span>
<span class=normal>1195</span>
<span class=normal>1196</span>
<span class=normal>1197</span>
<span class=normal>1198</span>
<span class=normal>1199</span>
<span class=normal>1200</span>
<span class=normal>1201</span>
<span class=normal>1202</span>
<span class=normal>1203</span>
<span class=normal>1204</span>
<span class=normal>1205</span>
<span class=normal>1206</span>
<span class=normal>1207</span>
<span class=normal>1208</span>
<span class=normal>1209</span>
<span class=normal>1210</span>
<span class=normal>1211</span>
<span class=normal>1212</span>
<span class=normal>1213</span>
<span class=normal>1214</span>
<span class=normal>1215</span>
<span class=normal>1216</span>
<span class=normal>1217</span>
<span class=normal>1218</span>
<span class=normal>1219</span>
<span class=normal>1220</span>
<span class=normal>1221</span>
<span class=normal>1222</span>
<span class=normal>1223</span>
<span class=normal>1224</span>
<span class=normal>1225</span>
<span class=normal>1226</span>
<span class=normal>1227</span>
<span class=normal>1228</span>
<span class=normal>1229</span>
<span class=normal>1230</span>
<span class=normal>1231</span>
<span class=normal>1232</span>
<span class=normal>1233</span>
<span class=normal>1234</span>
<span class=normal>1235</span>
<span class=normal>1236</span>
<span class=normal>1237</span>
<span class=normal>1238</span>
<span class=normal>1239</span>
<span class=normal>1240</span>
<span class=normal>1241</span>
<span class=normal>1242</span>
<span class=normal>1243</span>
<span class=normal>1244</span>
<span class=normal>1245</span>
<span class=normal>1246</span>
<span class=normal>1247</span>
<span class=normal>1248</span>
<span class=normal>1249</span>
<span class=normal>1250</span>
<span class=normal>1251</span>
<span class=normal>1252</span>
<span class=normal>1253</span>
<span class=normal>1254</span>
<span class=normal>1255</span>
<span class=normal>1256</span>
<span class=normal>1257</span>
<span class=normal>1258</span>
<span class=normal>1259</span>
<span class=normal>1260</span>
<span class=normal>1261</span>
<span class=normal>1262</span>
<span class=normal>1263</span>
<span class=normal>1264</span>
<span class=normal>1265</span>
<span class=normal>1266</span>
<span class=normal>1267</span>
<span class=normal>1268</span>
<span class=normal>1269</span>
<span class=normal>1270</span>
<span class=normal>1271</span>
<span class=normal>1272</span>
<span class=normal>1273</span>
<span class=normal>1274</span>
<span class=normal>1275</span>
<span class=normal>1276</span>
<span class=normal>1277</span>
<span class=normal>1278</span>
<span class=normal>1279</span>
<span class=normal>1280</span>
<span class=normal>1281</span>
<span class=normal>1282</span>
<span class=normal>1283</span>
<span class=normal>1284</span>
<span class=normal>1285</span>
<span class=normal>1286</span>
<span class=normal>1287</span>
<span class=normal>1288</span>
<span class=normal>1289</span>
<span class=normal>1290</span>
<span class=normal>1291</span>
<span class=normal>1292</span>
<span class=normal>1293</span>
<span class=normal>1294</span>
<span class=normal>1295</span>
<span class=normal>1296</span>
<span class=normal>1297</span>
<span class=normal>1298</span>
<span class=normal>1299</span>
<span class=normal>1300</span>
<span class=normal>1301</span>
<span class=normal>1302</span>
<span class=normal>1303</span>
<span class=normal>1304</span>
<span class=normal>1305</span>
<span class=normal>1306</span>
<span class=normal>1307</span>
<span class=normal>1308</span>
<span class=normal>1309</span>
<span class=normal>1310</span>
<span class=normal>1311</span>
<span class=normal>1312</span>
<span class=normal>1313</span>
<span class=normal>1314</span>
<span class=normal>1315</span>
<span class=normal>1316</span>
<span class=normal>1317</span>
<span class=normal>1318</span>
<span class=normal>1319</span>
<span class=normal>1320</span>
<span class=normal>1321</span>
<span class=normal>1322</span>
<span class=normal>1323</span>
<span class=normal>1324</span>
<span class=normal>1325</span>
<span class=normal>1326</span>
<span class=normal>1327</span>
<span class=normal>1328</span>
<span class=normal>1329</span>
<span class=normal>1330</span>
<span class=normal>1331</span>
<span class=normal>1332</span>
<span class=normal>1333</span>
<span class=normal>1334</span>
<span class=normal>1335</span>
<span class=normal>1336</span>
<span class=normal>1337</span>
<span class=normal>1338</span>
<span class=normal>1339</span>
<span class=normal>1340</span>
<span class=normal>1341</span>
<span class=normal>1342</span>
<span class=normal>1343</span>
<span class=normal>1344</span>
<span class=normal>1345</span>
<span class=normal>1346</span>
<span class=normal>1347</span>
<span class=normal>1348</span>
<span class=normal>1349</span>
<span class=normal>1350</span>
<span class=normal>1351</span>
<span class=normal>1352</span>
<span class=normal>1353</span>
<span class=normal>1354</span>
<span class=normal>1355</span>
<span class=normal>1356</span>
<span class=normal>1357</span>
<span class=normal>1358</span>
<span class=normal>1359</span>
<span class=normal>1360</span>
<span class=normal>1361</span>
<span class=normal>1362</span>
<span class=normal>1363</span>
<span class=normal>1364</span>
<span class=normal>1365</span>
<span class=normal>1366</span>
<span class=normal>1367</span>
<span class=normal>1368</span>
<span class=normal>1369</span>
<span class=normal>1370</span>
<span class=normal>1371</span>
<span class=normal>1372</span>
<span class=normal>1373</span>
<span class=normal>1374</span>
<span class=normal>1375</span>
<span class=normal>1376</span>
<span class=normal>1377</span>
<span class=normal>1378</span>
<span class=normal>1379</span>
<span class=normal>1380</span>
<span class=normal>1381</span>
<span class=normal>1382</span>
<span class=normal>1383</span>
<span class=normal>1384</span>
<span class=normal>1385</span>
<span class=normal>1386</span>
<span class=normal>1387</span>
<span class=normal>1388</span>
<span class=normal>1389</span>
<span class=normal>1390</span>
<span class=normal>1391</span>
<span class=normal>1392</span>
<span class=normal>1393</span>
<span class=normal>1394</span>
<span class=normal>1395</span>
<span class=normal>1396</span>
<span class=normal>1397</span>
<span class=normal>1398</span>
<span class=normal>1399</span>
<span class=normal>1400</span>
<span class=normal>1401</span>
<span class=normal>1402</span>
<span class=normal>1403</span>
<span class=normal>1404</span>
<span class=normal>1405</span>
<span class=normal>1406</span>
<span class=normal>1407</span>
<span class=normal>1408</span>
<span class=normal>1409</span>
<span class=normal>1410</span>
<span class=normal>1411</span>
<span class=normal>1412</span>
<span class=normal>1413</span>
<span class=normal>1414</span>
<span class=normal>1415</span>
<span class=normal>1416</span>
<span class=normal>1417</span>
<span class=normal>1418</span>
<span class=normal>1419</span>
<span class=normal>1420</span>
<span class=normal>1421</span>
<span class=normal>1422</span>
<span class=normal>1423</span>
<span class=normal>1424</span>
<span class=normal>1425</span>
<span class=normal>1426</span>
<span class=normal>1427</span>
<span class=normal>1428</span>
<span class=normal>1429</span>
<span class=normal>1430</span>
<span class=normal>1431</span>
<span class=normal>1432</span>
<span class=normal>1433</span>
<span class=normal>1434</span>
<span class=normal>1435</span>
<span class=normal>1436</span>
<span class=normal>1437</span>
<span class=normal>1438</span>
<span class=normal>1439</span>
<span class=normal>1440</span>
<span class=normal>1441</span>
<span class=normal>1442</span>
<span class=normal>1443</span>
<span class=normal>1444</span>
<span class=normal>1445</span>
<span class=normal>1446</span>
<span class=normal>1447</span>
<span class=normal>1448</span>
<span class=normal>1449</span>
<span class=normal>1450</span>
<span class=normal>1451</span>
<span class=normal>1452</span>
<span class=normal>1453</span>
<span class=normal>1454</span>
<span class=normal>1455</span>
<span class=normal>1456</span>
<span class=normal>1457</span>
<span class=normal>1458</span>
<span class=normal>1459</span>
<span class=normal>1460</span>
<span class=normal>1461</span>
<span class=normal>1462</span>
<span class=normal>1463</span>
<span class=normal>1464</span>
<span class=normal>1465</span>
<span class=normal>1466</span>
<span class=normal>1467</span>
<span class=normal>1468</span>
<span class=normal>1469</span>
<span class=normal>1470</span>
<span class=normal>1471</span>
<span class=normal>1472</span>
<span class=normal>1473</span>
<span class=normal>1474</span>
<span class=normal>1475</span>
<span class=normal>1476</span>
<span class=normal>1477</span>
<span class=normal>1478</span>
<span class=normal>1479</span>
<span class=normal>1480</span>
<span class=normal>1481</span>
<span class=normal>1482</span>
<span class=normal>1483</span>
<span class=normal>1484</span>
<span class=normal>1485</span>
<span class=normal>1486</span>
<span class=normal>1487</span>
<span class=normal>1488</span>
<span class=normal>1489</span>
<span class=normal>1490</span>
<span class=normal>1491</span>
<span class=normal>1492</span>
<span class=normal>1493</span>
<span class=normal>1494</span>
<span class=normal>1495</span>
<span class=normal>1496</span>
<span class=normal>1497</span>
<span class=normal>1498</span>
<span class=normal>1499</span>
<span class=normal>1500</span>
<span class=normal>1501</span>
<span class=normal>1502</span>
<span class=normal>1503</span>
<span class=normal>1504</span>
<span class=normal>1505</span>
<span class=normal>1506</span>
<span class=normal>1507</span>
<span class=normal>1508</span>
<span class=normal>1509</span>
<span class=normal>1510</span>
<span class=normal>1511</span>
<span class=normal>1512</span>
<span class=normal>1513</span>
<span class=normal>1514</span>
<span class=normal>1515</span>
<span class=normal>1516</span>
<span class=normal>1517</span>
<span class=normal>1518</span>
<span class=normal>1519</span>
<span class=normal>1520</span>
<span class=normal>1521</span>
<span class=normal>1522</span>
<span class=normal>1523</span>
<span class=normal>1524</span>
<span class=normal>1525</span>
<span class=normal>1526</span>
<span class=normal>1527</span>
<span class=normal>1528</span>
<span class=normal>1529</span>
<span class=normal>1530</span>
<span class=normal>1531</span>
<span class=normal>1532</span>
<span class=normal>1533</span>
<span class=normal>1534</span>
<span class=normal>1535</span>
<span class=normal>1536</span>
<span class=normal>1537</span>
<span class=normal>1538</span>
<span class=normal>1539</span>
<span class=normal>1540</span>
<span class=normal>1541</span>
<span class=normal>1542</span>
<span class=normal>1543</span>
<span class=normal>1544</span>
<span class=normal>1545</span>
<span class=normal>1546</span>
<span class=normal>1547</span>
<span class=normal>1548</span>
<span class=normal>1549</span>
<span class=normal>1550</span>
<span class=normal>1551</span>
<span class=normal>1552</span>
<span class=normal>1553</span>
<span class=normal>1554</span>
<span class=normal>1555</span>
<span class=normal>1556</span>
<span class=normal>1557</span>
<span class=normal>1558</span>
<span class=normal>1559</span>
<span class=normal>1560</span>
<span class=normal>1561</span>
<span class=normal>1562</span>
<span class=normal>1563</span>
<span class=normal>1564</span>
<span class=normal>1565</span>
<span class=normal>1566</span>
<span class=normal>1567</span>
<span class=normal>1568</span>
<span class=normal>1569</span>
<span class=normal>1570</span>
<span class=normal>1571</span>
<span class=normal>1572</span>
<span class=normal>1573</span>
<span class=normal>1574</span>
<span class=normal>1575</span>
<span class=normal>1576</span>
<span class=normal>1577</span>
<span class=normal>1578</span>
<span class=normal>1579</span>
<span class=normal>1580</span>
<span class=normal>1581</span>
<span class=normal>1582</span>
<span class=normal>1583</span>
<span class=normal>1584</span>
<span class=normal>1585</span>
<span class=normal>1586</span>
<span class=normal>1587</span>
<span class=normal>1588</span>
<span class=normal>1589</span>
<span class=normal>1590</span>
<span class=normal>1591</span>
<span class=normal>1592</span>
<span class=normal>1593</span>
<span class=normal>1594</span>
<span class=normal>1595</span>
<span class=normal>1596</span>
<span class=normal>1597</span>
<span class=normal>1598</span>
<span class=normal>1599</span>
<span class=normal>1600</span>
<span class=normal>1601</span>
<span class=normal>1602</span>
<span class=normal>1603</span>
<span class=normal>1604</span>
<span class=normal>1605</span>
<span class=normal>1606</span>
<span class=normal>1607</span>
<span class=normal>1608</span>
<span class=normal>1609</span>
<span class=normal>1610</span>
<span class=normal>1611</span>
<span class=normal>1612</span>
<span class=normal>1613</span>
<span class=normal>1614</span>
<span class=normal>1615</span>
<span class=normal>1616</span>
<span class=normal>1617</span>
<span class=normal>1618</span>
<span class=normal>1619</span>
<span class=normal>1620</span>
<span class=normal>1621</span>
<span class=normal>1622</span>
<span class=normal>1623</span>
<span class=normal>1624</span>
<span class=normal>1625</span>
<span class=normal>1626</span>
<span class=normal>1627</span>
<span class=normal>1628</span>
<span class=normal>1629</span>
<span class=normal>1630</span>
<span class=normal>1631</span>
<span class=normal>1632</span>
<span class=normal>1633</span>
<span class=normal>1634</span>
<span class=normal>1635</span>
<span class=normal>1636</span>
<span class=normal>1637</span>
<span class=normal>1638</span>
<span class=normal>1639</span>
<span class=normal>1640</span>
<span class=normal>1641</span>
<span class=normal>1642</span>
<span class=normal>1643</span>
<span class=normal>1644</span>
<span class=normal>1645</span>
<span class=normal>1646</span>
<span class=normal>1647</span>
<span class=normal>1648</span>
<span class=normal>1649</span>
<span class=normal>1650</span>
<span class=normal>1651</span>
<span class=normal>1652</span>
<span class=normal>1653</span>
<span class=normal>1654</span>
<span class=normal>1655</span>
<span class=normal>1656</span>
<span class=normal>1657</span>
<span class=normal>1658</span>
<span class=normal>1659</span>
<span class=normal>1660</span>
<span class=normal>1661</span>
<span class=normal>1662</span>
<span class=normal>1663</span>
<span class=normal>1664</span>
<span class=normal>1665</span>
<span class=normal>1666</span>
<span class=normal>1667</span>
<span class=normal>1668</span>
<span class=normal>1669</span>
<span class=normal>1670</span>
<span class=normal>1671</span>
<span class=normal>1672</span>
<span class=normal>1673</span>
<span class=normal>1674</span>
<span class=normal>1675</span>
<span class=normal>1676</span>
<span class=normal>1677</span>
<span class=normal>1678</span>
<span class=normal>1679</span>
<span class=normal>1680</span>
<span class=normal>1681</span>
<span class=normal>1682</span>
<span class=normal>1683</span>
<span class=normal>1684</span>
<span class=normal>1685</span>
<span class=normal>1686</span>
<span class=normal>1687</span>
<span class=normal>1688</span>
<span class=normal>1689</span>
<span class=normal>1690</span>
<span class=normal>1691</span>
<span class=normal>1692</span>
<span class=normal>1693</span>
<span class=normal>1694</span>
<span class=normal>1695</span>
<span class=normal>1696</span>
<span class=normal>1697</span>
<span class=normal>1698</span>
<span class=normal>1699</span>
<span class=normal>1700</span>
<span class=normal>1701</span>
<span class=normal>1702</span>
<span class=normal>1703</span>
<span class=normal>1704</span>
<span class=normal>1705</span>
<span class=normal>1706</span>
<span class=normal>1707</span>
<span class=normal>1708</span>
<span class=normal>1709</span>
<span class=normal>1710</span>
<span class=normal>1711</span>
<span class=normal>1712</span>
<span class=normal>1713</span>
<span class=normal>1714</span>
<span class=normal>1715</span>
<span class=normal>1716</span>
<span class=normal>1717</span>
<span class=normal>1718</span>
<span class=normal>1719</span>
<span class=normal>1720</span>
<span class=normal>1721</span>
<span class=normal>1722</span>
<span class=normal>1723</span>
<span class=normal>1724</span>
<span class=normal>1725</span>
<span class=normal>1726</span>
<span class=normal>1727</span>
<span class=normal>1728</span>
<span class=normal>1729</span>
<span class=normal>1730</span>
<span class=normal>1731</span>
<span class=normal>1732</span>
<span class=normal>1733</span>
<span class=normal>1734</span>
<span class=normal>1735</span>
<span class=normal>1736</span>
<span class=normal>1737</span>
<span class=normal>1738</span>
<span class=normal>1739</span>
<span class=normal>1740</span>
<span class=normal>1741</span>
<span class=normal>1742</span>
<span class=normal>1743</span>
<span class=normal>1744</span>
<span class=normal>1745</span>
<span class=normal>1746</span>
<span class=normal>1747</span>
<span class=normal>1748</span>
<span class=normal>1749</span>
<span class=normal>1750</span>
<span class=normal>1751</span>
<span class=normal>1752</span>
<span class=normal>1753</span>
<span class=normal>1754</span>
<span class=normal>1755</span>
<span class=normal>1756</span>
<span class=normal>1757</span>
<span class=normal>1758</span>
<span class=normal>1759</span>
<span class=normal>1760</span>
<span class=normal>1761</span>
<span class=normal>1762</span>
<span class=normal>1763</span>
<span class=normal>1764</span>
<span class=normal>1765</span>
<span class=normal>1766</span>
<span class=normal>1767</span>
<span class=normal>1768</span>
<span class=normal>1769</span>
<span class=normal>1770</span>
<span class=normal>1771</span>
<span class=normal>1772</span>
<span class=normal>1773</span>
<span class=normal>1774</span>
<span class=normal>1775</span>
<span class=normal>1776</span>
<span class=normal>1777</span>
<span class=normal>1778</span>
<span class=normal>1779</span>
<span class=normal>1780</span>
<span class=normal>1781</span>
<span class=normal>1782</span>
<span class=normal>1783</span>
<span class=normal>1784</span>
<span class=normal>1785</span>
<span class=normal>1786</span>
<span class=normal>1787</span>
<span class=normal>1788</span>
<span class=normal>1789</span>
<span class=normal>1790</span>
<span class=normal>1791</span>
<span class=normal>1792</span>
<span class=normal>1793</span>
<span class=normal>1794</span>
<span class=normal>1795</span>
<span class=normal>1796</span>
<span class=normal>1797</span>
<span class=normal>1798</span>
<span class=normal>1799</span>
<span class=normal>1800</span>
<span class=normal>1801</span>
<span class=normal>1802</span>
<span class=normal>1803</span>
<span class=normal>1804</span>
<span class=normal>1805</span>
<span class=normal>1806</span>
<span class=normal>1807</span>
<span class=normal>1808</span>
<span class=normal>1809</span>
<span class=normal>1810</span>
<span class=normal>1811</span>
<span class=normal>1812</span>
<span class=normal>1813</span>
<span class=normal>1814</span>
<span class=normal>1815</span>
<span class=normal>1816</span>
<span class=normal>1817</span>
<span class=normal>1818</span>
<span class=normal>1819</span>
<span class=normal>1820</span>
<span class=normal>1821</span>
<span class=normal>1822</span>
<span class=normal>1823</span>
<span class=normal>1824</span>
<span class=normal>1825</span>
<span class=normal>1826</span>
<span class=normal>1827</span>
<span class=normal>1828</span>
<span class=normal>1829</span>
<span class=normal>1830</span>
<span class=normal>1831</span>
<span class=normal>1832</span>
<span class=normal>1833</span>
<span class=normal>1834</span>
<span class=normal>1835</span>
<span class=normal>1836</span>
<span class=normal>1837</span>
<span class=normal>1838</span>
<span class=normal>1839</span>
<span class=normal>1840</span>
<span class=normal>1841</span>
<span class=normal>1842</span>
<span class=normal>1843</span>
<span class=normal>1844</span>
<span class=normal>1845</span>
<span class=normal>1846</span>
<span class=normal>1847</span>
<span class=normal>1848</span>
<span class=normal>1849</span>
<span class=normal>1850</span>
<span class=normal>1851</span>
<span class=normal>1852</span>
<span class=normal>1853</span>
<span class=normal>1854</span>
<span class=normal>1855</span>
<span class=normal>1856</span>
<span class=normal>1857</span>
<span class=normal>1858</span>
<span class=normal>1859</span>
<span class=normal>1860</span>
<span class=normal>1861</span>
<span class=normal>1862</span>
<span class=normal>1863</span>
<span class=normal>1864</span>
<span class=normal>1865</span>
<span class=normal>1866</span>
<span class=normal>1867</span>
<span class=normal>1868</span>
<span class=normal>1869</span>
<span class=normal>1870</span>
<span class=normal>1871</span>
<span class=normal>1872</span>
<span class=normal>1873</span>
<span class=normal>1874</span>
<span class=normal>1875</span>
<span class=normal>1876</span>
<span class=normal>1877</span>
<span class=normal>1878</span>
<span class=normal>1879</span>
<span class=normal>1880</span>
<span class=normal>1881</span>
<span class=normal>1882</span>
<span class=normal>1883</span>
<span class=normal>1884</span>
<span class=normal>1885</span>
<span class=normal>1886</span>
<span class=normal>1887</span>
<span class=normal>1888</span>
<span class=normal>1889</span>
<span class=normal>1890</span>
<span class=normal>1891</span>
<span class=normal>1892</span>
<span class=normal>1893</span>
<span class=normal>1894</span>
<span class=normal>1895</span>
<span class=normal>1896</span>
<span class=normal>1897</span>
<span class=normal>1898</span>
<span class=normal>1899</span>
<span class=normal>1900</span>
<span class=normal>1901</span>
<span class=normal>1902</span>
<span class=normal>1903</span>
<span class=normal>1904</span>
<span class=normal>1905</span>
<span class=normal>1906</span>
<span class=normal>1907</span>
<span class=normal>1908</span>
<span class=normal>1909</span>
<span class=normal>1910</span>
<span class=normal>1911</span>
<span class=normal>1912</span>
<span class=normal>1913</span>
<span class=normal>1914</span>
<span class=normal>1915</span>
<span class=normal>1916</span>
<span class=normal>1917</span>
<span class=normal>1918</span>
<span class=normal>1919</span>
<span class=normal>1920</span>
<span class=normal>1921</span>
<span class=normal>1922</span>
<span class=normal>1923</span>
<span class=normal>1924</span>
<span class=normal>1925</span>
<span class=normal>1926</span>
<span class=normal>1927</span>
<span class=normal>1928</span>
<span class=normal>1929</span>
<span class=normal>1930</span>
<span class=normal>1931</span>
<span class=normal>1932</span>
<span class=normal>1933</span>
<span class=normal>1934</span>
<span class=normal>1935</span>
<span class=normal>1936</span>
<span class=normal>1937</span>
<span class=normal>1938</span>
<span class=normal>1939</span>
<span class=normal>1940</span>
<span class=normal>1941</span>
<span class=normal>1942</span>
<span class=normal>1943</span>
<span class=normal>1944</span>
<span class=normal>1945</span>
<span class=normal>1946</span>
<span class=normal>1947</span>
<span class=normal>1948</span>
<span class=normal>1949</span>
<span class=normal>1950</span>
<span class=normal>1951</span>
<span class=normal>1952</span>
<span class=normal>1953</span>
<span class=normal>1954</span>
<span class=normal>1955</span>
<span class=normal>1956</span>
<span class=normal>1957</span>
<span class=normal>1958</span>
<span class=normal>1959</span>
<span class=normal>1960</span>
<span class=normal>1961</span>
<span class=normal>1962</span>
<span class=normal>1963</span>
<span class=normal>1964</span>
<span class=normal>1965</span>
<span class=normal>1966</span>
<span class=normal>1967</span>
<span class=normal>1968</span>
<span class=normal>1969</span>
<span class=normal>1970</span>
<span class=normal>1971</span>
<span class=normal>1972</span>
<span class=normal>1973</span>
<span class=normal>1974</span>
<span class=normal>1975</span>
<span class=normal>1976</span>
<span class=normal>1977</span>
<span class=normal>1978</span>
<span class=normal>1979</span>
<span class=normal>1980</span>
<span class=normal>1981</span>
<span class=normal>1982</span>
<span class=normal>1983</span>
<span class=normal>1984</span>
<span class=normal>1985</span>
<span class=normal>1986</span>
<span class=normal>1987</span>
<span class=normal>1988</span>
<span class=normal>1989</span>
<span class=normal>1990</span>
<span class=normal>1991</span>
<span class=normal>1992</span>
<span class=normal>1993</span>
<span class=normal>1994</span>
<span class=normal>1995</span>
<span class=normal>1996</span>
<span class=normal>1997</span>
<span class=normal>1998</span>
<span class=normal>1999</span>
<span class=normal>2000</span>
<span class=normal>2001</span>
<span class=normal>2002</span>
<span class=normal>2003</span>
<span class=normal>2004</span>
<span class=normal>2005</span>
<span class=normal>2006</span>
<span class=normal>2007</span>
<span class=normal>2008</span>
<span class=normal>2009</span>
<span class=normal>2010</span>
<span class=normal>2011</span>
<span class=normal>2012</span>
<span class=normal>2013</span>
<span class=normal>2014</span>
<span class=normal>2015</span>
<span class=normal>2016</span>
<span class=normal>2017</span>
<span class=normal>2018</span>
<span class=normal>2019</span>
<span class=normal>2020</span>
<span class=normal>2021</span>
<span class=normal>2022</span>
<span class=normal>2023</span>
<span class=normal>2024</span>
<span class=normal>2025</span>
<span class=normal>2026</span>
<span class=normal>2027</span>
<span class=normal>2028</span>
<span class=normal>2029</span>
<span class=normal>2030</span>
<span class=normal>2031</span>
<span class=normal>2032</span>
<span class=normal>2033</span>
<span class=normal>2034</span>
<span class=normal>2035</span>
<span class=normal>2036</span>
<span class=normal>2037</span>
<span class=normal>2038</span>
<span class=normal>2039</span>
<span class=normal>2040</span>
<span class=normal>2041</span>
<span class=normal>2042</span>
<span class=normal>2043</span>
<span class=normal>2044</span>
<span class=normal>2045</span>
<span class=normal>2046</span>
<span class=normal>2047</span>
<span class=normal>2048</span>
<span class=normal>2049</span>
<span class=normal>2050</span>
<span class=normal>2051</span>
<span class=normal>2052</span>
<span class=normal>2053</span>
<span class=normal>2054</span>
<span class=normal>2055</span>
<span class=normal>2056</span>
<span class=normal>2057</span>
<span class=normal>2058</span>
<span class=normal>2059</span>
<span class=normal>2060</span>
<span class=normal>2061</span>
<span class=normal>2062</span>
<span class=normal>2063</span>
<span class=normal>2064</span>
<span class=normal>2065</span>
<span class=normal>2066</span>
<span class=normal>2067</span>
<span class=normal>2068</span>
<span class=normal>2069</span>
<span class=normal>2070</span>
<span class=normal>2071</span>
<span class=normal>2072</span>
<span class=normal>2073</span>
<span class=normal>2074</span>
<span class=normal>2075</span>
<span class=normal>2076</span>
<span class=normal>2077</span>
<span class=normal>2078</span>
<span class=normal>2079</span>
<span class=normal>2080</span>
<span class=normal>2081</span>
<span class=normal>2082</span>
<span class=normal>2083</span>
<span class=normal>2084</span>
<span class=normal>2085</span>
<span class=normal>2086</span>
<span class=normal>2087</span>
<span class=normal>2088</span>
<span class=normal>2089</span>
<span class=normal>2090</span>
<span class=normal>2091</span>
<span class=normal>2092</span>
<span class=normal>2093</span>
<span class=normal>2094</span>
<span class=normal>2095</span>
<span class=normal>2096</span>
<span class=normal>2097</span>
<span class=normal>2098</span>
<span class=normal>2099</span>
<span class=normal>2100</span>
<span class=normal>2101</span>
<span class=normal>2102</span>
<span class=normal>2103</span>
<span class=normal>2104</span>
<span class=normal>2105</span>
<span class=normal>2106</span>
<span class=normal>2107</span>
<span class=normal>2108</span>
<span class=normal>2109</span>
<span class=normal>2110</span>
<span class=normal>2111</span>
<span class=normal>2112</span>
<span class=normal>2113</span>
<span class=normal>2114</span>
<span class=normal>2115</span>
<span class=normal>2116</span>
<span class=normal>2117</span>
<span class=normal>2118</span>
<span class=normal>2119</span>
<span class=normal>2120</span>
<span class=normal>2121</span>
<span class=normal>2122</span>
<span class=normal>2123</span>
<span class=normal>2124</span>
<span class=normal>2125</span>
<span class=normal>2126</span>
<span class=normal>2127</span>
<span class=normal>2128</span>
<span class=normal>2129</span>
<span class=normal>2130</span>
<span class=normal>2131</span>
<span class=normal>2132</span>
<span class=normal>2133</span>
<span class=normal>2134</span>
<span class=normal>2135</span>
<span class=normal>2136</span>
<span class=normal>2137</span>
<span class=normal>2138</span>
<span class=normal>2139</span>
<span class=normal>2140</span>
<span class=normal>2141</span>
<span class=normal>2142</span>
<span class=normal>2143</span>
<span class=normal>2144</span>
<span class=normal>2145</span>
<span class=normal>2146</span>
<span class=normal>2147</span>
<span class=normal>2148</span>
<span class=normal>2149</span>
<span class=normal>2150</span>
<span class=normal>2151</span>
<span class=normal>2152</span>
<span class=normal>2153</span>
<span class=normal>2154</span>
<span class=normal>2155</span>
<span class=normal>2156</span>
<span class=normal>2157</span>
<span class=normal>2158</span>
<span class=normal>2159</span>
<span class=normal>2160</span>
<span class=normal>2161</span>
<span class=normal>2162</span>
<span class=normal>2163</span>
<span class=normal>2164</span>
<span class=normal>2165</span>
<span class=normal>2166</span>
<span class=normal>2167</span>
<span class=normal>2168</span>
<span class=normal>2169</span>
<span class=normal>2170</span>
<span class=normal>2171</span>
<span class=normal>2172</span>
<span class=normal>2173</span>
<span class=normal>2174</span>
<span class=normal>2175</span>
<span class=normal>2176</span>
<span class=normal>2177</span>
<span class=normal>2178</span>
<span class=normal>2179</span>
<span class=normal>2180</span>
<span class=normal>2181</span>
<span class=normal>2182</span>
<span class=normal>2183</span>
<span class=normal>2184</span>
<span class=normal>2185</span>
<span class=normal>2186</span>
<span class=normal>2187</span>
<span class=normal>2188</span>
<span class=normal>2189</span>
<span class=normal>2190</span>
<span class=normal>2191</span>
<span class=normal>2192</span>
<span class=normal>2193</span>
<span class=normal>2194</span>
<span class=normal>2195</span>
<span class=normal>2196</span>
<span class=normal>2197</span>
<span class=normal>2198</span>
<span class=normal>2199</span>
<span class=normal>2200</span>
<span class=normal>2201</span>
<span class=normal>2202</span>
<span class=normal>2203</span>
<span class=normal>2204</span>
<span class=normal>2205</span>
<span class=normal>2206</span>
<span class=normal>2207</span>
<span class=normal>2208</span>
<span class=normal>2209</span>
<span class=normal>2210</span>
<span class=normal>2211</span>
<span class=normal>2212</span>
<span class=normal>2213</span>
<span class=normal>2214</span>
<span class=normal>2215</span>
<span class=normal>2216</span>
<span class=normal>2217</span>
<span class=normal>2218</span>
<span class=normal>2219</span>
<span class=normal>2220</span>
<span class=normal>2221</span>
<span class=normal>2222</span>
<span class=normal>2223</span>
<span class=normal>2224</span>
<span class=normal>2225</span>
<span class=normal>2226</span>
<span class=normal>2227</span>
<span class=normal>2228</span>
<span class=normal>2229</span>
<span class=normal>2230</span>
<span class=normal>2231</span>
<span class=normal>2232</span>
<span class=normal>2233</span>
<span class=normal>2234</span>
<span class=normal>2235</span>
<span class=normal>2236</span>
<span class=normal>2237</span>
<span class=normal>2238</span>
<span class=normal>2239</span>
<span class=normal>2240</span>
<span class=normal>2241</span>
<span class=normal>2242</span>
<span class=normal>2243</span>
<span class=normal>2244</span>
<span class=normal>2245</span>
<span class=normal>2246</span>
<span class=normal>2247</span>
<span class=normal>2248</span>
<span class=normal>2249</span>
<span class=normal>2250</span>
<span class=normal>2251</span>
<span class=normal>2252</span>
<span class=normal>2253</span>
<span class=normal>2254</span>
<span class=normal>2255</span>
<span class=normal>2256</span>
<span class=normal>2257</span>
<span class=normal>2258</span>
<span class=normal>2259</span>
<span class=normal>2260</span>
<span class=normal>2261</span>
<span class=normal>2262</span>
<span class=normal>2263</span>
<span class=normal>2264</span>
<span class=normal>2265</span>
<span class=normal>2266</span>
<span class=normal>2267</span>
<span class=normal>2268</span>
<span class=normal>2269</span>
<span class=normal>2270</span>
<span class=normal>2271</span>
<span class=normal>2272</span>
<span class=normal>2273</span>
<span class=normal>2274</span>
<span class=normal>2275</span>
<span class=normal>2276</span>
<span class=normal>2277</span>
<span class=normal>2278</span>
<span class=normal>2279</span>
<span class=normal>2280</span>
<span class=normal>2281</span>
<span class=normal>2282</span>
<span class=normal>2283</span>
<span class=normal>2284</span>
<span class=normal>2285</span>
<span class=normal>2286</span>
<span class=normal>2287</span>
<span class=normal>2288</span>
<span class=normal>2289</span>
<span class=normal>2290</span>
<span class=normal>2291</span>
<span class=normal>2292</span>
<span class=normal>2293</span>
<span class=normal>2294</span>
<span class=normal>2295</span>
<span class=normal>2296</span>
<span class=normal>2297</span>
<span class=normal>2298</span>
<span class=normal>2299</span>
<span class=normal>2300</span>
<span class=normal>2301</span>
<span class=normal>2302</span>
<span class=normal>2303</span>
<span class=normal>2304</span>
<span class=normal>2305</span>
<span class=normal>2306</span>
<span class=normal>2307</span>
<span class=normal>2308</span>
<span class=normal>2309</span>
<span class=normal>2310</span>
<span class=normal>2311</span>
<span class=normal>2312</span>
<span class=normal>2313</span>
<span class=normal>2314</span>
<span class=normal>2315</span>
<span class=normal>2316</span>
<span class=normal>2317</span>
<span class=normal>2318</span>
<span class=normal>2319</span>
<span class=normal>2320</span>
<span class=normal>2321</span>
<span class=normal>2322</span>
<span class=normal>2323</span>
<span class=normal>2324</span>
<span class=normal>2325</span>
<span class=normal>2326</span>
<span class=normal>2327</span>
<span class=normal>2328</span>
<span class=normal>2329</span>
<span class=normal>2330</span>
<span class=normal>2331</span>
<span class=normal>2332</span>
<span class=normal>2333</span>
<span class=normal>2334</span>
<span class=normal>2335</span>
<span class=normal>2336</span>
<span class=normal>2337</span>
<span class=normal>2338</span>
<span class=normal>2339</span>
<span class=normal>2340</span>
<span class=normal>2341</span>
<span class=normal>2342</span>
<span class=normal>2343</span>
<span class=normal>2344</span>
<span class=normal>2345</span>
<span class=normal>2346</span>
<span class=normal>2347</span>
<span class=normal>2348</span>
<span class=normal>2349</span>
<span class=normal>2350</span>
<span class=normal>2351</span>
<span class=normal>2352</span>
<span class=normal>2353</span>
<span class=normal>2354</span>
<span class=normal>2355</span>
<span class=normal>2356</span>
<span class=normal>2357</span>
<span class=normal>2358</span>
<span class=normal>2359</span>
<span class=normal>2360</span>
<span class=normal>2361</span>
<span class=normal>2362</span>
<span class=normal>2363</span>
<span class=normal>2364</span>
<span class=normal>2365</span>
<span class=normal>2366</span>
<span class=normal>2367</span>
<span class=normal>2368</span>
<span class=normal>2369</span>
<span class=normal>2370</span>
<span class=normal>2371</span>
<span class=normal>2372</span>
<span class=normal>2373</span>
<span class=normal>2374</span>
<span class=normal>2375</span>
<span class=normal>2376</span>
<span class=normal>2377</span>
<span class=normal>2378</span>
<span class=normal>2379</span>
<span class=normal>2380</span>
<span class=normal>2381</span>
<span class=normal>2382</span>
<span class=normal>2383</span>
<span class=normal>2384</span>
<span class=normal>2385</span>
<span class=normal>2386</span>
<span class=normal>2387</span>
<span class=normal>2388</span>
<span class=normal>2389</span>
<span class=normal>2390</span>
<span class=normal>2391</span>
<span class=normal>2392</span>
<span class=normal>2393</span>
<span class=normal>2394</span>
<span class=normal>2395</span>
<span class=normal>2396</span>
<span class=normal>2397</span>
<span class=normal>2398</span>
<span class=normal>2399</span>
<span class=normal>2400</span>
<span class=normal>2401</span>
<span class=normal>2402</span>
<span class=normal>2403</span>
<span class=normal>2404</span>
<span class=normal>2405</span>
<span class=normal>2406</span>
<span class=normal>2407</span>
<span class=normal>2408</span>
<span class=normal>2409</span>
<span class=normal>2410</span>
<span class=normal>2411</span>
<span class=normal>2412</span>
<span class=normal>2413</span>
<span class=normal>2414</span>
<span class=normal>2415</span>
<span class=normal>2416</span>
<span class=normal>2417</span>
<span class=normal>2418</span>
<span class=normal>2419</span>
<span class=normal>2420</span>
<span class=normal>2421</span>
<span class=normal>2422</span>
<span class=normal>2423</span>
<span class=normal>2424</span>
<span class=normal>2425</span>
<span class=normal>2426</span>
<span class=normal>2427</span>
<span class=normal>2428</span>
<span class=normal>2429</span>
<span class=normal>2430</span>
<span class=normal>2431</span>
<span class=normal>2432</span>
<span class=normal>2433</span>
<span class=normal>2434</span>
<span class=normal>2435</span>
<span class=normal>2436</span>
<span class=normal>2437</span>
<span class=normal>2438</span>
<span class=normal>2439</span>
<span class=normal>2440</span>
<span class=normal>2441</span>
<span class=normal>2442</span>
<span class=normal>2443</span>
<span class=normal>2444</span>
<span class=normal>2445</span>
<span class=normal>2446</span>
<span class=normal>2447</span>
<span class=normal>2448</span>
<span class=normal>2449</span>
<span class=normal>2450</span>
<span class=normal>2451</span>
<span class=normal>2452</span>
<span class=normal>2453</span>
<span class=normal>2454</span>
<span class=normal>2455</span>
<span class=normal>2456</span>
<span class=normal>2457</span>
<span class=normal>2458</span>
<span class=normal>2459</span>
<span class=normal>2460</span>
<span class=normal>2461</span>
<span class=normal>2462</span>
<span class=normal>2463</span>
<span class=normal>2464</span>
<span class=normal>2465</span>
<span class=normal>2466</span>
<span class=normal>2467</span>
<span class=normal>2468</span>
<span class=normal>2469</span>
<span class=normal>2470</span>
<span class=normal>2471</span>
<span class=normal>2472</span>
<span class=normal>2473</span>
<span class=normal>2474</span>
<span class=normal>2475</span>
<span class=normal>2476</span>
<span class=normal>2477</span>
<span class=normal>2478</span>
<span class=normal>2479</span>
<span class=normal>2480</span>
<span class=normal>2481</span>
<span class=normal>2482</span>
<span class=normal>2483</span>
<span class=normal>2484</span>
<span class=normal>2485</span>
<span class=normal>2486</span>
<span class=normal>2487</span>
<span class=normal>2488</span>
<span class=normal>2489</span>
<span class=normal>2490</span>
<span class=normal>2491</span>
<span class=normal>2492</span>
<span class=normal>2493</span>
<span class=normal>2494</span>
<span class=normal>2495</span>
<span class=normal>2496</span>
<span class=normal>2497</span>
<span class=normal>2498</span>
<span class=normal>2499</span>
<span class=normal>2500</span>
<span class=normal>2501</span>
<span class=normal>2502</span>
<span class=normal>2503</span>
<span class=normal>2504</span>
<span class=normal>2505</span>
<span class=normal>2506</span>
<span class=normal>2507</span>
<span class=normal>2508</span>
<span class=normal>2509</span>
<span class=normal>2510</span>
<span class=normal>2511</span>
<span class=normal>2512</span>
<span class=normal>2513</span>
<span class=normal>2514</span>
<span class=normal>2515</span>
<span class=normal>2516</span>
<span class=normal>2517</span>
<span class=normal>2518</span>
<span class=normal>2519</span>
<span class=normal>2520</span>
<span class=normal>2521</span>
<span class=normal>2522</span>
<span class=normal>2523</span>
<span class=normal>2524</span>
<span class=normal>2525</span>
<span class=normal>2526</span>
<span class=normal>2527</span>
<span class=normal>2528</span>
<span class=normal>2529</span>
<span class=normal>2530</span>
<span class=normal>2531</span>
<span class=normal>2532</span>
<span class=normal>2533</span>
<span class=normal>2534</span>
<span class=normal>2535</span>
<span class=normal>2536</span>
<span class=normal>2537</span>
<span class=normal>2538</span>
<span class=normal>2539</span>
<span class=normal>2540</span>
<span class=normal>2541</span>
<span class=normal>2542</span>
<span class=normal>2543</span>
<span class=normal>2544</span>
<span class=normal>2545</span>
<span class=normal>2546</span>
<span class=normal>2547</span>
<span class=normal>2548</span>
<span class=normal>2549</span>
<span class=normal>2550</span>
<span class=normal>2551</span>
<span class=normal>2552</span>
<span class=normal>2553</span>
<span class=normal>2554</span>
<span class=normal>2555</span>
<span class=normal>2556</span>
<span class=normal>2557</span>
<span class=normal>2558</span>
<span class=normal>2559</span>
<span class=normal>2560</span>
<span class=normal>2561</span>
<span class=normal>2562</span>
<span class=normal>2563</span>
<span class=normal>2564</span>
<span class=normal>2565</span>
<span class=normal>2566</span>
<span class=normal>2567</span>
<span class=normal>2568</span>
<span class=normal>2569</span>
<span class=normal>2570</span>
<span class=normal>2571</span>
<span class=normal>2572</span>
<span class=normal>2573</span>
<span class=normal>2574</span>
<span class=normal>2575</span>
<span class=normal>2576</span>
<span class=normal>2577</span>
<span class=normal>2578</span>
<span class=normal>2579</span>
<span class=normal>2580</span>
<span class=normal>2581</span>
<span class=normal>2582</span>
<span class=normal>2583</span>
<span class=normal>2584</span>
<span class=normal>2585</span>
<span class=normal>2586</span>
<span class=normal>2587</span>
<span class=normal>2588</span>
<span class=normal>2589</span>
<span class=normal>2590</span>
<span class=normal>2591</span>
<span class=normal>2592</span>
<span class=normal>2593</span>
<span class=normal>2594</span>
<span class=normal>2595</span>
<span class=normal>2596</span>
<span class=normal>2597</span>
<span class=normal>2598</span>
<span class=normal>2599</span>
<span class=normal>2600</span>
<span class=normal>2601</span>
<span class=normal>2602</span>
<span class=normal>2603</span>
<span class=normal>2604</span>
<span class=normal>2605</span>
<span class=normal>2606</span>
<span class=normal>2607</span>
<span class=normal>2608</span>
<span class=normal>2609</span>
<span class=normal>2610</span>
<span class=normal>2611</span>
<span class=normal>2612</span>
<span class=normal>2613</span>
<span class=normal>2614</span>
<span class=normal>2615</span>
<span class=normal>2616</span>
<span class=normal>2617</span>
<span class=normal>2618</span>
<span class=normal>2619</span>
<span class=normal>2620</span>
<span class=normal>2621</span>
<span class=normal>2622</span>
<span class=normal>2623</span>
<span class=normal>2624</span>
<span class=normal>2625</span>
<span class=normal>2626</span>
<span class=normal>2627</span>
<span class=normal>2628</span>
<span class=normal>2629</span>
<span class=normal>2630</span>
<span class=normal>2631</span>
<span class=normal>2632</span>
<span class=normal>2633</span>
<span class=normal>2634</span>
<span class=normal>2635</span>
<span class=normal>2636</span>
<span class=normal>2637</span>
<span class=normal>2638</span>
<span class=normal>2639</span>
<span class=normal>2640</span>
<span class=normal>2641</span>
<span class=normal>2642</span>
<span class=normal>2643</span>
<span class=normal>2644</span>
<span class=normal>2645</span>
<span class=normal>2646</span>
<span class=normal>2647</span>
<span class=normal>2648</span>
<span class=normal>2649</span>
<span class=normal>2650</span>
<span class=normal>2651</span>
<span class=normal>2652</span>
<span class=normal>2653</span>
<span class=normal>2654</span>
<span class=normal>2655</span>
<span class=normal>2656</span>
<span class=normal>2657</span>
<span class=normal>2658</span>
<span class=normal>2659</span>
<span class=normal>2660</span>
<span class=normal>2661</span>
<span class=normal>2662</span>
<span class=normal>2663</span>
<span class=normal>2664</span>
<span class=normal>2665</span>
<span class=normal>2666</span>
<span class=normal>2667</span>
<span class=normal>2668</span>
<span class=normal>2669</span>
<span class=normal>2670</span>
<span class=normal>2671</span>
<span class=normal>2672</span>
<span class=normal>2673</span>
<span class=normal>2674</span>
<span class=normal>2675</span>
<span class=normal>2676</span>
<span class=normal>2677</span>
<span class=normal>2678</span>
<span class=normal>2679</span>
<span class=normal>2680</span>
<span class=normal>2681</span>
<span class=normal>2682</span>
<span class=normal>2683</span>
<span class=normal>2684</span>
<span class=normal>2685</span>
<span class=normal>2686</span>
<span class=normal>2687</span>
<span class=normal>2688</span>
<span class=normal>2689</span>
<span class=normal>2690</span>
<span class=normal>2691</span>
<span class=normal>2692</span>
<span class=normal>2693</span>
<span class=normal>2694</span>
<span class=normal>2695</span>
<span class=normal>2696</span>
<span class=normal>2697</span>
<span class=normal>2698</span>
<span class=normal>2699</span>
<span class=normal>2700</span>
<span class=normal>2701</span>
<span class=normal>2702</span>
<span class=normal>2703</span>
<span class=normal>2704</span>
<span class=normal>2705</span>
<span class=normal>2706</span>
<span class=normal>2707</span>
<span class=normal>2708</span>
<span class=normal>2709</span>
<span class=normal>2710</span>
<span class=normal>2711</span>
<span class=normal>2712</span>
<span class=normal>2713</span>
<span class=normal>2714</span>
<span class=normal>2715</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>class</span><span class=w> </span><span class=nc>SyncToAvalonEvent</span><span class=p>(</span><span class=n>BaseEventHandler</span><span class=p>):</span>
    <span class=n>interest_entTypes</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;show&quot;</span><span class=p>,</span> <span class=s2>&quot;task&quot;</span><span class=p>]</span>
    <span class=n>ignore_ent_types</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;Milestone&quot;</span><span class=p>]</span>
    <span class=n>ignore_keys</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;statusid&quot;</span><span class=p>,</span> <span class=s2>&quot;thumbid&quot;</span><span class=p>]</span>

    <span class=n>cust_attr_query_keys</span> <span class=o>=</span> <span class=p>[</span>
        <span class=s2>&quot;id&quot;</span><span class=p>,</span>
        <span class=s2>&quot;key&quot;</span><span class=p>,</span>
        <span class=s2>&quot;entity_type&quot;</span><span class=p>,</span>
        <span class=s2>&quot;object_type_id&quot;</span><span class=p>,</span>
        <span class=s2>&quot;is_hierarchical&quot;</span><span class=p>,</span>
        <span class=s2>&quot;config&quot;</span><span class=p>,</span>
        <span class=s2>&quot;default&quot;</span>
    <span class=p>]</span>
    <span class=n>project_query</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;select full_name, name, custom_attributes&quot;</span>
        <span class=s2>&quot;, project_schema._task_type_schema.types.name&quot;</span>
        <span class=s2>&quot; from Project where id is </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span>
    <span class=p>)</span>

    <span class=n>entities_query_by_id</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;select id, name, parent_id, link, custom_attributes, description&quot;</span>
        <span class=s2>&quot; from TypedContext where project_id is </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> and id in (</span><span class=si>{}</span><span class=s2>)&quot;</span>
    <span class=p>)</span>

    <span class=c1># useful for getting all tasks for asset</span>
    <span class=n>task_entities_query_by_parent_id</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;select id, name, parent_id, type_id from Task&quot;</span>
        <span class=s2>&quot; where project_id is </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> and parent_id in (</span><span class=si>{}</span><span class=s2>)&quot;</span>
    <span class=p>)</span>
    <span class=n>task_types_query</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;select id, name from Type&quot;</span>
    <span class=p>)</span>
    <span class=n>entities_name_query_by_name</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;select id, name from TypedContext&quot;</span>
        <span class=s2>&quot; where project_id is </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> and name in (</span><span class=si>{}</span><span class=s2>)&quot;</span>
    <span class=p>)</span>
    <span class=n>created_entities</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>report_splitter</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span> <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s2>&quot;---&quot;</span><span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&#39;&#39;&#39;Expects a ftrack_api.Session instance&#39;&#39;&#39;</span>
        <span class=c1># Debug settings</span>
        <span class=c1># - time expiration in seconds</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time_expiration</span> <span class=o>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=mi>60</span>
        <span class=c1># - store current time</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=c1># - store synchronize entity types to be able to use</span>
        <span class=c1>#   only entityTypes in interest instead of filtering by ignored</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span> <span class=o>=</span> <span class=n>AvalonMongoDB</span><span class=p>()</span>
        <span class=c1># Set processing session to not use global</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>set_process_session</span><span class=p>(</span><span class=n>session</span><span class=p>)</span>
        <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>session</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>debug_logs</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;This is debug method for printing small debugs messages. &quot;&quot;&quot;</span>
        <span class=n>now_datetime</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
        <span class=n>delta</span> <span class=o>=</span> <span class=n>now_datetime</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time</span>
        <span class=k>if</span> <span class=n>delta</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time_expiration</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time</span> <span class=o>=</span> <span class=n>now_datetime</span>
        <span class=n>known_types_items</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>entityType</span><span class=p>,</span> <span class=n>entity_type</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>ent_types_msg</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>entity_type</span><span class=p>)</span>
            <span class=n>known_types_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
                <span class=s2>&quot;&lt;</span><span class=si>{}</span><span class=s2>&gt; (</span><span class=si>{}</span><span class=s2>)&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>entityType</span><span class=p>,</span> <span class=n>ent_types_msg</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=n>known_entityTypes</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>known_types_items</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;DEBUG MESSAGE: Known types </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>known_entityTypes</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>cur_project</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_cur_project</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>found_id</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=k>for</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>_cur_event</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entities&quot;</span><span class=p>]:</span>
                <span class=k>if</span> <span class=n>found_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>break</span>
                <span class=n>parents</span> <span class=o>=</span> <span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[]</span>
                <span class=k>for</span> <span class=n>parent</span> <span class=ow>in</span> <span class=n>parents</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>parent</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;entityType&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
                        <span class=n>found_id</span> <span class=o>=</span> <span class=n>parent</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;entityId&quot;</span><span class=p>)</span>
                        <span class=k>break</span>
            <span class=k>if</span> <span class=n>found_id</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_cur_project</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>project_query</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>found_id</span><span class=p>)</span>
                <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_cur_project</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_cust_attrs</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_cust_attrs</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_cust_attrs</span> <span class=o>=</span> <span class=n>get_ayon_attr_configs</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=p>,</span> <span class=n>query_keys</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>cust_attr_query_keys</span>
            <span class=p>)</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_cust_attrs</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>cust_attr_types_by_id</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_cust_attr_types_by_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>cust_attr_types</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                <span class=s2>&quot;select id, name from CustomAttributeType&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_cust_attr_types_by_id</span> <span class=o>=</span> <span class=p>{</span>
                <span class=n>cust_attr_type</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]:</span> <span class=n>cust_attr_type</span>
                <span class=k>for</span> <span class=n>cust_attr_type</span> <span class=ow>in</span> <span class=n>cust_attr_types</span>
            <span class=p>}</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_cust_attr_types_by_id</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_entities</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>project_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>install</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>Session</span><span class=p>[</span><span class=s2>&quot;AVALON_PROJECT&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>project_name</span>
            <span class=n>avalon_project</span> <span class=o>=</span> <span class=n>get_project</span><span class=p>(</span><span class=n>project_name</span><span class=p>)</span>
            <span class=n>avalon_entities</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>get_assets</span><span class=p>(</span><span class=n>project_name</span><span class=p>))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=p>(</span><span class=n>avalon_project</span><span class=p>,</span> <span class=n>avalon_entities</span><span class=p>)</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_ents_by_name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>
            <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ents</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=p>[</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>ent</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_ents_by_id</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>
            <span class=k>if</span> <span class=n>proj</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=p>[</span><span class=n>proj</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>proj</span>
                <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ents</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=p>[</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>ent</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_ents_by_parent_id</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
            <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>
            <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ents</span><span class=p>:</span>
                <span class=n>vis_par</span> <span class=o>=</span> <span class=n>ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>vis_par</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>vis_par</span> <span class=o>=</span> <span class=n>proj</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent</span><span class=p>)</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_ents_by_ftrack_id</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>
            <span class=k>if</span> <span class=n>proj</span><span class=p>:</span>
                <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>proj</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>handle_missing_ftrack_id</span><span class=p>(</span><span class=n>proj</span><span class=p>)</span>
                    <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>proj</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>proj</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>proj</span>
                <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ents</span><span class=p>:</span>
                    <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
                    <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                        <span class=k>continue</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ent</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span>

    <span class=k>def</span><span class=w> </span><span class=nf>handle_missing_ftrack_id</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>doc</span><span class=p>):</span>
        <span class=c1># TODO handling of missing ftrack id is primarily issue of editorial</span>
        <span class=c1>#   publishing it would be better to find out what causes that</span>
        <span class=c1>#   ftrack id is removed during the publishing</span>
        <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=k>if</span> <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>update_one</span><span class=p>(</span>
                <span class=p>{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;project&quot;</span><span class=p>},</span>
                <span class=p>{</span><span class=s2>&quot;$set&quot;</span><span class=p>:</span> <span class=p>{</span>
                    <span class=s2>&quot;data.ftrackId&quot;</span><span class=p>:</span> <span class=n>ftrack_id</span><span class=p>,</span>
                    <span class=s2>&quot;data.entityType&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=o>.</span><span class=n>entity_type</span>
                <span class=p>}}</span>
            <span class=p>)</span>

            <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>
            <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=o>.</span><span class=n>entity_type</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Updated ftrack id of project </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]</span>
            <span class=p>))</span>
            <span class=k>return</span>

        <span class=k>if</span> <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=s2>&quot;asset&quot;</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>doc_parents</span> <span class=o>=</span> <span class=n>doc</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;data&quot;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>doc_parents</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>((</span>
            <span class=s2>&quot;select id, link from TypedContext&quot;</span>
            <span class=s2>&quot; where project_id is </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> and name is </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span>
        <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]))</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>entities</span><span class=p>)))</span>
        <span class=n>matching_entity</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>entities</span><span class=p>:</span>
            <span class=n>parents</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]:</span>
                <span class=k>if</span> <span class=n>item</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]:</span>
                    <span class=k>break</span>
                <span class=n>low_type</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>
                <span class=k>if</span> <span class=n>low_type</span> <span class=o>==</span> <span class=s2>&quot;typedcontext&quot;</span><span class=p>:</span>
                    <span class=n>parents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
            <span class=k>if</span> <span class=n>doc_parents</span> <span class=o>==</span> <span class=n>parents</span><span class=p>:</span>
                <span class=n>matching_entity</span> <span class=o>=</span> <span class=n>entity</span>
                <span class=k>break</span>

        <span class=k>if</span> <span class=n>matching_entity</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>matching_entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>update_one</span><span class=p>(</span>
            <span class=p>{</span><span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]},</span>
            <span class=p>{</span><span class=s2>&quot;$set&quot;</span><span class=p>:</span> <span class=p>{</span>
                <span class=s2>&quot;data.ftrackId&quot;</span><span class=p>:</span> <span class=n>ftrack_id</span><span class=p>,</span>
                <span class=s2>&quot;data.entityType&quot;</span><span class=p>:</span> <span class=n>matching_entity</span><span class=o>.</span><span class=n>entity_type</span>
            <span class=p>}}</span>
        <span class=p>)</span>
        <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>
        <span class=n>doc</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>matching_entity</span><span class=o>.</span><span class=n>entity_type</span>

        <span class=n>entity_path_items</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]:</span>
            <span class=n>entity_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=s2>&quot;Updated ftrack id of entity </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>entity_path_items</span><span class=p>)</span>
        <span class=p>))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>doc</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_asset_ids_with_subsets</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_asset_ids_with_subsets</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>project_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_asset_ids_with_subsets</span> <span class=o>=</span> <span class=n>get_asset_ids_with_subsets</span><span class=p>(</span>
                <span class=n>project_name</span>
            <span class=p>)</span>

        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_asset_ids_with_subsets</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_archived_by_id</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=n>project_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]</span>
            <span class=k>for</span> <span class=n>asset</span> <span class=ow>in</span> <span class=n>get_archived_assets</span><span class=p>(</span><span class=n>project_name</span><span class=p>):</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span><span class=p>[</span><span class=n>asset</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>asset</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>avalon_archived_by_name</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_name</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_name</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=k>for</span> <span class=n>asset</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_archived_by_id</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_name</span><span class=p>[</span><span class=n>asset</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>asset</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_name</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>changeability_by_mongo_id</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Return info about changeability of entity and it&#39;s parents.&quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_changeability_by_mongo_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_changeability_by_mongo_id</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span>
                <span class=k>lambda</span><span class=p>:</span> <span class=kc>True</span>
            <span class=p>)</span>
            <span class=n>avalon_project</span><span class=p>,</span> <span class=n>avalon_entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_changeability_by_mongo_id</span><span class=p>[</span><span class=n>avalon_project</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>False</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_bubble_changeability</span><span class=p>(</span>
                <span class=nb>list</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>avalon_asset_ids_with_subsets</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_changeability_by_mongo_id</span>

    <span class=k>def</span><span class=w> </span><span class=nf>remove_cached_by_key</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>values</span><span class=p>):</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>values</span><span class=p>,</span> <span class=p>(</span><span class=nb>list</span><span class=p>,</span> <span class=nb>tuple</span><span class=p>)):</span>
            <span class=n>values</span> <span class=o>=</span> <span class=p>[</span><span class=n>values</span><span class=p>]</span>

        <span class=k>def</span><span class=w> </span><span class=nf>get_found_data</span><span class=p>(</span><span class=n>entity</span><span class=p>):</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>entity</span><span class=p>:</span>
                <span class=k>return</span> <span class=kc>None</span>
            <span class=k>return</span> <span class=p>{</span>
                <span class=s2>&quot;ftrack_id&quot;</span><span class=p>:</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>],</span>
                <span class=s2>&quot;parent_id&quot;</span><span class=p>:</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>],</span>
                <span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>],</span>
                <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>],</span>
                <span class=s2>&quot;entity&quot;</span><span class=p>:</span> <span class=n>entity</span>
            <span class=p>}</span>

        <span class=k>if</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&quot;id&quot;</span><span class=p>:</span>
            <span class=n>key</span> <span class=o>=</span> <span class=s2>&quot;_id&quot;</span>
        <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&quot;ftrack_id&quot;</span><span class=p>:</span>
            <span class=n>key</span> <span class=o>=</span> <span class=s2>&quot;data.ftrackId&quot;</span>

        <span class=n>found_data</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>project</span><span class=p>,</span> <span class=n>entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span>
        <span class=n>key_items</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;.&quot;</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>values</span><span class=p>:</span>
            <span class=n>ent</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=k>if</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&quot;_id&quot;</span><span class=p>:</span>
                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&quot;name&quot;</span><span class=p>:</span>
                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>

            <span class=k>elif</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&quot;data.ftrackId&quot;</span><span class=p>:</span>
                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>ent</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=k>for</span> <span class=n>_ent</span> <span class=ow>in</span> <span class=n>entities</span><span class=p>:</span>
                    <span class=n>_temp</span> <span class=o>=</span> <span class=n>_ent</span>
                    <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>key_items</span><span class=p>:</span>
                        <span class=n>_temp</span> <span class=o>=</span> <span class=n>_temp</span><span class=p>[</span><span class=n>item</span><span class=p>]</span>

                    <span class=k>if</span> <span class=n>_temp</span> <span class=o>==</span> <span class=n>value</span><span class=p>:</span>
                        <span class=n>ent</span> <span class=o>=</span> <span class=n>_ent</span>
                        <span class=k>break</span>

            <span class=n>found_data</span><span class=p>[</span><span class=n>value</span><span class=p>]</span> <span class=o>=</span> <span class=n>get_found_data</span><span class=p>(</span><span class=n>ent</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>values</span><span class=p>:</span>
            <span class=n>data</span> <span class=o>=</span> <span class=n>found_data</span><span class=p>[</span><span class=n>value</span><span class=p>]</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>data</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                    <span class=s2>&quot;Didn&#39;t found entity by key/value </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> / </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>key</span><span class=p>,</span> <span class=n>value</span>
                    <span class=p>)</span>
                <span class=p>)</span>
                <span class=k>continue</span>

            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;ftrack_id&quot;</span><span class=p>]</span>
            <span class=n>parent_id</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=n>name</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=n>entity</span> <span class=o>=</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;entity&quot;</span><span class=p>]</span>

            <span class=n>project</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span>
            <span class=n>ents</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>entity</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=n>project</span><span class=p>,</span> <span class=n>ents</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>parent_id</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>entity</span><span class=p>)</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>entity</span>

    <span class=k>def</span><span class=w> </span><span class=nf>_bubble_changeability</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>unchangeable_ids</span><span class=p>):</span>
        <span class=n>unchangeable_queue</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>entity_id</span> <span class=ow>in</span> <span class=n>unchangeable_ids</span><span class=p>:</span>
            <span class=n>unchangeable_queue</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>entity_id</span><span class=p>,</span> <span class=kc>False</span><span class=p>))</span>

        <span class=n>processed_parents_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>while</span> <span class=n>unchangeable_queue</span><span class=p>:</span>
            <span class=n>entity_id</span><span class=p>,</span> <span class=n>child_is_archived</span> <span class=o>=</span> <span class=n>unchangeable_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
            <span class=c1># skip if already processed</span>
            <span class=k>if</span> <span class=n>entity_id</span> <span class=ow>in</span> <span class=n>processed_parents_ids</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>entity_id</span><span class=p>)</span>
            <span class=c1># if entity is not archived but unchageable child was then skip</span>
            <span class=c1># - archived entities should not affect not archived?</span>
            <span class=k>if</span> <span class=n>entity</span> <span class=ow>and</span> <span class=n>child_is_archived</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=c1># set changeability of current entity to False</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_changeability_by_mongo_id</span><span class=p>[</span><span class=n>entity_id</span><span class=p>]</span> <span class=o>=</span> <span class=kc>False</span>
            <span class=n>processed_parents_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entity_id</span><span class=p>)</span>
            <span class=c1># if not entity then is probably archived</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>entity</span><span class=p>:</span>
                <span class=n>entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_archived_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>entity_id</span><span class=p>)</span>
                <span class=n>child_is_archived</span> <span class=o>=</span> <span class=kc>True</span>

            <span class=k>if</span> <span class=ow>not</span> <span class=n>entity</span><span class=p>:</span>
                <span class=c1># if entity is not found then it is subset without parent</span>
                <span class=k>if</span> <span class=n>entity_id</span> <span class=ow>in</span> <span class=n>unchangeable_ids</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>((</span>
                        <span class=s2>&quot;Parent &lt;</span><span class=si>{}</span><span class=s2>&gt; with subsets does not exist&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>entity_id</span><span class=p>)))</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>((</span>
                        <span class=s2>&quot;In avalon are entities without valid parents that&quot;</span>
                        <span class=s2>&quot; lead to Project (should not cause errors)&quot;</span>
                        <span class=s2>&quot; - MongoId &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>entity_id</span><span class=p>)))</span>
                <span class=k>continue</span>

            <span class=c1># skip if parent is project</span>
            <span class=n>parent_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>parent_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>unchangeable_queue</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>parent_id</span><span class=p>,</span> <span class=n>child_is_archived</span><span class=p>))</span>

    <span class=k>def</span><span class=w> </span><span class=nf>reset_variables</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Reset variables so each event callback has clear env.&quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_cur_project</span> <span class=o>=</span> <span class=kc>None</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_cust_attrs</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_cust_attr_types_by_id</span> <span class=o>=</span> <span class=kc>None</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_asset_ids_with_subsets</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_changeability_by_mongo_id</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_name</span> <span class=o>=</span> <span class=kc>None</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_ent_types_by_name</span> <span class=o>=</span> <span class=kc>None</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>obj_id_ent_type_map</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span> <span class=o>=</span> <span class=p>{}</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_added</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_renamed</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span> <span class=o>=</span> <span class=p>{}</span>

        <span class=c1># set of ftrack ids with modified tasks</span>
        <span class=c1># handled separately by full wipeout and replace from ftrack</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>moved_in_avalon</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>renamed_in_avalon</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>hier_cust_attrs_changes</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>duplicated</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span> <span class=o>=</span> <span class=p>[]</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>updates</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;info&quot;</span><span class=p>:</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>),</span>
            <span class=s2>&quot;warning&quot;</span><span class=p>:</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>),</span>
            <span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
        <span class=p>}</span>

    <span class=k>def</span><span class=w> </span><span class=nf>set_process_session</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>):</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
            <span class=k>pass</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span> <span class=o>=</span> <span class=n>ftrack_api</span><span class=o>.</span><span class=n>Session</span><span class=p>(</span>
            <span class=n>server_url</span><span class=o>=</span><span class=n>session</span><span class=o>.</span><span class=n>server_url</span><span class=p>,</span>
            <span class=n>api_key</span><span class=o>=</span><span class=n>session</span><span class=o>.</span><span class=n>api_key</span><span class=p>,</span>
            <span class=n>api_user</span><span class=o>=</span><span class=n>session</span><span class=o>.</span><span class=n>api_user</span><span class=p>,</span>
            <span class=n>auto_connect_event_hub</span><span class=o>=</span><span class=kc>True</span>
        <span class=p>)</span>
        <span class=n>atexit</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>close</span><span class=p>())</span>

    <span class=k>def</span><span class=w> </span><span class=nf>filter_updated</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>updates</span><span class=p>):</span>
        <span class=n>filtered_updates</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>updates</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>changed_keys</span> <span class=o>=</span> <span class=p>[</span><span class=n>k</span> <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=p>(</span><span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;keys&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[])]</span>
            <span class=n>changes</span> <span class=o>=</span> <span class=p>{</span>
                <span class=n>k</span><span class=p>:</span> <span class=n>v</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=p>(</span><span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;changes&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>{})</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
            <span class=p>}</span>

            <span class=n>entity_type</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>entity_type</span> <span class=o>==</span> <span class=s2>&quot;Task&quot;</span><span class=p>:</span>
                <span class=k>if</span> <span class=s2>&quot;name&quot;</span> <span class=ow>in</span> <span class=n>changed_keys</span><span class=p>:</span>
                    <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
                    <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>changes</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&quot;name&quot;</span><span class=p>)}</span>
                    <span class=n>filtered_updates</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ent_info</span>
                <span class=k>continue</span>

            <span class=k>for</span> <span class=n>_key</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignore_keys</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>_key</span> <span class=ow>in</span> <span class=n>changed_keys</span><span class=p>:</span>
                    <span class=n>changed_keys</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>_key</span><span class=p>)</span>
                    <span class=n>changes</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

            <span class=k>if</span> <span class=ow>not</span> <span class=n>changed_keys</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=c1># Remove custom attributes starting with `avalon_` from changes</span>
            <span class=c1># - these custom attributes are not synchronized</span>
            <span class=n>avalon_keys</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>changes</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;avalon_&quot;</span><span class=p>):</span>
                    <span class=n>avalon_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>_key</span> <span class=ow>in</span> <span class=n>avalon_keys</span><span class=p>:</span>
                <span class=n>changed_keys</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>_key</span><span class=p>)</span>
                <span class=n>changes</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

            <span class=k>if</span> <span class=ow>not</span> <span class=n>changed_keys</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>changed_keys</span>
            <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>changes</span>
            <span class=n>filtered_updates</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ent_info</span>

        <span class=k>return</span> <span class=n>filtered_updates</span>

    <span class=k>def</span><span class=w> </span><span class=nf>get_ent_path</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ftrack_id</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Looks for entity in ftrack with &#39;ftrack_id&#39;. If found returns</span>
<span class=sd>            concatenated paths from its &#39;link&#39; elemenent&#39;s names. Describes</span>
<span class=sd>            location of entity in tree.</span>
<span class=sd>        Args:</span>
<span class=sd>            ftrack_id (string): entityId of ftrack entity</span>

<span class=sd>        Returns:</span>
<span class=sd>            (string) - example : &quot;/test_project/assets/my_asset&quot;</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>entity</span><span class=p>:</span>
            <span class=n>entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>ftrack_id</span>
                <span class=p>)</span>
            <span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
            <span class=k>if</span> <span class=n>entity</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>entity</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=k>return</span> <span class=s2>&quot;unknown hierarchy&quot;</span>
        <span class=k>return</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]])</span>

    <span class=k>def</span><span class=w> </span><span class=nf>launch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Main entry port for synchronization.</span>
<span class=sd>            Goes through event (can contain multiple changes) and decides if</span>
<span class=sd>            the event is interesting for us (interest_entTypes).</span>
<span class=sd>            It separates changes into add|remove|update.</span>
<span class=sd>            All task changes are handled together by refresh from ftrack.</span>
<span class=sd>        Args:</span>
<span class=sd>            session (object): session to ftrack</span>
<span class=sd>            event (dictionary): event content</span>

<span class=sd>        Returns:</span>
<span class=sd>            (boolean or None)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=c1># Try to commit and if any error happen then recreate session</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>set_process_session</span><span class=p>(</span><span class=n>session</span><span class=p>)</span>
        <span class=c1># Reset object values for each launch</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>reset_variables</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_cur_event</span> <span class=o>=</span> <span class=n>event</span>

        <span class=n>entities_by_action</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;remove&quot;</span><span class=p>:</span> <span class=p>{},</span>
            <span class=s2>&quot;update&quot;</span><span class=p>:</span> <span class=p>{},</span>
            <span class=s2>&quot;move&quot;</span><span class=p>:</span> <span class=p>{},</span>
            <span class=s2>&quot;add&quot;</span><span class=p>:</span> <span class=p>{}</span>
        <span class=p>}</span>

        <span class=n>entities_info</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entities&quot;</span><span class=p>]</span>
        <span class=n>found_actions</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>entities_info</span><span class=p>:</span>
            <span class=n>entityType</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>entityType</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>interest_entTypes</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>entity_type</span> <span class=o>=</span> <span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;entity_type&quot;</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>entity_type</span> <span class=ow>or</span> <span class=n>entity_type</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignore_ent_types</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=n>entity_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span><span class=p>[</span><span class=n>entityType</span><span class=p>]:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span><span class=p>[</span><span class=n>entityType</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entity_type</span><span class=p>)</span>

            <span class=n>action</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;action&quot;</span><span class=p>]</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityId&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>((</span>
                    <span class=s2>&quot;BUG REPORT: Entity info has `entityId` as `list` </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_info</span><span class=p>))</span>
                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                    <span class=k>continue</span>
                <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>ftrack_id</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

            <span class=c1># Skip deleted projects</span>
            <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;remove&quot;</span> <span class=ow>and</span> <span class=n>entityType</span> <span class=o>==</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
                <span class=k>return</span> <span class=kc>True</span>

            <span class=c1># task modified, collect parent id of task, handle separately</span>
            <span class=k>if</span> <span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
                <span class=n>changes</span> <span class=o>=</span> <span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;changes&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>{}</span>
                <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;move&quot;</span><span class=p>:</span>
                    <span class=n>parent_changes</span> <span class=o>=</span> <span class=n>changes</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>parent_changes</span><span class=p>[</span><span class=s2>&quot;new&quot;</span><span class=p>])</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>parent_changes</span><span class=p>[</span><span class=s2>&quot;old&quot;</span><span class=p>])</span>

                <span class=k>elif</span> <span class=s2>&quot;typeid&quot;</span> <span class=ow>in</span> <span class=n>changes</span> <span class=ow>or</span> <span class=s2>&quot;name&quot;</span> <span class=ow>in</span> <span class=n>changes</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;parentId&quot;</span><span class=p>])</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;move&quot;</span><span class=p>:</span>
                <span class=n>ent_keys</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span>
                <span class=c1># Separate update info from move action</span>
                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ent_keys</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
                    <span class=n>_ent_info</span> <span class=o>=</span> <span class=n>ent_info</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
                    <span class=k>for</span> <span class=n>ent_key</span> <span class=ow>in</span> <span class=n>ent_keys</span><span class=p>:</span>
                        <span class=k>if</span> <span class=n>ent_key</span> <span class=o>==</span> <span class=s2>&quot;parent_id&quot;</span><span class=p>:</span>
                            <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                            <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>
                        <span class=k>else</span><span class=p>:</span>
                            <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                            <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>
                    <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;update&quot;</span><span class=p>][</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>_ent_info</span>
            <span class=c1># regular change process handles all other than Tasks</span>
            <span class=n>found_actions</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
            <span class=n>entities_by_action</span><span class=p>[</span><span class=n>action</span><span class=p>][</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ent_info</span>

        <span class=n>found_actions</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>found_actions</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>found_actions</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>True</span>

        <span class=c1># Check if auto sync was turned on/off</span>
        <span class=n>updated</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;update&quot;</span><span class=p>]</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>updated</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=c1># filter project</span>
            <span class=k>if</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>changes</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>CUST_ATTR_AUTO_SYNC</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>changes</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>auto_sync</span> <span class=o>=</span> <span class=n>changes</span><span class=p>[</span><span class=n>CUST_ATTR_AUTO_SYNC</span><span class=p>][</span><span class=s2>&quot;new&quot;</span><span class=p>]</span>
            <span class=n>turned_on</span> <span class=o>=</span> <span class=n>auto_sync</span> <span class=o>==</span> <span class=s2>&quot;1&quot;</span>
            <span class=n>ft_project</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
            <span class=n>username</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_username</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
            <span class=n>message</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Auto sync was turned </span><span class=si>{}</span><span class=s2> for project </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> by </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>.&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=s2>&quot;on&quot;</span> <span class=k>if</span> <span class=n>turned_on</span> <span class=k>else</span> <span class=s2>&quot;off&quot;</span><span class=p>,</span>
                <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>],</span>
                <span class=n>username</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=n>turned_on</span><span class=p>:</span>
                <span class=n>message</span> <span class=o>+=</span> <span class=s2>&quot; Triggering syncToAvalon action.&quot;</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>turned_on</span><span class=p>:</span>
                <span class=c1># Trigger sync to avalon action if auto sync was turned on</span>
                <span class=n>selection</span> <span class=o>=</span> <span class=p>[{</span>
                    <span class=s2>&quot;entityId&quot;</span><span class=p>:</span> <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span>
                    <span class=s2>&quot;entityType&quot;</span><span class=p>:</span> <span class=s2>&quot;show&quot;</span>
                <span class=p>}]</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>trigger_action</span><span class=p>(</span>
                    <span class=n>action_name</span><span class=o>=</span><span class=s2>&quot;sync.to.avalon.server&quot;</span><span class=p>,</span>
                    <span class=n>event</span><span class=o>=</span><span class=n>event</span><span class=p>,</span>
                    <span class=n>selection</span><span class=o>=</span><span class=n>selection</span>
                <span class=p>)</span>
            <span class=c1># Exit for both cases</span>
            <span class=k>return</span> <span class=kc>True</span>

        <span class=c1># Filter updated data by changed keys</span>
        <span class=n>updated</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter_updated</span><span class=p>(</span><span class=n>updated</span><span class=p>)</span>

        <span class=c1># skip most of events where nothing has changed for avalon</span>
        <span class=k>if</span> <span class=p>(</span>
            <span class=nb>len</span><span class=p>(</span><span class=n>found_actions</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
            <span class=ow>and</span> <span class=n>found_actions</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;update&quot;</span>
            <span class=ow>and</span> <span class=ow>not</span> <span class=n>updated</span>
            <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
        <span class=p>):</span>
            <span class=k>return</span> <span class=kc>True</span>

        <span class=n>ft_project</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
        <span class=c1># Check if auto-sync custom attribute exists</span>
        <span class=k>if</span> <span class=n>CUST_ATTR_AUTO_SYNC</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>]:</span>
            <span class=c1># TODO should we sent message to someone?</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>((</span>
                <span class=s2>&quot;Custom attribute </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> is not created or user </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> used&quot;</span>
                <span class=s2>&quot; for Event server don&#39;t have permissions to access it!&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>CUST_ATTR_AUTO_SYNC</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>api_user</span><span class=p>))</span>
            <span class=k>return</span> <span class=kc>True</span>

        <span class=c1># Skip if auto-sync is not set</span>
        <span class=n>auto_sync</span> <span class=o>=</span> <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>CUST_ATTR_AUTO_SYNC</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>auto_sync</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>True</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>True</span>

        <span class=n>debug_msg</span> <span class=o>=</span> <span class=s2>&quot;Updated: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>updated</span><span class=p>))</span>
        <span class=n>debug_action_map</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;add&quot;</span><span class=p>:</span> <span class=s2>&quot;Created&quot;</span><span class=p>,</span>
            <span class=s2>&quot;remove&quot;</span><span class=p>:</span> <span class=s2>&quot;Removed&quot;</span><span class=p>,</span>
            <span class=s2>&quot;move&quot;</span><span class=p>:</span> <span class=s2>&quot;Moved&quot;</span>
        <span class=p>}</span>
        <span class=k>for</span> <span class=n>action</span><span class=p>,</span> <span class=n>infos</span> <span class=ow>in</span> <span class=n>entities_by_action</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;update&quot;</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>_action</span> <span class=o>=</span> <span class=n>debug_action_map</span><span class=p>[</span><span class=n>action</span><span class=p>]</span>
            <span class=n>debug_msg</span> <span class=o>+=</span> <span class=s2>&quot;| </span><span class=si>{}</span><span class=s2>: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>_action</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>infos</span><span class=p>))</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Project changes &lt;</span><span class=si>{}</span><span class=s2>&gt;: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>],</span> <span class=n>debug_msg</span>
        <span class=p>))</span>
        <span class=c1># Get ftrack entities - find all ftrack ids first</span>
        <span class=n>ftrack_ids</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>updated</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>

        <span class=k>for</span> <span class=n>action</span><span class=p>,</span> <span class=n>_ftrack_ids</span> <span class=ow>in</span> <span class=n>entities_by_action</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=c1># skip updated (already prepared) and removed (not exist in ftrack)</span>
            <span class=k>if</span> <span class=n>action</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&quot;remove&quot;</span><span class=p>,</span> <span class=s2>&quot;update&quot;</span><span class=p>):</span>
                <span class=n>ftrack_ids</span> <span class=o>|=</span> <span class=nb>set</span><span class=p>(</span><span class=n>_ftrack_ids</span><span class=p>)</span>

        <span class=c1># collect entity records data which might not be in event</span>
        <span class=k>if</span> <span class=n>ftrack_ids</span><span class=p>:</span>
            <span class=n>joined_ids</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span> <span class=k>for</span> <span class=nb>id</span> <span class=ow>in</span> <span class=n>ftrack_ids</span><span class=p>])</span>
            <span class=n>ftrack_entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joined_ids</span><span class=p>)</span>
            <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
            <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>ftrack_entities</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>entity</span>

        <span class=c1># Filter updates where name is changing</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>updated</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>ent_keys</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span>
            <span class=c1># Seprate update info from rename</span>
            <span class=k>if</span> <span class=s2>&quot;name&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ent_keys</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>_ent_info</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=n>ent_info</span><span class=p>)</span>
            <span class=k>for</span> <span class=n>ent_key</span> <span class=ow>in</span> <span class=n>ent_keys</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>ent_key</span> <span class=o>==</span> <span class=s2>&quot;name&quot;</span><span class=p>:</span>
                    <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                    <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                    <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_renamed</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>_ent_info</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;remove&quot;</span><span class=p>]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;move&quot;</span><span class=p>]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_added</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;add&quot;</span><span class=p>]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span> <span class=o>=</span> <span class=n>updated</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>debug_logs</span><span class=p>()</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Synchronization begins&quot;</span><span class=p>)</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>time_1</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
            <span class=c1># 1.) Process removed - may affect all other actions</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_removed</span><span class=p>()</span>
            <span class=n>time_2</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
            <span class=c1># 2.) Process renamed - may affect added</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_renamed</span><span class=p>()</span>
            <span class=n>time_3</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
            <span class=c1># 3.) Process added - moved entity may be moved to new entity</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_added</span><span class=p>()</span>
            <span class=n>time_4</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
            <span class=c1># 4.) Process moved</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_moved</span><span class=p>()</span>
            <span class=n>time_5</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
            <span class=c1># 5.) Process updated</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_updated</span><span class=p>()</span>
            <span class=n>time_6</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
            <span class=c1># 6.) Process changes in hierarchy or hier custom attribues</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_hier_cleanup</span><span class=p>()</span>
            <span class=n>time_7</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_task_updates</span><span class=p>()</span>
            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>update_entities</span><span class=p>()</span>
            <span class=n>time_8</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>

            <span class=n>time_removed</span> <span class=o>=</span> <span class=n>time_2</span> <span class=o>-</span> <span class=n>time_1</span>
            <span class=n>time_renamed</span> <span class=o>=</span> <span class=n>time_3</span> <span class=o>-</span> <span class=n>time_2</span>
            <span class=n>time_added</span> <span class=o>=</span> <span class=n>time_4</span> <span class=o>-</span> <span class=n>time_3</span>
            <span class=n>time_moved</span> <span class=o>=</span> <span class=n>time_5</span> <span class=o>-</span> <span class=n>time_4</span>
            <span class=n>time_updated</span> <span class=o>=</span> <span class=n>time_6</span> <span class=o>-</span> <span class=n>time_5</span>
            <span class=n>time_cleanup</span> <span class=o>=</span> <span class=n>time_7</span> <span class=o>-</span> <span class=n>time_6</span>
            <span class=n>time_task_updates</span> <span class=o>=</span> <span class=n>time_8</span> <span class=o>-</span> <span class=n>time_7</span>
            <span class=n>time_total</span> <span class=o>=</span> <span class=n>time_8</span> <span class=o>-</span> <span class=n>time_1</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                <span class=s2>&quot;Process time: </span><span class=si>{:.2f}</span><span class=s2> &lt;</span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, &quot;</span>
                <span class=s2>&quot;</span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>&gt;&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=n>time_total</span><span class=p>,</span> <span class=n>time_removed</span><span class=p>,</span> <span class=n>time_renamed</span><span class=p>,</span> <span class=n>time_added</span><span class=p>,</span>
                <span class=n>time_moved</span><span class=p>,</span> <span class=n>time_updated</span><span class=p>,</span> <span class=n>time_cleanup</span><span class=p>,</span> <span class=n>time_task_updates</span>
            <span class=p>))</span>

        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;An error has happened during synchronization&quot;</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;error&quot;</span><span class=p>][</span><span class=n>msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>((</span>
                <span class=nb>str</span><span class=p>(</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>())</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&lt;br&gt;&quot;</span><span class=p>)</span>
            <span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;&amp;nbsp;&quot;</span><span class=p>))</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>report</span><span class=p>()</span>
        <span class=k>return</span> <span class=kc>True</span>

    <span class=k>def</span><span class=w> </span><span class=nf>_get_username</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
        <span class=n>username</span> <span class=o>=</span> <span class=s2>&quot;Unknown&quot;</span>
        <span class=n>event_source</span> <span class=o>=</span> <span class=n>event</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;source&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>event_source</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>username</span>
        <span class=n>user_info</span> <span class=o>=</span> <span class=n>event_source</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;user&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>user_info</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>username</span>
        <span class=n>user_id</span> <span class=o>=</span> <span class=n>user_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;id&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>user_id</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>username</span>

        <span class=n>user_entity</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
            <span class=s2>&quot;User where id is </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>user_id</span><span class=p>)</span>
        <span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>user_entity</span><span class=p>:</span>
            <span class=n>username</span> <span class=o>=</span> <span class=n>user_entity</span><span class=p>[</span><span class=s2>&quot;username&quot;</span><span class=p>]</span> <span class=ow>or</span> <span class=n>username</span>
        <span class=k>return</span> <span class=n>username</span>


    <span class=k>def</span><span class=w> </span><span class=nf>process_removed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Handles removed entities (not removed tasks - handle separately).</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=n>ent_infos</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Processing removed entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ent_infos</span><span class=p>))</span>
        <span class=p>)</span>
        <span class=n>removable_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>recreate_ents</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>removed_names</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>removed</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>entity_type</span> <span class=o>=</span> <span class=n>removed</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>removed_name</span> <span class=o>=</span> <span class=n>removed</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>][</span><span class=s2>&quot;name&quot;</span><span class=p>][</span><span class=s2>&quot;old&quot;</span><span class=p>]</span>

            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_ent</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>changeability_by_mongo_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                <span class=n>removable_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>
                <span class=n>removed_names</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>removed_name</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>recreate_ents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>removable_ids</span><span class=p>:</span>
            <span class=c1># TODO logging</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Assets marked as archived &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>removed_names</span><span class=p>)</span>
            <span class=p>))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>update_many</span><span class=p>(</span>
                <span class=p>{</span><span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;$in&quot;</span><span class=p>:</span> <span class=n>removable_ids</span><span class=p>},</span> <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;asset&quot;</span><span class=p>},</span>
                <span class=p>{</span><span class=s2>&quot;$set&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;archived_asset&quot;</span><span class=p>}}</span>
            <span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>remove_cached_by_key</span><span class=p>(</span><span class=s2>&quot;id&quot;</span><span class=p>,</span> <span class=n>removable_ids</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>recreate_ents</span><span class=p>:</span>
            <span class=c1># sort removed entities by parents len</span>
            <span class=c1># - length of parents determine hierarchy level</span>
            <span class=n>recreate_ents</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
                <span class=n>recreate_ents</span><span class=p>,</span>
                <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>item</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span>
                    <span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;data&quot;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[])</span>
                <span class=p>))</span>
            <span class=p>)</span>
            <span class=c1># TODO logging</span>
            <span class=c1># TODO report</span>
            <span class=n>recreate_msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Deleted entity was recreated||Entity was recreated because&quot;</span>
                <span class=s2>&quot; it or its children contain published data&quot;</span>
            <span class=p>)</span>
            <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>
            <span class=k>for</span> <span class=n>avalon_entity</span> <span class=ow>in</span> <span class=n>recreate_ents</span><span class=p>:</span>
                <span class=n>old_ftrack_id</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
                <span class=n>vis_par</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>vis_par</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>vis_par</span> <span class=o>=</span> <span class=n>proj</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                <span class=n>parent_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span>

                <span class=n>parent_ftrack_id</span> <span class=o>=</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>handle_missing_ftrack_id</span><span class=p>(</span><span class=n>parent_ent</span><span class=p>)</span>
                    <span class=n>parent_ftrack_id</span> <span class=o>=</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
                    <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                        <span class=k>continue</span>

                <span class=n>parent_ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
                    <span class=n>parent_ftrack_id</span>
                <span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>parent_ftrack_ent</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
                        <span class=n>parent_ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
                    <span class=k>else</span><span class=p>:</span>
                        <span class=n>parent_ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                                <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>parent_ftrack_id</span>
                            <span class=p>)</span>
                        <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
                <span class=n>entity_type</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span>
                <span class=n>new_entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>entity_type</span><span class=p>,</span> <span class=p>{</span>
                    <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>],</span>
                    <span class=s2>&quot;parent&quot;</span><span class=p>:</span> <span class=n>parent_ftrack_ent</span>
                <span class=p>})</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
                <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                    <span class=c1># TODO logging</span>
                    <span class=c1># TODO report</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rolback</span><span class=p>()</span>
                    <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]]</span>
                    <span class=n>ent_path_items</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
                        <span class=n>par</span> <span class=k>for</span> <span class=n>par</span> <span class=ow>in</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>]</span>
                    <span class=p>])</span>
                    <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
                    <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>

                    <span class=n>error_msg</span> <span class=o>=</span> <span class=s2>&quot;Couldn&#39;t recreate entity in ftrack&quot;</span>
                    <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Trying to recreate because it or its children&quot;</span>
                        <span class=s2>&quot; contain published data&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>. Process session commit failed! &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                            <span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span>
                        <span class=p>),</span>
                        <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                    <span class=p>)</span>
                    <span class=k>continue</span>

                <span class=n>new_entity_id</span> <span class=o>=</span> <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
                <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_entity_id</span>

                <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
                    <span class=k>if</span> <span class=ow>not</span> <span class=n>val</span><span class=p>:</span>
                        <span class=k>continue</span>
                    <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>]:</span>
                        <span class=k>continue</span>

                    <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>

                <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=nb>str</span><span class=p>(</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>])</span>
                <span class=p>)</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>new_entity_id</span><span class=p>)</span>

                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
                <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                    <span class=c1># TODO logging</span>
                    <span class=c1># TODO report</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rolback</span><span class=p>()</span>
                    <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;Couldn&#39;t update custom attributes after recreation&quot;</span>
                        <span class=s2>&quot; of entity in ftrack&quot;</span>
                    <span class=p>)</span>
                    <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Entity was recreated because it or its children&quot;</span>
                        <span class=s2>&quot; contain published data&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>. Process session commit failed! &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                            <span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span>
                        <span class=p>),</span>
                        <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                    <span class=p>)</span>
                    <span class=k>continue</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;info&quot;</span><span class=p>][</span><span class=n>recreate_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span><span class=p>[</span><span class=n>old_ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_entity_id</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>

                <span class=n>found_idx</span> <span class=o>=</span> <span class=kc>None</span>
                <span class=n>proj_doc</span><span class=p>,</span> <span class=n>asset_docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span>
                <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>asset_doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>asset_docs</span><span class=p>):</span>
                    <span class=k>if</span> <span class=n>asset_doc</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]:</span>
                        <span class=n>found_idx</span> <span class=o>=</span> <span class=n>idx</span>
                        <span class=k>break</span>

                <span class=k>if</span> <span class=n>found_idx</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>continue</span>

                <span class=c1># Prepare updates dict for mongo update</span>
                <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]]:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=n>new_entity_id</span>
                <span class=p>)</span>
                <span class=c1># Update cached entities</span>
                <span class=n>asset_docs</span><span class=p>[</span><span class=n>found_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=n>proj_doc</span><span class=p>,</span> <span class=n>asset_docs</span>

                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>

                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>vis_par</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
                    <span class=n>children</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span>
                    <span class=n>found_idx</span> <span class=o>=</span> <span class=kc>None</span>
                    <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>_entity</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>children</span><span class=p>):</span>
                        <span class=k>if</span> <span class=n>_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]:</span>
                            <span class=n>found_idx</span> <span class=o>=</span> <span class=n>idx</span>
                            <span class=k>break</span>
                    <span class=n>children</span><span class=p>[</span><span class=n>found_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span> <span class=o>=</span> <span class=n>children</span>

                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>old_ftrack_id</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>new_entity_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=n>avalon_entity</span>
                    <span class=p>)</span>

                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>name</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>

        <span class=c1># Check if entities with same name can be synchronized</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>removed_names</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>check_names_synchronizable</span><span class=p>(</span><span class=n>removed_names</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>check_names_synchronizable</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>names</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;Check if entities with specific names are importable.</span>

<span class=sd>        This check should happend after removing entity or renaming entity.</span>
<span class=sd>        When entity was removed or renamed then it&#39;s name is possible to sync.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>joined_passed_names</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
            <span class=p>[</span><span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>names</span><span class=p>]</span>
        <span class=p>)</span>
        <span class=n>same_name_entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>entities_name_query_by_name</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joined_passed_names</span>
            <span class=p>)</span>
        <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>same_name_entities</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>entities_by_name</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>same_name_entities</span><span class=p>:</span>
            <span class=n>entities_by_name</span><span class=p>[</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entity</span><span class=p>)</span>

        <span class=n>synchronizable_ents</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
            <span class=s2>&quot;Deleting of entities should allow to synchronize another entities&quot;</span>
            <span class=s2>&quot; with same name.&quot;</span>
        <span class=p>))</span>
        <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>ents</span> <span class=ow>in</span> <span class=n>entities_by_name</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ents</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                    <span class=s2>&quot;Name </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> still have more than one entity &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                    <span class=n>name</span><span class=p>,</span> <span class=s2>&quot;| &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
                        <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>])</span> <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ents</span><span class=p>]</span>
                    <span class=p>)</span>
                <span class=p>))</span>
                <span class=k>continue</span>

            <span class=n>entity</span> <span class=o>=</span> <span class=n>ents</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
            <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>])</span>
            <span class=c1># TODO logging</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                <span class=s2>&quot;Checking if can synchronize entity &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=c1># skip if already synchronized</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                    <span class=s2>&quot;- Entity is already synchronized (skipping) &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>ent_path</span>
                    <span class=p>)</span>
                <span class=p>)</span>
                <span class=k>continue</span>

            <span class=n>parent_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>parent_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                    <span class=s2>&quot;- Entity&#39;s parent entity doesn&#39;t seems to&quot;</span>
                    <span class=s2>&quot; be synchronized (skipping) &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>))</span>
                <span class=k>continue</span>

            <span class=n>synchronizable_ents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entity</span><span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>synchronizable_ents</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>synchronizable_ents</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
            <span class=n>synchronizable_ents</span><span class=p>,</span>
            <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>entity</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]))</span>
        <span class=p>)</span>

        <span class=n>children_queue</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>synchronizable_ents</span><span class=p>:</span>
            <span class=n>parent_avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>[</span>
                <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
            <span class=p>]</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>create_entity_in_avalon</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span> <span class=n>parent_avalon_ent</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>child</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
                <span class=k>if</span> <span class=n>child</span><span class=o>.</span><span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>!=</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
                    <span class=n>children_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>child</span><span class=p>)</span>

        <span class=k>while</span> <span class=n>children_queue</span><span class=p>:</span>
            <span class=n>entity</span> <span class=o>=</span> <span class=n>children_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
            <span class=n>name</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=n>ent_by_ftrack_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>ent_by_ftrack_id</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>((</span>
                    <span class=s2>&quot;This is bug, parent was just synchronized to avalon&quot;</span>
                    <span class=s2>&quot; but entity is already in database </span><span class=si>{}</span><span class=s2>&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=n>entity</span><span class=p>)))</span>

            <span class=c1># Entity has duplicated name with another entity</span>
            <span class=c1># - may be renamed: in that case renaming method will handle that</span>
            <span class=n>duplicate_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_name</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>duplicate_ent</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>passed_regex</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>check_regex</span><span class=p>(</span>
                <span class=n>name</span><span class=p>,</span> <span class=s2>&quot;asset&quot;</span><span class=p>,</span> <span class=n>schema_patterns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>passed_regex</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>parent_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
            <span class=n>parent_avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>parent_id</span><span class=p>]</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>create_entity_in_avalon</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span> <span class=n>parent_avalon_ent</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>child</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
                <span class=k>if</span> <span class=n>child</span><span class=o>.</span><span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
                    <span class=k>continue</span>
                <span class=n>children_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>child</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>create_entity_in_avalon</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ftrack_ent</span><span class=p>,</span> <span class=n>parent_avalon</span><span class=p>):</span>
        <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>

        <span class=c1># Parents, Hierarchy</span>
        <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]]</span>
        <span class=n>parents</span> <span class=o>=</span> <span class=n>ent_path_items</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=nb>len</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span>

        <span class=c1># TODO logging</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Trying to synchronize entity &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>
            <span class=p>)</span>
        <span class=p>)</span>

        <span class=c1># Add entity to modified so tasks are added at the end</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>])</span>

        <span class=c1># Visual Parent</span>
        <span class=n>vis_par</span> <span class=o>=</span> <span class=kc>None</span>
        <span class=k>if</span> <span class=n>parent_avalon</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>!=</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
            <span class=n>vis_par</span> <span class=o>=</span> <span class=n>parent_avalon</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>

        <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>ObjectId</span><span class=p>()</span>
        <span class=n>name</span> <span class=o>=</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
        <span class=n>final_entity</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>mongo_id</span><span class=p>,</span>
            <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>name</span><span class=p>,</span>
            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;asset&quot;</span><span class=p>,</span>
            <span class=s2>&quot;schema&quot;</span><span class=p>:</span> <span class=n>CURRENT_ASSET_DOC_SCHEMA</span><span class=p>,</span>
            <span class=s2>&quot;parent&quot;</span><span class=p>:</span> <span class=n>proj</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>],</span>
            <span class=s2>&quot;data&quot;</span><span class=p>:</span> <span class=p>{</span>
                <span class=s2>&quot;ftrackId&quot;</span><span class=p>:</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span>
                <span class=s2>&quot;entityType&quot;</span><span class=p>:</span> <span class=n>ftrack_ent</span><span class=o>.</span><span class=n>entity_type</span><span class=p>,</span>
                <span class=s2>&quot;parents&quot;</span><span class=p>:</span> <span class=n>parents</span><span class=p>,</span>
                <span class=s2>&quot;tasks&quot;</span><span class=p>:</span> <span class=p>{},</span>
                <span class=s2>&quot;visualParent&quot;</span><span class=p>:</span> <span class=n>vis_par</span><span class=p>,</span>
                <span class=s2>&quot;description&quot;</span><span class=p>:</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;description&quot;</span><span class=p>]</span>
            <span class=p>}</span>
        <span class=p>}</span>
        <span class=n>invalid_fps_items</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>cust_attrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_cust_attr_values</span><span class=p>(</span><span class=n>ftrack_ent</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>cust_attrs</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;avalon_&quot;</span><span class=p>):</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>FPS_KEYS</span><span class=p>:</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>val</span> <span class=o>=</span> <span class=n>convert_to_fps</span><span class=p>(</span><span class=n>val</span><span class=p>)</span>
                <span class=k>except</span> <span class=n>InvalidFpsValue</span><span class=p>:</span>
                    <span class=n>invalid_fps_items</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>val</span><span class=p>))</span>
                    <span class=k>continue</span>

            <span class=n>final_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>

        <span class=k>if</span> <span class=n>invalid_fps_items</span><span class=p>:</span>
            <span class=n>fps_msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;These entities have invalid fps value in custom attributes&quot;</span>
            <span class=p>)</span>
            <span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>entity_id</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>invalid_fps_items</span><span class=p>:</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>entity_id</span><span class=p>)</span>
                <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> - </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>,</span> <span class=n>value</span><span class=p>))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;error&quot;</span><span class=p>][</span><span class=n>fps_msg</span><span class=p>]</span> <span class=o>=</span> <span class=n>items</span>

        <span class=n>_mongo_id_str</span> <span class=o>=</span> <span class=n>cust_attrs</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>_mongo_id_str</span><span class=p>:</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=n>_mongo_id</span> <span class=o>=</span> <span class=n>ObjectId</span><span class=p>(</span><span class=n>_mongo_id_str</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>_mongo_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>:</span>
                    <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>_mongo_id</span>
                    <span class=n>final_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>mongo_id</span>

            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                <span class=k>pass</span>

        <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]]</span>
        <span class=n>ent_path_items</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=n>par</span> <span class=k>for</span> <span class=n>par</span> <span class=ow>in</span> <span class=n>parents</span><span class=p>])</span>
        <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
        <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=n>schema</span><span class=o>.</span><span class=n>validate</span><span class=p>(</span><span class=n>final_entity</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
            <span class=c1># TODO logging</span>
            <span class=c1># TODO report</span>
            <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Schema validation failed for new entity (This is a bug)&quot;</span>
            <span class=p>)</span>
            <span class=n>error_traceback</span> <span class=o>=</span> <span class=p>(</span>
                <span class=nb>str</span><span class=p>(</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>())</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&lt;br&gt;&quot;</span><span class=p>)</span>
            <span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;&amp;nbsp;&quot;</span><span class=p>)</span>

            <span class=n>item_msg</span> <span class=o>=</span> <span class=n>ent_path</span> <span class=o>+</span> <span class=s2>&quot;&lt;br&gt;&quot;</span> <span class=o>+</span> <span class=n>error_traceback</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;error&quot;</span><span class=p>][</span><span class=n>error_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item_msg</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
                <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>: </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=nb>str</span><span class=p>(</span><span class=n>final_entity</span><span class=p>)),</span>
                <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
            <span class=p>)</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=n>replaced</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=n>archived</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_archived_by_name</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>archived</span><span class=p>:</span>
            <span class=n>archived_id</span> <span class=o>=</span> <span class=n>archived</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=p>(</span>
                <span class=n>archived</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>parents</span> <span class=ow>or</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>changeability_by_mongo_id</span><span class=p>[</span><span class=n>archived_id</span><span class=p>]</span>
            <span class=p>):</span>
                <span class=c1># TODO logging</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                    <span class=s2>&quot;Entity was unarchived instead of creation &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>ent_path</span>
                    <span class=p>)</span>
                <span class=p>)</span>
                <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>archived_id</span>
                <span class=n>final_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>mongo_id</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>replace_one</span><span class=p>({</span><span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>mongo_id</span><span class=p>},</span> <span class=n>final_entity</span><span class=p>)</span>
                <span class=n>replaced</span> <span class=o>=</span> <span class=kc>True</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>replaced</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>insert_one</span><span class=p>(</span><span class=n>final_entity</span><span class=p>)</span>
            <span class=c1># TODO logging</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Entity was synchronized &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>))</span>

        <span class=n>mongo_id_str</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>mongo_id_str</span> <span class=o>!=</span> <span class=p>(</span>
            <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>]</span>
        <span class=p>):</span>
            <span class=p>(</span>
                <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>]</span>
            <span class=p>)</span> <span class=o>=</span> <span class=n>mongo_id_str</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rolback</span><span class=p>()</span>
                <span class=c1># TODO logging</span>
                <span class=c1># TODO report</span>
                <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;Failed to store MongoID to entity&#39;s custom attribute&quot;</span>
                <span class=p>)</span>
                <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||SyncToAvalon action may solve this issue&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>: </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>),</span>
                    <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                <span class=p>)</span>

        <span class=c1># modify cached data</span>
        <span class=c1># Skip if self._avalon_ents is not set(maybe never happen)</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>final_entity</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span>
            <span class=n>ents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>final_entity</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=p>(</span><span class=n>proj</span><span class=p>,</span> <span class=n>ents</span><span class=p>)</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>final_entity</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>final_entity</span><span class=p>)</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>final_entity</span>

        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=p>[</span><span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>final_entity</span>

        <span class=k>return</span> <span class=n>final_entity</span>

    <span class=k>def</span><span class=w> </span><span class=nf>get_cust_attr_values</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>entity</span><span class=p>):</span>
        <span class=n>output</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>custom_attrs</span><span class=p>,</span> <span class=n>hier_attrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_cust_attrs</span>

        <span class=c1># Notmal custom attributes</span>
        <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>custom_attrs</span><span class=p>:</span>
            <span class=n>key</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>]:</span>
                <span class=n>output</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span>

        <span class=n>hier_values</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>get_hierarchical_attributes_values</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=p>,</span>
            <span class=n>entity</span><span class=p>,</span>
            <span class=n>hier_attrs</span><span class=p>,</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>cust_attr_types_by_id</span><span class=o>.</span><span class=n>values</span><span class=p>()</span>
        <span class=p>)</span>
        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>hier_values</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>output</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>

        <span class=c1># Make sure mongo id is not set</span>
        <span class=n>output</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>

        <span class=k>return</span> <span class=n>output</span>

    <span class=k>def</span><span class=w> </span><span class=nf>process_renamed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>ent_infos</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_renamed</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>ent_infos</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Processing renamed entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ent_infos</span><span class=p>))</span>
        <span class=p>)</span>

        <span class=n>changeable_queue</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>entity_type</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>entity_type</span> <span class=o>==</span> <span class=s2>&quot;Task&quot;</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>new_name</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>][</span><span class=s2>&quot;name&quot;</span><span class=p>][</span><span class=s2>&quot;new&quot;</span><span class=p>]</span>
            <span class=n>old_name</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>][</span><span class=s2>&quot;name&quot;</span><span class=p>][</span><span class=s2>&quot;old&quot;</span><span class=p>]</span>

            <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_ent</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                    <span class=s2>&quot;Entity is not is avalon. Moving to </span><span class=se>\&quot;</span><span class=s2>add</span><span class=se>\&quot;</span><span class=s2> process. &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>))</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_added</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ent_info</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=n>new_name</span> <span class=o>==</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]:</span>
                <span class=c1># TODO logging</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                    <span class=s2>&quot;Avalon entity already has the same name &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>))</span>
                <span class=k>continue</span>

            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>changeability_by_mongo_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                <span class=n>changeable_queue</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>ftrack_id</span><span class=p>,</span> <span class=n>avalon_ent</span><span class=p>,</span> <span class=n>new_name</span><span class=p>))</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
                <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
                    <span class=c1># TODO logging</span>
                    <span class=c1># TODO report</span>
                    <span class=n>error_msg</span> <span class=o>=</span> <span class=s2>&quot;Entity renamed back&quot;</span>
                    <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||It is not possible to change&quot;</span>
                        <span class=s2>&quot; the name of an entity or it&#39;s parents, &quot;</span>
                        <span class=s2>&quot; if it already contained published data.&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;info&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>))</span>

                <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
                    <span class=c1># TODO report</span>
                    <span class=c1># TODO logging</span>
                    <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;Couldn&#39;t rename the entity back to its original name&quot;</span>
                    <span class=p>)</span>
                    <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Renamed because it is not possible to&quot;</span>
                        <span class=s2>&quot; change the name of an entity or it&#39;s parents, &quot;</span>
                        <span class=s2>&quot; if it already contained published data.&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                    <span class=n>error_traceback</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=nb>str</span><span class=p>(</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>())</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&lt;br&gt;&quot;</span><span class=p>)</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;&amp;nbsp;&quot;</span><span class=p>)</span>

                    <span class=n>item_msg</span> <span class=o>=</span> <span class=n>ent_path</span> <span class=o>+</span> <span class=s2>&quot;&lt;br&gt;&quot;</span> <span class=o>+</span> <span class=n>error_traceback</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item_msg</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>: </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>),</span>
                        <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                    <span class=p>)</span>

        <span class=n>old_names</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=c1># Process renaming in Avalon DB</span>
        <span class=k>while</span> <span class=n>changeable_queue</span><span class=p>:</span>
            <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>avalon_ent</span><span class=p>,</span> <span class=n>new_name</span> <span class=o>=</span> <span class=n>changeable_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=n>old_name</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>

            <span class=n>_entity_type</span> <span class=o>=</span> <span class=s2>&quot;asset&quot;</span>
            <span class=k>if</span> <span class=n>entity_type</span> <span class=o>==</span> <span class=s2>&quot;Project&quot;</span><span class=p>:</span>
                <span class=n>_entity_type</span> <span class=o>=</span> <span class=s2>&quot;project&quot;</span>

            <span class=n>passed_regex</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>check_regex</span><span class=p>(</span>
                <span class=n>new_name</span><span class=p>,</span> <span class=n>_entity_type</span><span class=p>,</span> <span class=n>schema_patterns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>passed_regex</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=k>continue</span>

            <span class=c1># if avalon does not have same name then can be changed</span>
            <span class=n>same_name_avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_name</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>new_name</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>same_name_avalon_ent</span><span class=p>:</span>
                <span class=n>old_val</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>old_name</span><span class=p>)</span>
                <span class=n>old_val</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_name</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=p>[</span><span class=n>new_name</span><span class=p>]</span> <span class=o>=</span> <span class=n>old_val</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>new_name</span><span class=p>}</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>renamed_in_avalon</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>

                <span class=n>old_names</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>old_name</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>new_name</span> <span class=ow>in</span> <span class=n>old_names</span><span class=p>:</span>
                    <span class=n>old_names</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>new_name</span><span class=p>)</span>

                <span class=c1># TODO logging</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                    <span class=s2>&quot;Name of entity will be changed to </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>new_name</span><span class=p>,</span> <span class=n>ent_path</span>
                    <span class=p>)</span>
                <span class=p>)</span>
                <span class=k>continue</span>

            <span class=c1># Check if same name is in changable_queue</span>
            <span class=c1># - it&#39;s name may be changed in next iteration</span>
            <span class=n>same_name_ftrack_id</span> <span class=o>=</span> <span class=n>same_name_avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
            <span class=n>same_is_unprocessed</span> <span class=o>=</span> <span class=kc>False</span>
            <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>changeable_queue</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>same_name_ftrack_id</span> <span class=o>==</span> <span class=n>item</span><span class=p>[</span><span class=mi>0</span><span class=p>]:</span>
                    <span class=n>same_is_unprocessed</span> <span class=o>=</span> <span class=kc>True</span>
                    <span class=k>break</span>

            <span class=k>if</span> <span class=n>same_is_unprocessed</span><span class=p>:</span>
                <span class=n>changeable_queue</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>ftrack_id</span><span class=p>,</span> <span class=n>avalon_ent</span><span class=p>,</span> <span class=n>new_name</span><span class=p>))</span>
                <span class=k>continue</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>duplicated</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>old_names</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>check_names_synchronizable</span><span class=p>(</span><span class=n>old_names</span><span class=p>)</span>

        <span class=c1># not_found are not processed since all not found are</span>
        <span class=c1># not found because they are not synchronizable</span>

    <span class=k>def</span><span class=w> </span><span class=nf>process_added</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>ent_infos</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_added</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>ent_infos</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Processing added entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ent_infos</span><span class=p>))</span>
        <span class=p>)</span>

        <span class=n>cust_attrs</span><span class=p>,</span> <span class=n>hier_attrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_cust_attrs</span>
        <span class=n>entity_type_conf_ids</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=c1># Skip if already exit in avalon db or tasks entities</span>
        <span class=c1># - happen when was created by any sync event/action</span>
        <span class=n>pop_out_ents</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>):</span>
                <span class=n>pop_out_ents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                    <span class=s2>&quot;Added entity is already synchronized &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                    <span class=p>)</span>
                <span class=p>)</span>
                <span class=k>continue</span>

            <span class=n>entity_type</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>entity_type</span> <span class=o>==</span> <span class=s2>&quot;Task&quot;</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>name</span> <span class=o>=</span> <span class=p>(</span>
                <span class=n>ent_info</span>
                <span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;changes&quot;</span><span class=p>,</span> <span class=p>{})</span>
                <span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;name&quot;</span><span class=p>,</span> <span class=p>{})</span>
                <span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;new&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=n>avalon_ent_by_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_name</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=ow>or</span> <span class=p>{}</span>
            <span class=n>avalon_ent_by_name_ftrack_id</span> <span class=o>=</span> <span class=p>(</span>
                <span class=n>avalon_ent_by_name</span>
                <span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;data&quot;</span><span class=p>,</span> <span class=p>{})</span>
                <span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=n>avalon_ent_by_name</span> <span class=ow>and</span> <span class=n>avalon_ent_by_name_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>ftrack_ent</span><span class=p>:</span>
                    <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>ftrack_id</span>
                        <span class=p>)</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_ent</span>

                <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]]</span>
                <span class=n>parents</span> <span class=o>=</span> <span class=n>ent_path_items</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=nb>len</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span>

                <span class=n>avalon_ent_parents</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=n>avalon_ent_by_name</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;data&quot;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>)</span>
                <span class=p>)</span>
                <span class=k>if</span> <span class=n>parents</span> <span class=o>==</span> <span class=n>avalon_ent_parents</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>update_one</span><span class=p>({</span>
                        <span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>avalon_ent_by_name</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                    <span class=p>},</span> <span class=p>{</span>
                        <span class=s2>&quot;$set&quot;</span><span class=p>:</span> <span class=p>{</span>
                            <span class=s2>&quot;data.ftrackId&quot;</span><span class=p>:</span> <span class=n>ftrack_id</span><span class=p>,</span>
                            <span class=s2>&quot;data.entityType&quot;</span><span class=p>:</span> <span class=n>entity_type</span>
                        <span class=p>}</span>
                    <span class=p>})</span>

                    <span class=n>avalon_ent_by_name</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>
                    <span class=n>avalon_ent_by_name</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>entity_type</span>

                    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=n>avalon_ent_by_name</span>
                    <span class=p>)</span>
                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>:</span>
                        <span class=n>found</span> <span class=o>=</span> <span class=kc>None</span>
                        <span class=k>for</span> <span class=n>_parent_id_</span><span class=p>,</span> <span class=n>_entities_</span> <span class=ow>in</span> <span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
                        <span class=p>):</span>
                            <span class=k>for</span> <span class=n>_idx_</span><span class=p>,</span> <span class=n>entity</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>_entities_</span><span class=p>):</span>
                                <span class=k>if</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>avalon_ent_by_name</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]:</span>
                                    <span class=n>found</span> <span class=o>=</span> <span class=p>(</span><span class=n>_parent_id_</span><span class=p>,</span> <span class=n>_idx_</span><span class=p>)</span>
                                    <span class=k>break</span>

                            <span class=k>if</span> <span class=n>found</span><span class=p>:</span>
                                <span class=k>break</span>

                        <span class=k>if</span> <span class=n>found</span><span class=p>:</span>
                            <span class=n>_parent_id_</span><span class=p>,</span> <span class=n>_idx_</span> <span class=o>=</span> <span class=n>found</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>_parent_id_</span><span class=p>][</span>
                                <span class=n>_idx_</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_ent_by_name</span>

                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=p>:</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=p>[</span><span class=n>avalon_ent_by_name</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=p>(</span>
                            <span class=n>avalon_ent_by_name</span>
                        <span class=p>)</span>

                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=p>:</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_ent_by_name</span>

                    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span><span class=p>:</span>
                        <span class=n>found</span> <span class=o>=</span> <span class=kc>None</span>
                        <span class=n>project</span><span class=p>,</span> <span class=n>entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span>
                        <span class=k>for</span> <span class=n>_idx_</span><span class=p>,</span> <span class=n>_ent_</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>entities</span><span class=p>):</span>
                            <span class=k>if</span> <span class=n>_ent_</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=n>avalon_ent_by_name</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]:</span>
                                <span class=k>continue</span>
                            <span class=n>found</span> <span class=o>=</span> <span class=n>_idx_</span>
                            <span class=k>break</span>

                        <span class=k>if</span> <span class=n>found</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                            <span class=n>entities</span><span class=p>[</span><span class=n>found</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_ent_by_name</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=n>project</span><span class=p>,</span> <span class=n>entities</span>

                    <span class=n>pop_out_ents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                    <span class=k>continue</span>

            <span class=n>mongo_id_configuration_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mongo_id_configuration</span><span class=p>(</span>
                <span class=n>ent_info</span><span class=p>,</span>
                <span class=n>cust_attrs</span><span class=p>,</span>
                <span class=n>hier_attrs</span><span class=p>,</span>
                <span class=n>entity_type_conf_ids</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>mongo_id_configuration_id</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>((</span>
                    <span class=s2>&quot;BUG REPORT: Missing MongoID configuration for `</span><span class=si>{}</span><span class=s2> &lt; </span><span class=si>{}</span><span class=s2> &gt;`&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>entity_type</span><span class=p>,</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]))</span>
                <span class=k>continue</span>

            <span class=n>_entity_key</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>OrderedDict</span><span class=p>()</span>
            <span class=n>_entity_key</span><span class=p>[</span><span class=s2>&quot;configuration_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>mongo_id_configuration_id</span>
            <span class=n>_entity_key</span><span class=p>[</span><span class=s2>&quot;entity_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>recorded_operations</span><span class=o>.</span><span class=n>push</span><span class=p>(</span>
                <span class=n>ftrack_api</span><span class=o>.</span><span class=n>operation</span><span class=o>.</span><span class=n>UpdateEntityOperation</span><span class=p>(</span>
                    <span class=s2>&quot;ContextCustomAttributeValue&quot;</span><span class=p>,</span>
                    <span class=n>_entity_key</span><span class=p>,</span>
                    <span class=s2>&quot;value&quot;</span><span class=p>,</span>
                    <span class=n>ftrack_api</span><span class=o>.</span><span class=n>symbol</span><span class=o>.</span><span class=n>NOT_SET</span><span class=p>,</span>
                    <span class=s2>&quot;&quot;</span>
                <span class=p>)</span>
            <span class=p>)</span>

        <span class=k>try</span><span class=p>:</span>
            <span class=c1># Commit changes of mongo_id to empty string</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Committing unsetting&quot;</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
            <span class=c1># TODO logging</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Could not set value of Custom attribute, where mongo id&quot;</span>
                <span class=s2>&quot; is stored, to empty string. ftrack ids: </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_infos</span><span class=o>.</span><span class=n>keys</span><span class=p>()))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>pop_out_ents</span><span class=p>:</span>
            <span class=n>ent_infos</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>

        <span class=c1># sort by parents length (same as by hierarchy level)</span>
        <span class=n>_ent_infos</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
            <span class=n>ent_infos</span><span class=o>.</span><span class=n>values</span><span class=p>(),</span>
            <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>ent_info</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>,</span> <span class=p>[])))</span>
        <span class=p>)</span>
        <span class=n>to_sync_by_id</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>OrderedDict</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>_ent_infos</span><span class=p>:</span>
            <span class=n>ft_id</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityId&quot;</span><span class=p>]</span>
            <span class=n>to_sync_by_id</span><span class=p>[</span><span class=n>ft_id</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ft_id</span><span class=p>]</span>

        <span class=c1># cache regex success (for tasks)</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>to_sync_by_id</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=n>entity</span><span class=o>.</span><span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
                <span class=k>raise</span> <span class=ne>Exception</span><span class=p>((</span>
                    <span class=s2>&quot;Project can&#39;t be created with event handler!&quot;</span>
                    <span class=s2>&quot;This is a bug&quot;</span>
                <span class=p>))</span>
            <span class=n>parent_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
            <span class=n>parent_avalon</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>parent_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>parent_avalon</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                    <span class=s2>&quot;Skipping synchronization of entity&quot;</span>
                    <span class=s2>&quot; because parent was not found in Avalon DB &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)))</span>
                <span class=k>continue</span>

            <span class=n>is_synchonizable</span> <span class=o>=</span> <span class=kc>True</span>
            <span class=n>name</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=n>passed_regex</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>check_regex</span><span class=p>(</span>
                <span class=n>name</span><span class=p>,</span> <span class=s2>&quot;asset&quot;</span><span class=p>,</span> <span class=n>schema_patterns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>passed_regex</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=n>is_synchonizable</span> <span class=o>=</span> <span class=kc>False</span>

            <span class=k>if</span> <span class=n>name</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_name</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>duplicated</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=n>is_synchonizable</span> <span class=o>=</span> <span class=kc>False</span>

            <span class=k>if</span> <span class=ow>not</span> <span class=n>is_synchonizable</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>create_entity_in_avalon</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span> <span class=n>parent_avalon</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>process_moved</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Handles moved entities to different place in hiearchy.</span>
<span class=sd>            (Not tasks - handled separately.)</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Processing moved entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span><span class=p>))</span>
        <span class=p>)</span>

        <span class=n>ftrack_moved</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span>
            <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>line</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span>
                <span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;data&quot;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[])</span>
            <span class=p>))</span>
        <span class=p>)}</span>

        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ftrack_moved</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_ent</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>new_parent_id</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>][</span><span class=s2>&quot;parent_id&quot;</span><span class=p>][</span><span class=s2>&quot;new&quot;</span><span class=p>]</span>

            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>changeability_by_mongo_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                <span class=n>par_av_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>new_parent_id</span><span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>par_av_ent</span><span class=p>:</span>
                    <span class=c1># TODO logging</span>
                    <span class=c1># TODO report</span>
                    <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]]</span>
                    <span class=n>ent_path_items</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>])</span>
                    <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
                    <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>

                    <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;New parent of entity is not synchronized to avalon&quot;</span>
                    <span class=p>)</span>
                    <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Parent in Avalon can&#39;t be changed. That&quot;</span>
                        <span class=s2>&quot; may cause issues. Please fix parent or move entity&quot;</span>
                        <span class=s2>&quot; under valid entity.&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>

                    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>))</span>
                    <span class=k>continue</span>

                <span class=c1># THIS MUST HAPPEND AFTER CREATING NEW ENTITIES !!!!</span>
                <span class=c1># - because may be moved to new created entity</span>
                <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

                <span class=n>vis_par_id</span> <span class=o>=</span> <span class=kc>None</span>
                <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]]</span>
                <span class=k>if</span> <span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>!=</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
                    <span class=n>vis_par_id</span> <span class=o>=</span> <span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                    <span class=n>ent_path_items</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>])</span>
                    <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>vis_par_id</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>moved_in_avalon</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>

                <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                    <span class=s2>&quot;Parent of entity (</span><span class=si>{}</span><span class=s2>) was changed in avalon &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>),</span> <span class=n>ent_path</span><span class=p>)</span>
                <span class=p>)</span>

            <span class=k>else</span><span class=p>:</span>
                <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
                <span class=n>avalon_parent_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>avalon_parent_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>avalon_parent_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;parent&quot;</span><span class=p>]</span>

                <span class=n>avalon_parent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>avalon_parent_id</span><span class=p>]</span>
                <span class=n>parent_id</span> <span class=o>=</span> <span class=n>avalon_parent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>

                <span class=c1># For cases when parent was deleted at the same time</span>
                <span class=k>if</span> <span class=n>parent_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span><span class=p>:</span>
                    <span class=n>parent_id</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span><span class=p>[</span><span class=n>parent_id</span><span class=p>]</span>
                    <span class=p>)</span>

                <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>ftrack_ent</span><span class=p>:</span>
                    <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>ftrack_id</span>
                        <span class=p>)</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_ent</span>

                <span class=k>if</span> <span class=n>parent_id</span> <span class=o>==</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]:</span>
                    <span class=k>continue</span>

                <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>parent_id</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
                    <span class=c1># TODO logging</span>
                    <span class=c1># TODO report</span>
                    <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;Entity was moved back&quot;</span>
                    <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Entity can&#39;t be moved when&quot;</span>
                        <span class=s2>&quot; it or its children contain published data&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
                    <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;info&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>))</span>

                <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
                    <span class=c1># TODO logging</span>
                    <span class=c1># TODO report</span>
                    <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;Couldn&#39;t moved the entity back to its original parent&quot;</span>
                    <span class=p>)</span>
                    <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Moved back because it is not possible to&quot;</span>
                        <span class=s2>&quot; move with an entity or it&#39;s parents, &quot;</span>
                        <span class=s2>&quot; if it already contained published data.&quot;</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                    <span class=n>error_traceback</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=nb>str</span><span class=p>(</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>())</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&lt;br&gt;&quot;</span><span class=p>)</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;&amp;nbsp;&quot;</span><span class=p>)</span>

                    <span class=n>item_msg</span> <span class=o>=</span> <span class=n>ent_path</span> <span class=o>+</span> <span class=s2>&quot;&lt;br&gt;&quot;</span> <span class=o>+</span> <span class=n>error_traceback</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item_msg</span><span class=p>)</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                        <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>: </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>),</span>
                        <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                    <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>process_updated</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Only custom attributes changes should get here</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Processing updated entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span><span class=p>))</span>
        <span class=p>)</span>

        <span class=n>ent_infos</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span>
        <span class=n>ftrack_mongo_mapping</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>not_found_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_ent</span><span class=p>:</span>
                <span class=n>not_found_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=k>continue</span>

            <span class=n>ftrack_mongo_mapping</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>

        <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>not_found_ids</span><span class=p>:</span>
            <span class=n>ent_infos</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>ent_infos</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>cust_attrs</span><span class=p>,</span> <span class=n>hier_attrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_cust_attrs</span>
        <span class=n>hier_attrs_by_key</span> <span class=o>=</span> <span class=p>{</span>
            <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]:</span> <span class=n>attr</span>
            <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>hier_attrs</span>
        <span class=p>}</span>
        <span class=n>cust_attrs_by_obj_id</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>cust_attr</span> <span class=ow>in</span> <span class=n>cust_attrs</span><span class=p>:</span>
            <span class=n>key</span> <span class=o>=</span> <span class=n>cust_attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;avalon_&quot;</span><span class=p>):</span>
                <span class=k>continue</span>

            <span class=n>ca_ent_type</span> <span class=o>=</span> <span class=n>cust_attr</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>

            <span class=k>if</span> <span class=n>ca_ent_type</span> <span class=o>==</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
                <span class=n>cust_attrs_by_obj_id</span><span class=p>[</span><span class=n>ca_ent_type</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>cust_attr</span>

            <span class=k>elif</span> <span class=n>ca_ent_type</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
                <span class=n>obj_id</span> <span class=o>=</span> <span class=n>cust_attr</span><span class=p>[</span><span class=s2>&quot;object_type_id&quot;</span><span class=p>]</span>
                <span class=n>cust_attrs_by_obj_id</span><span class=p>[</span><span class=n>obj_id</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>cust_attr</span>

        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>ftrack_mongo_mapping</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
            <span class=n>entType</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span>
            <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>entType</span> <span class=o>==</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
                <span class=n>ent_cust_attrs</span> <span class=o>=</span> <span class=n>cust_attrs_by_obj_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;show&quot;</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>obj_type_id</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;objectTypeId&quot;</span><span class=p>]</span>
                <span class=n>ent_cust_attrs</span> <span class=o>=</span> <span class=n>cust_attrs_by_obj_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>obj_type_id</span><span class=p>)</span>

            <span class=c1># ftrack&#39;s entity_type does not have defined custom attributes</span>
            <span class=k>if</span> <span class=n>ent_cust_attrs</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>ent_cust_attrs</span> <span class=o>=</span> <span class=p>{}</span>

            <span class=n>ent_changes</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=s2>&quot;description&quot;</span> <span class=ow>in</span> <span class=n>ent_changes</span><span class=p>:</span>
                <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;description&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=n>ent_changes</span><span class=p>[</span><span class=s2>&quot;description&quot;</span><span class=p>][</span><span class=s2>&quot;new&quot;</span><span class=p>]</span> <span class=ow>or</span> <span class=s2>&quot;&quot;</span>
                <span class=p>)</span>

            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>values</span> <span class=ow>in</span> <span class=n>ent_changes</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
                <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>hier_attrs_by_key</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>hier_cust_attrs_changes</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                    <span class=k>continue</span>

                <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ent_cust_attrs</span><span class=p>:</span>
                    <span class=k>continue</span>

                <span class=n>value</span> <span class=o>=</span> <span class=n>values</span><span class=p>[</span><span class=s2>&quot;new&quot;</span><span class=p>]</span>
                <span class=n>new_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert_value_by_cust_attr_conf</span><span class=p>(</span>
                    <span class=n>value</span><span class=p>,</span> <span class=n>ent_cust_attrs</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
                <span class=p>)</span>

                <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_value</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                    <span class=s2>&quot;Setting data value of </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> to </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>key</span><span class=p>,</span> <span class=n>new_value</span><span class=p>,</span> <span class=n>ent_path</span>
                    <span class=p>)</span>
                <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>convert_value_by_cust_attr_conf</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>cust_attr_conf</span><span class=p>):</span>
        <span class=n>type_id</span> <span class=o>=</span> <span class=n>cust_attr_conf</span><span class=p>[</span><span class=s2>&quot;type_id&quot;</span><span class=p>]</span>
        <span class=n>cust_attr_type_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cust_attr_types_by_id</span><span class=p>[</span><span class=n>type_id</span><span class=p>][</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
        <span class=n>ignored</span> <span class=o>=</span> <span class=p>(</span>
            <span class=s2>&quot;expression&quot;</span><span class=p>,</span> <span class=s2>&quot;notificationtype&quot;</span><span class=p>,</span> <span class=s2>&quot;dynamic enumerator&quot;</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=n>cust_attr_type_name</span> <span class=ow>in</span> <span class=n>ignored</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>None</span>

        <span class=k>if</span> <span class=n>cust_attr_type_name</span> <span class=o>==</span> <span class=s2>&quot;text&quot;</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>value</span>

        <span class=k>if</span> <span class=n>cust_attr_type_name</span> <span class=o>==</span> <span class=s2>&quot;boolean&quot;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>value</span> <span class=o>==</span> <span class=s2>&quot;1&quot;</span><span class=p>:</span>
                <span class=k>return</span> <span class=kc>True</span>
            <span class=k>if</span> <span class=n>value</span> <span class=o>==</span> <span class=s2>&quot;0&quot;</span><span class=p>:</span>
                <span class=k>return</span> <span class=kc>False</span>
            <span class=k>return</span> <span class=nb>bool</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>cust_attr_type_name</span> <span class=o>==</span> <span class=s2>&quot;date&quot;</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>arrow</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>

        <span class=n>cust_attr_config</span> <span class=o>=</span> <span class=n>json</span><span class=o>.</span><span class=n>loads</span><span class=p>(</span><span class=n>cust_attr_conf</span><span class=p>[</span><span class=s2>&quot;config&quot;</span><span class=p>])</span>

        <span class=k>if</span> <span class=n>cust_attr_type_name</span> <span class=o>==</span> <span class=s2>&quot;number&quot;</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>cust_attr_config</span><span class=p>[</span><span class=s2>&quot;isdecimal&quot;</span><span class=p>]:</span>
                <span class=k>return</span> <span class=nb>float</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
            <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>cust_attr_type_name</span> <span class=o>==</span> <span class=s2>&quot;enumerator&quot;</span><span class=p>:</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>cust_attr_config</span><span class=p>[</span><span class=s2>&quot;multiSelect&quot;</span><span class=p>]:</span>
                <span class=k>return</span> <span class=n>value</span>
            <span class=k>return</span> <span class=n>value</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;, &quot;</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>value</span>

    <span class=k>def</span><span class=w> </span><span class=nf>process_hier_cleanup</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=p>(</span>
            <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>moved_in_avalon</span> <span class=ow>and</span>
            <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>renamed_in_avalon</span> <span class=ow>and</span>
            <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>hier_cust_attrs_changes</span>
        <span class=p>):</span>
            <span class=k>return</span>

        <span class=n>parent_changes</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>hier_cust_attrs_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>hier_cust_attrs_keys</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>all_keys</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=k>for</span> <span class=n>mongo_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>moved_in_avalon</span><span class=p>:</span>
            <span class=n>parent_changes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>
            <span class=n>hier_cust_attrs_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>
            <span class=n>all_keys</span> <span class=o>=</span> <span class=kc>True</span>

        <span class=k>for</span> <span class=n>mongo_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>renamed_in_avalon</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>mongo_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>parent_changes</span><span class=p>:</span>
                <span class=n>parent_changes</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>ftrack_ids</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>hier_cust_attrs_changes</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;avalon_&quot;</span><span class=p>):</span>
                <span class=k>continue</span>
            <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>ftrack_ids</span><span class=p>:</span>
                <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
                <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>mongo_id</span> <span class=ow>in</span> <span class=n>hier_cust_attrs_ids</span><span class=p>:</span>
                    <span class=k>continue</span>
                <span class=n>hier_cust_attrs_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>all_keys</span> <span class=ow>and</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>hier_cust_attrs_keys</span><span class=p>:</span>
                    <span class=n>hier_cust_attrs_keys</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>

        <span class=c1># Parents preparation ***</span>
        <span class=n>mongo_to_ftrack_parents</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>missing_ftrack_ents</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>mongo_id</span> <span class=ow>in</span> <span class=n>parent_changes</span><span class=p>:</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>:</span>
                <span class=n>missing_ftrack_ents</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>mongo_id</span>
                <span class=k>continue</span>
            <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
            <span class=n>mongo_to_ftrack_parents</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>])</span>

        <span class=k>if</span> <span class=n>missing_ftrack_ents</span><span class=p>:</span>
            <span class=n>joine_ids</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
                <span class=p>[</span><span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span> <span class=k>for</span> <span class=nb>id</span> <span class=ow>in</span> <span class=n>missing_ftrack_ents</span><span class=o>.</span><span class=n>keys</span><span class=p>()]</span>
            <span class=p>)</span>
            <span class=n>entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joine_ids</span>
                <span class=p>)</span>
            <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
            <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>entities</span><span class=p>:</span>
                <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>entity</span>
                <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>missing_ftrack_ents</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
                <span class=n>mongo_to_ftrack_parents</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>])</span>

        <span class=n>stored_parents_by_mongo</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=c1># sort by hierarchy level</span>
        <span class=n>mongo_to_ftrack_parents</span> <span class=o>=</span> <span class=p>[</span><span class=n>k</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span>
            <span class=n>mongo_to_ftrack_parents</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span>
            <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>item</span><span class=p>:</span> <span class=n>item</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
        <span class=p>)]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Updating parents and hieararchy because of name/parenting changes&quot;</span>
        <span class=p>)</span>
        <span class=k>for</span> <span class=n>mongo_id</span> <span class=ow>in</span> <span class=n>mongo_to_ftrack_parents</span><span class=p>:</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
            <span class=n>vis_par</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>vis_par</span> <span class=ow>in</span> <span class=n>stored_parents_by_mongo</span><span class=p>:</span>
                <span class=n>parents</span> <span class=o>=</span> <span class=p>[</span><span class=n>par</span> <span class=k>for</span> <span class=n>par</span> <span class=ow>in</span> <span class=n>stored_parents_by_mongo</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]]</span>
                <span class=k>if</span> <span class=n>vis_par</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=n>parent_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span>
                    <span class=n>parents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
                <span class=n>stored_parents_by_mongo</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>parents</span>
                <span class=k>continue</span>

            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
            <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
            <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]]</span>
            <span class=n>parents</span> <span class=o>=</span> <span class=n>ent_path_items</span><span class=p>[</span><span class=mi>1</span><span class=p>:</span><span class=nb>len</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>:]</span>
            <span class=n>stored_parents_by_mongo</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>parents</span>

        <span class=k>for</span> <span class=n>mongo_id</span><span class=p>,</span> <span class=n>parents</span> <span class=ow>in</span> <span class=n>stored_parents_by_mongo</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
            <span class=n>cur_par</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>cur_par</span> <span class=o>==</span> <span class=n>parents</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>parents</span>

        <span class=c1># Skip custom attributes if didn&#39;t change</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>hier_cust_attrs_ids</span><span class=p>:</span>
            <span class=c1># TODO logging</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                <span class=s2>&quot;Hierarchical attributes were not changed. Skipping&quot;</span>
            <span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>update_entities</span><span class=p>()</span>
            <span class=k>return</span>

        <span class=n>_</span><span class=p>,</span> <span class=n>hier_attrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_cust_attrs</span>

        <span class=c1># Hierarchical custom attributes preparation ***</span>
        <span class=n>hier_attr_key_by_id</span> <span class=o>=</span> <span class=p>{</span>
            <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]:</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span>
            <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>hier_attrs</span>
        <span class=p>}</span>
        <span class=n>hier_attr_id_by_key</span> <span class=o>=</span> <span class=p>{</span>
            <span class=n>key</span><span class=p>:</span> <span class=n>attr_id</span>
            <span class=k>for</span> <span class=n>attr_id</span><span class=p>,</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>hier_attr_key_by_id</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
        <span class=p>}</span>

        <span class=k>if</span> <span class=n>all_keys</span><span class=p>:</span>
            <span class=n>hier_cust_attrs_keys</span> <span class=o>=</span> <span class=p>[</span>
                <span class=n>key</span>
                <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>hier_attr_id_by_key</span><span class=o>.</span><span class=n>keys</span><span class=p>()</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>key</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;avalon_&quot;</span><span class=p>)</span>
            <span class=p>]</span>

        <span class=n>mongo_ftrack_mapping</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>cust_attrs_ftrack_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=c1># ftrack_parenting = collections.defaultdict(list)</span>
        <span class=n>entities_dict</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>

        <span class=n>children_queue</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
        <span class=n>parent_queue</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>

        <span class=k>for</span> <span class=n>mongo_id</span> <span class=ow>in</span> <span class=n>hier_cust_attrs_ids</span><span class=p>:</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
            <span class=n>parent_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>)</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>:</span>
                <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
                    <span class=s2>&quot;children&quot;</span><span class=p>:</span> <span class=p>[],</span>
                    <span class=s2>&quot;parent_id&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
                    <span class=s2>&quot;hier_attrs&quot;</span><span class=p>:</span> <span class=p>{}</span>
                <span class=p>}</span>

            <span class=n>mongo_ftrack_mapping</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>
            <span class=n>cust_attrs_ftrack_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=n>children_ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_parent_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>children_ent</span> <span class=ow>in</span> <span class=n>children_ents</span><span class=p>:</span>
                <span class=n>_ftrack_id</span> <span class=o>=</span> <span class=n>children_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>_ftrack_id</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>:</span>
                    <span class=k>continue</span>

                <span class=n>entities_dict</span><span class=p>[</span><span class=n>_ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
                    <span class=s2>&quot;children&quot;</span><span class=p>:</span> <span class=p>[],</span>
                    <span class=s2>&quot;parent_id&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
                    <span class=s2>&quot;hier_attrs&quot;</span><span class=p>:</span> <span class=p>{}</span>
                <span class=p>}</span>
                <span class=c1># if _ftrack_id not in ftrack_parenting[ftrack_id]:</span>
                <span class=c1>#     ftrack_parenting[ftrack_id].append(_ftrack_id)</span>
                <span class=n>entities_dict</span><span class=p>[</span><span class=n>_ftrack_id</span><span class=p>][</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>
                <span class=k>if</span> <span class=n>_ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>][</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
                    <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>][</span><span class=s2>&quot;children&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>_ftrack_id</span><span class=p>)</span>
                <span class=n>children_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>children_ent</span><span class=p>)</span>

        <span class=k>while</span> <span class=n>children_queue</span><span class=p>:</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=n>children_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>cust_attrs_ftrack_ids</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>mongo_ftrack_mapping</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>
            <span class=n>cust_attrs_ftrack_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>

            <span class=n>children_ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_parent_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>children_ent</span> <span class=ow>in</span> <span class=n>children_ents</span><span class=p>:</span>
                <span class=n>_ftrack_id</span> <span class=o>=</span> <span class=n>children_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>_ftrack_id</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>:</span>
                    <span class=k>continue</span>

                <span class=n>entities_dict</span><span class=p>[</span><span class=n>_ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
                    <span class=s2>&quot;children&quot;</span><span class=p>:</span> <span class=p>[],</span>
                    <span class=s2>&quot;parent_id&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
                    <span class=s2>&quot;hier_attrs&quot;</span><span class=p>:</span> <span class=p>{}</span>
                <span class=p>}</span>
                <span class=n>entities_dict</span><span class=p>[</span><span class=n>_ftrack_id</span><span class=p>][</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_id</span>
                <span class=k>if</span> <span class=n>_ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>][</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
                    <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>][</span><span class=s2>&quot;children&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>_ftrack_id</span><span class=p>)</span>
                <span class=n>children_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>children_ent</span><span class=p>)</span>

        <span class=k>while</span> <span class=n>parent_queue</span><span class=p>:</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=n>parent_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
            <span class=k>if</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>

            <span class=n>vis_par</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>vis_par</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>vis_par</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;parent&quot;</span><span class=p>]</span>

            <span class=n>parent_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span>
            <span class=n>parent_ftrack_id</span> <span class=o>=</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>handle_missing_ftrack_id</span><span class=p>(</span><span class=n>parent_ent</span><span class=p>)</span>
                <span class=n>parent_ftrack_id</span> <span class=o>=</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>continue</span>

            <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>:</span>
                <span class=n>entities_dict</span><span class=p>[</span><span class=n>parent_ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
                    <span class=s2>&quot;children&quot;</span><span class=p>:</span> <span class=p>[],</span>
                    <span class=s2>&quot;parent_id&quot;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
                    <span class=s2>&quot;hier_attrs&quot;</span><span class=p>:</span> <span class=p>{}</span>
                <span class=p>}</span>

            <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>[</span><span class=n>parent_ftrack_id</span><span class=p>][</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
                <span class=n>entities_dict</span><span class=p>[</span><span class=n>parent_ftrack_id</span><span class=p>][</span><span class=s2>&quot;children&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>

            <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>][</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>parent_ftrack_id</span>

            <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>in</span> <span class=n>cust_attrs_ftrack_ids</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>mongo_ftrack_mapping</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span> <span class=o>=</span> <span class=n>parent_ftrack_id</span>
            <span class=n>cust_attrs_ftrack_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>parent_ftrack_id</span><span class=p>)</span>
            <span class=c1># if ftrack_id not in ftrack_parenting[parent_ftrack_id]:</span>
            <span class=c1>#     ftrack_parenting[parent_ftrack_id].append(ftrack_id)</span>

            <span class=n>parent_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>parent_ent</span><span class=p>)</span>

        <span class=c1># Prepare values to query</span>
        <span class=n>configuration_ids</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>hier_cust_attrs_keys</span><span class=p>:</span>
            <span class=n>configuration_ids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>hier_attr_id_by_key</span><span class=p>[</span><span class=n>key</span><span class=p>])</span>

        <span class=n>values</span> <span class=o>=</span> <span class=n>query_custom_attribute_values</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=p>,</span>
            <span class=n>configuration_ids</span><span class=p>,</span>
            <span class=n>cust_attrs_ftrack_ids</span>
        <span class=p>)</span>

        <span class=n>ftrack_project_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>

        <span class=n>attr_types_by_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cust_attr_types_by_id</span>
        <span class=n>convert_types_by_id</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>hier_attrs</span><span class=p>:</span>
            <span class=n>key</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>hier_cust_attrs_keys</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>type_id</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;type_id&quot;</span><span class=p>]</span>
            <span class=n>attr_id</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
            <span class=n>cust_attr_type_name</span> <span class=o>=</span> <span class=n>attr_types_by_id</span><span class=p>[</span><span class=n>type_id</span><span class=p>][</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=n>convert_type</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>get_python_type_for_custom_attribute</span><span class=p>(</span>
                <span class=n>attr</span><span class=p>,</span> <span class=n>cust_attr_type_name</span>
            <span class=p>)</span>

            <span class=n>convert_types_by_id</span><span class=p>[</span><span class=n>attr_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>convert_type</span>
            <span class=n>default_value</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;default&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>FPS_KEYS</span><span class=p>:</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>default_value</span> <span class=o>=</span> <span class=n>convert_to_fps</span><span class=p>(</span><span class=n>default_value</span><span class=p>)</span>
                <span class=k>except</span> <span class=n>InvalidFpsValue</span><span class=p>:</span>
                    <span class=k>pass</span>

            <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_project_id</span><span class=p>][</span><span class=s2>&quot;hier_attrs&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;default&quot;</span><span class=p>]</span>
            <span class=p>)</span>

        <span class=c1># PREPARE DATA BEFORE THIS</span>
        <span class=n>invalid_fps_items</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>avalon_hier</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>values</span><span class=p>:</span>
            <span class=n>value</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=s2>&quot;value&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>entity_id</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=s2>&quot;entity_id&quot;</span><span class=p>]</span>
            <span class=n>configuration_id</span> <span class=o>=</span> <span class=n>item</span><span class=p>[</span><span class=s2>&quot;configuration_id&quot;</span><span class=p>]</span>

            <span class=n>convert_type</span> <span class=o>=</span> <span class=n>convert_types_by_id</span><span class=p>[</span><span class=n>configuration_id</span><span class=p>]</span>
            <span class=n>key</span> <span class=o>=</span> <span class=n>hier_attr_key_by_id</span><span class=p>[</span><span class=n>configuration_id</span><span class=p>]</span>

            <span class=k>if</span> <span class=n>convert_type</span><span class=p>:</span>
                <span class=n>value</span> <span class=o>=</span> <span class=n>convert_type</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>

            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>FPS_KEYS</span><span class=p>:</span>
                <span class=k>try</span><span class=p>:</span>
                    <span class=n>value</span> <span class=o>=</span> <span class=n>convert_to_fps</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
                <span class=k>except</span> <span class=n>InvalidFpsValue</span><span class=p>:</span>
                    <span class=n>invalid_fps_items</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>entity_id</span><span class=p>,</span> <span class=n>value</span><span class=p>))</span>
                    <span class=k>continue</span>
            <span class=n>entities_dict</span><span class=p>[</span><span class=n>entity_id</span><span class=p>][</span><span class=s2>&quot;hier_attrs&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>

        <span class=k>if</span> <span class=n>invalid_fps_items</span><span class=p>:</span>
            <span class=n>fps_msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;These entities have invalid fps value in custom attributes&quot;</span>
            <span class=p>)</span>
            <span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>entity_id</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>invalid_fps_items</span><span class=p>:</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>entity_id</span><span class=p>)</span>
                <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> - </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>,</span> <span class=n>value</span><span class=p>))</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;error&quot;</span><span class=p>][</span><span class=n>fps_msg</span><span class=p>]</span> <span class=o>=</span> <span class=n>items</span>

        <span class=c1># Get dictionary with not None hierarchical values to pull to childs</span>
        <span class=n>project_values</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=p>(</span>
            <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_project_id</span><span class=p>][</span><span class=s2>&quot;hier_attrs&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>()</span>
        <span class=p>):</span>
            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>project_values</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>

        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>avalon_hier</span><span class=p>:</span>
            <span class=n>value</span> <span class=o>=</span> <span class=n>entities_dict</span><span class=p>[</span><span class=n>ftrack_project_id</span><span class=p>][</span><span class=s2>&quot;avalon_attrs&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>project_values</span><span class=p>[</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>

        <span class=n>hier_down_queue</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
        <span class=n>hier_down_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
            <span class=p>(</span><span class=n>project_values</span><span class=p>,</span> <span class=n>ftrack_project_id</span><span class=p>)</span>
        <span class=p>)</span>

        <span class=k>while</span> <span class=n>hier_down_queue</span><span class=p>:</span>
            <span class=n>hier_values</span><span class=p>,</span> <span class=n>parent_id</span> <span class=o>=</span> <span class=n>hier_down_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
            <span class=k>for</span> <span class=n>child_id</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=p>[</span><span class=n>parent_id</span><span class=p>][</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
                <span class=n>_hier_values</span> <span class=o>=</span> <span class=n>hier_values</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
                <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>hier_cust_attrs_keys</span><span class=p>:</span>
                    <span class=n>value</span> <span class=o>=</span> <span class=n>entities_dict</span><span class=p>[</span><span class=n>child_id</span><span class=p>][</span><span class=s2>&quot;hier_attrs&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
                    <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                        <span class=n>_hier_values</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>

                <span class=n>entities_dict</span><span class=p>[</span><span class=n>child_id</span><span class=p>][</span><span class=s2>&quot;hier_attrs&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>_hier_values</span><span class=p>)</span>
                <span class=n>hier_down_queue</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>_hier_values</span><span class=p>,</span> <span class=n>child_id</span><span class=p>))</span>

        <span class=n>ftrack_mongo_mapping</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>mongo_id</span><span class=p>,</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>mongo_ftrack_mapping</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>ftrack_mongo_mapping</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>mongo_id</span>

        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>data</span> <span class=ow>in</span> <span class=n>entities_dict</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>ftrack_mongo_mapping</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
            <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=c1># TODO logging</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                <span class=s2>&quot;Updating hierarchical attributes &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
            <span class=p>)</span>
            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=ow>in</span> <span class=n>data</span><span class=p>[</span><span class=s2>&quot;hier_attrs&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
                <span class=k>if</span> <span class=p>(</span>
                    <span class=n>key</span> <span class=ow>in</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=ow>and</span>
                    <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>==</span> <span class=n>value</span>
                <span class=p>):</span>
                    <span class=k>continue</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;- </span><span class=si>{}</span><span class=s2>: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>))</span>
                <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>value</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>update_entities</span><span class=p>()</span>

    <span class=k>def</span><span class=w> </span><span class=nf>process_task_updates</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Pull task information for selected ftrack ids to replace stored</span>
<span class=sd>            existing in Avalon.</span>
<span class=sd>            Solves problem of changing type (even Status in the future) of</span>
<span class=sd>            task without storing ftrack id for task in the DB. (Which doesn&#39;t</span>
<span class=sd>            bring much advantage currently and it could be troublesome for</span>
<span class=sd>            all hosts or plugins (for example Nuke) to collect and store.</span>
<span class=sd>        Returns:</span>
<span class=sd>            None</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Processing task changes for parents: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
            <span class=p>)</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>joined_ids</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span>
            <span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
        <span class=p>])</span>
        <span class=n>task_entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>task_entities_query_by_parent_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joined_ids</span>
            <span class=p>)</span>
        <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>

        <span class=n>ftrack_mongo_mapping_found</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>not_found_ids</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=c1># Make sure all parents have updated tasks, as they may not have any</span>
        <span class=n>tasks_per_ftrack_id</span> <span class=o>=</span> <span class=p>{</span>
            <span class=n>ftrack_id</span><span class=p>:</span> <span class=p>{}</span>
            <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
        <span class=p>}</span>

        <span class=c1># Query all task types at once</span>
        <span class=n>task_types</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>task_types_query</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
        <span class=n>task_types_by_id</span> <span class=o>=</span> <span class=p>{</span>
            <span class=n>task_type</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]:</span> <span class=n>task_type</span>
            <span class=k>for</span> <span class=n>task_type</span> <span class=ow>in</span> <span class=n>task_types</span>
        <span class=p>}</span>

        <span class=c1># prepare all tasks per parentId, eg. Avalon asset record</span>
        <span class=k>for</span> <span class=n>task_entity</span> <span class=ow>in</span> <span class=n>task_entities</span><span class=p>:</span>
            <span class=n>task_type</span> <span class=o>=</span> <span class=n>task_types_by_id</span><span class=p>[</span><span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;type_id&quot;</span><span class=p>]]</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>tasks_per_ftrack_id</span><span class=p>:</span>
                <span class=n>tasks_per_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

            <span class=n>passed_regex</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>check_regex</span><span class=p>(</span>
                <span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>],</span> <span class=s2>&quot;task&quot;</span><span class=p>,</span>
                <span class=n>schema_patterns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>passed_regex</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>])</span>
                <span class=k>continue</span>

            <span class=n>tasks_per_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>][</span><span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{</span>
                <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=n>task_type</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=p>}</span>

        <span class=c1># find avalon entity by parentId</span>
        <span class=c1># should be there as create was run first</span>
        <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>tasks_per_ftrack_id</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
            <span class=n>avalon_entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_entity</span><span class=p>:</span>
                <span class=n>not_found_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=k>continue</span>
            <span class=n>ftrack_mongo_mapping_found</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>_update_avalon_tasks</span><span class=p>(</span>
            <span class=n>ftrack_mongo_mapping_found</span><span class=p>,</span>
            <span class=n>tasks_per_ftrack_id</span>
        <span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>update_entities</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Update Avalon entities by mongo bulk changes.</span>
<span class=sd>            Expects self.updates which are transfered to $set part of update</span>
<span class=sd>            command.</span>
<span class=sd>            Resets self.updates afterwards.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>mongo_changes_bulk</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>mongo_id</span><span class=p>,</span> <span class=n>changes</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
            <span class=n>is_project</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;project&quot;</span>
            <span class=n>change_data</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>from_dict_to_set</span><span class=p>(</span><span class=n>changes</span><span class=p>,</span> <span class=n>is_project</span><span class=p>)</span>
            <span class=n>mongo_changes_bulk</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
                <span class=n>UpdateOne</span><span class=p>({</span><span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>mongo_id</span><span class=p>},</span> <span class=n>change_data</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>mongo_changes_bulk</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>bulk_write</span><span class=p>(</span><span class=n>mongo_changes_bulk</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>updates</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>duplicated_report</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>duplicated</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>[]</span>

        <span class=n>ft_project</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
        <span class=n>duplicated_names</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>duplicated</span><span class=p>:</span>
            <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>ftrack_ent</span><span class=p>:</span>
                <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>ftrack_id</span>
                    <span class=p>)</span>
                <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_ent</span>
            <span class=n>name</span> <span class=o>=</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>name</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>duplicated_names</span><span class=p>:</span>
                <span class=n>duplicated_names</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>

        <span class=n>joined_names</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
            <span class=p>[</span><span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>duplicated_names</span><span class=p>]</span>
        <span class=p>)</span>
        <span class=n>ft_ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>entities_name_query_by_name</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joined_names</span>
            <span class=p>)</span>
        <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>

        <span class=n>ft_ents_by_name</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>ft_ent</span> <span class=ow>in</span> <span class=n>ft_ents</span><span class=p>:</span>
            <span class=n>name</span> <span class=o>=</span> <span class=n>ft_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=n>ft_ents_by_name</span><span class=p>[</span><span class=n>name</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ft_ent</span><span class=p>)</span>

        <span class=k>if</span> <span class=ow>not</span> <span class=n>ft_ents_by_name</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>[]</span>

        <span class=n>subtitle</span> <span class=o>=</span> <span class=s2>&quot;Duplicated entity names:&quot;</span>
        <span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
            <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s2>&quot;# </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>subtitle</span><span class=p>)</span>
        <span class=p>})</span>
        <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
            <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=p>(</span>
                <span class=s2>&quot;&lt;p&gt;&lt;i&gt;NOTE: It is not allowed to use the same name&quot;</span>
                <span class=s2>&quot; for multiple entities in the same project&lt;/i&gt;&lt;/p&gt;&quot;</span>
            <span class=p>)</span>
        <span class=p>})</span>

        <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>ents</span> <span class=ow>in</span> <span class=n>ft_ents_by_name</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
                <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s2>&quot;## </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
            <span class=p>})</span>
            <span class=n>paths</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ents</span><span class=p>:</span>
                <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>ent</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>_ent</span> <span class=ow>in</span> <span class=n>ent</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]])</span>
                <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>

                <span class=k>if</span> <span class=n>avalon_ent</span><span class=p>:</span>
                    <span class=n>additional</span> <span class=o>=</span> <span class=s2>&quot; (synchronized)&quot;</span>
                    <span class=k>if</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=n>name</span><span class=p>:</span>
                        <span class=n>additional</span> <span class=o>=</span> <span class=s2>&quot; (synchronized as </span><span class=si>{}</span><span class=s2>)&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                            <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
                        <span class=p>)</span>
                    <span class=n>ent_path</span> <span class=o>+=</span> <span class=n>additional</span>
                <span class=n>paths</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>

            <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
                <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s1>&#39;&lt;p&gt;</span><span class=si>{}</span><span class=s1>&lt;/p&gt;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&quot;&lt;br&gt;&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>paths</span><span class=p>))</span>
            <span class=p>})</span>

        <span class=k>return</span> <span class=n>items</span>

    <span class=nd>@property</span>
    <span class=k>def</span><span class=w> </span><span class=nf>regex_report</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span><span class=p>:</span>
            <span class=k>return</span> <span class=p>[]</span>

        <span class=n>subtitle</span> <span class=o>=</span> <span class=s2>&quot;Entity names contain prohibited symbols:&quot;</span>
        <span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
            <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s2>&quot;# </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>subtitle</span><span class=p>)</span>
        <span class=p>})</span>
        <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
            <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=p>(</span>
                <span class=s2>&quot;&lt;p&gt;&lt;i&gt;NOTE: You can use Letters( a-Z ),&quot;</span>
                <span class=s2>&quot; Numbers( 0-9 ) and Underscore( _ )&lt;/i&gt;&lt;/p&gt;&quot;</span>
            <span class=p>)</span>
        <span class=p>})</span>

        <span class=n>ft_project</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
        <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span><span class=p>:</span>
            <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>ftrack_ent</span><span class=p>:</span>
                <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>ftrack_id</span>
                    <span class=p>)</span>
                <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_ent</span>

            <span class=n>name</span> <span class=o>=</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
            <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=n>_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>_ent</span> <span class=ow>in</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>][:</span><span class=o>-</span><span class=mi>1</span><span class=p>]]</span>
            <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=s2>&quot;&lt;strong&gt;</span><span class=si>{}</span><span class=s2>&lt;/strong&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>))</span>
            <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>
            <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
                <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s2>&quot;&lt;p&gt;</span><span class=si>{}</span><span class=s2> - </span><span class=si>{}</span><span class=s2>&lt;/p&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>)</span>
            <span class=p>})</span>

        <span class=k>return</span> <span class=n>items</span>

    <span class=k>def</span><span class=w> </span><span class=nf>report</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>msg_len</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>duplicated</span><span class=p>)</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>msgs</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
            <span class=n>msg_len</span> <span class=o>+=</span> <span class=nb>len</span><span class=p>(</span><span class=n>msgs</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>msg_len</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span>

        <span class=n>items</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>project_name</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]</span>
        <span class=n>title</span> <span class=o>=</span> <span class=s2>&quot;Synchronization report (</span><span class=si>{}</span><span class=s2>):&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>project_name</span><span class=p>)</span>

        <span class=n>keys</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&quot;error&quot;</span><span class=p>,</span> <span class=s2>&quot;warning&quot;</span><span class=p>,</span> <span class=s2>&quot;info&quot;</span><span class=p>]</span>
        <span class=k>for</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>keys</span><span class=p>:</span>
            <span class=n>subitems</span> <span class=o>=</span> <span class=p>[]</span>
            <span class=k>if</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&quot;warning&quot;</span><span class=p>:</span>
                <span class=n>subitems</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>duplicated_report</span><span class=p>)</span>
                <span class=n>subitems</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_report</span><span class=p>)</span>

            <span class=k>for</span> <span class=n>_msg</span><span class=p>,</span> <span class=n>_items</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>_items</span><span class=p>:</span>
                    <span class=k>continue</span>

                <span class=n>msg_items</span> <span class=o>=</span> <span class=n>_msg</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;||&quot;</span><span class=p>)</span>
                <span class=n>msg</span> <span class=o>=</span> <span class=n>msg_items</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
                <span class=n>subitems</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                    <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s2>&quot;# </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
                <span class=p>})</span>

                <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>msg_items</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
                    <span class=k>for</span> <span class=n>note</span> <span class=ow>in</span> <span class=n>msg_items</span><span class=p>[</span><span class=mi>1</span><span class=p>:]:</span>
                        <span class=n>subitems</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
                            <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s2>&quot;&lt;p&gt;&lt;i&gt;NOTE: </span><span class=si>{}</span><span class=s2>&lt;/i&gt;&lt;/p&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>note</span><span class=p>)</span>
                        <span class=p>})</span>

                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>_items</span><span class=p>,</span> <span class=nb>str</span><span class=p>):</span>
                    <span class=n>_items</span> <span class=o>=</span> <span class=p>[</span><span class=n>_items</span><span class=p>]</span>
                <span class=n>subitems</span><span class=o>.</span><span class=n>append</span><span class=p>({</span>
                    <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;label&quot;</span><span class=p>,</span>
                    <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=s1>&#39;&lt;p&gt;</span><span class=si>{}</span><span class=s1>&lt;/p&gt;&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=s2>&quot;&lt;br&gt;&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>_items</span><span class=p>))</span>
                <span class=p>})</span>

            <span class=k>if</span> <span class=n>items</span> <span class=ow>and</span> <span class=n>subitems</span><span class=p>:</span>
                <span class=n>items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>report_splitter</span><span class=p>)</span>

            <span class=n>items</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>subitems</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>show_interface</span><span class=p>(</span>
            <span class=n>items</span><span class=o>=</span><span class=n>items</span><span class=p>,</span>
            <span class=n>title</span><span class=o>=</span><span class=n>title</span><span class=p>,</span>
            <span class=n>event</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_cur_event</span>
        <span class=p>)</span>
        <span class=k>return</span> <span class=kc>True</span>

    <span class=k>def</span><span class=w> </span><span class=nf>_update_avalon_tasks</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span> <span class=n>ftrack_mongo_mapping_found</span><span class=p>,</span> <span class=n>tasks_per_ftrack_id</span>
    <span class=p>):</span>
<span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>            Prepare new &quot;tasks&quot; content for existing records in Avalon.</span>
<span class=sd>        Args:</span>
<span class=sd>            ftrack_mongo_mapping_found (dictionary): ftrack parentId to</span>
<span class=sd>                Avalon _id mapping</span>
<span class=sd>            tasks_per_ftrack_id (dictionary): task dictionaries per ftrack</span>
<span class=sd>                parentId</span>

<span class=sd>        Returns:</span>
<span class=sd>            None</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>mongo_changes_bulk</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>mongo_id</span> <span class=ow>in</span> <span class=n>ftrack_mongo_mapping_found</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=nb>filter</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>mongo_id</span><span class=p>}</span>
            <span class=n>change_data</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;$set&quot;</span><span class=p>:</span> <span class=p>{}}</span>
            <span class=n>change_data</span><span class=p>[</span><span class=s2>&quot;$set&quot;</span><span class=p>][</span><span class=s2>&quot;data.tasks&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>tasks_per_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
            <span class=n>mongo_changes_bulk</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>UpdateOne</span><span class=p>(</span><span class=nb>filter</span><span class=p>,</span> <span class=n>change_data</span><span class=p>))</span>

        <span class=k>if</span> <span class=n>mongo_changes_bulk</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>bulk_write</span><span class=p>(</span><span class=n>mongo_changes_bulk</span><span class=p>)</span>

    <span class=k>def</span><span class=w> </span><span class=nf>_mongo_id_configuration</span><span class=p>(</span>
        <span class=bp>self</span><span class=p>,</span>
        <span class=n>ent_info</span><span class=p>,</span>
        <span class=n>cust_attrs</span><span class=p>,</span>
        <span class=n>hier_attrs</span><span class=p>,</span>
        <span class=n>temp_dict</span>
    <span class=p>):</span>
        <span class=c1># Use hierarchical mongo id attribute if possible.</span>
        <span class=k>if</span> <span class=s2>&quot;_hierarchical&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>temp_dict</span><span class=p>:</span>
            <span class=n>hier_mongo_id_configuration_id</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>hier_attrs</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>:</span>
                    <span class=n>hier_mongo_id_configuration_id</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
                    <span class=k>break</span>
            <span class=n>temp_dict</span><span class=p>[</span><span class=s2>&quot;_hierarchical&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>hier_mongo_id_configuration_id</span>

        <span class=n>hier_mongo_id_configuration_id</span> <span class=o>=</span> <span class=n>temp_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;_hierarchical&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>hier_mongo_id_configuration_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>hier_mongo_id_configuration_id</span>

        <span class=c1># Legacy part for cases that MongoID attribute is per entity type.</span>
        <span class=n>entity_type</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>
        <span class=n>mongo_id_configuration_id</span> <span class=o>=</span> <span class=n>temp_dict</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>entity_type</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>mongo_id_configuration_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=n>mongo_id_configuration_id</span>

        <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>cust_attrs</span><span class=p>:</span>
            <span class=n>key</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>key</span> <span class=o>!=</span> <span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]:</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=p>(</span>
                <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span> <span class=ow>and</span>
                <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;object_type_id&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;objectTypeId&quot;</span><span class=p>]</span>
            <span class=p>):</span>
                <span class=k>continue</span>

            <span class=n>mongo_id_configuration_id</span> <span class=o>=</span> <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
            <span class=k>break</span>

        <span class=n>temp_dict</span><span class=p>[</span><span class=n>entity_type</span><span class=p>]</span> <span class=o>=</span> <span class=n>mongo_id_configuration_id</span>

        <span class=k>return</span> <span class=n>mongo_id_configuration_id</span>
</code></pre></div></td></tr></table></div> </details> <div class="doc doc-children"> <div class="doc doc-object doc-attribute"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.changeability_by_mongo_id class="doc doc-heading"> <code class="highlight language-python"><span class=n>changeability_by_mongo_id</span></code> <span class="doc doc-labels"> <small class="doc doc-label doc-label-property"><code>property</code></small> </span> </h3> <div class="doc doc-contents "> <p>Return info about changeability of entity and it's parents.</p> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.__init__ class="doc doc-heading"> <code class="highlight language-python"><span class=fm>__init__</span><span class=p>(</span><span class=n>session</span><span class=p>)</span></code> </h3> <div class="doc doc-contents "> <p>Expects a ftrack_api.Session instance</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>83</span>
<span class=normal>84</span>
<span class=normal>85</span>
<span class=normal>86</span>
<span class=normal>87</span>
<span class=normal>88</span>
<span class=normal>89</span>
<span class=normal>90</span>
<span class=normal>91</span>
<span class=normal>92</span>
<span class=normal>93</span>
<span class=normal>94</span>
<span class=normal>95</span>
<span class=normal>96</span>
<span class=normal>97</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&#39;&#39;&#39;Expects a ftrack_api.Session instance&#39;&#39;&#39;</span>
    <span class=c1># Debug settings</span>
    <span class=c1># - time expiration in seconds</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time_expiration</span> <span class=o>=</span> <span class=mi>5</span> <span class=o>*</span> <span class=mi>60</span>
    <span class=c1># - store current time</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
    <span class=c1># - store synchronize entity types to be able to use</span>
    <span class=c1>#   only entityTypes in interest instead of filtering by ignored</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span> <span class=o>=</span> <span class=n>AvalonMongoDB</span><span class=p>()</span>
    <span class=c1># Set processing session to not use global</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>set_process_session</span><span class=p>(</span><span class=n>session</span><span class=p>)</span>
    <span class=nb>super</span><span class=p>()</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=n>session</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.check_names_synchronizable class="doc doc-heading"> <code class="highlight language-python"><span class=n>check_names_synchronizable</span><span class=p>(</span><span class=n>names</span><span class=p>)</span></code> </h3> <div class="doc doc-contents "> <p>Check if entities with specific names are importable.</p> <p>This check should happend after removing entity or renaming entity. When entity was removed or renamed then it's name is possible to sync.</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1096</span>
<span class=normal>1097</span>
<span class=normal>1098</span>
<span class=normal>1099</span>
<span class=normal>1100</span>
<span class=normal>1101</span>
<span class=normal>1102</span>
<span class=normal>1103</span>
<span class=normal>1104</span>
<span class=normal>1105</span>
<span class=normal>1106</span>
<span class=normal>1107</span>
<span class=normal>1108</span>
<span class=normal>1109</span>
<span class=normal>1110</span>
<span class=normal>1111</span>
<span class=normal>1112</span>
<span class=normal>1113</span>
<span class=normal>1114</span>
<span class=normal>1115</span>
<span class=normal>1116</span>
<span class=normal>1117</span>
<span class=normal>1118</span>
<span class=normal>1119</span>
<span class=normal>1120</span>
<span class=normal>1121</span>
<span class=normal>1122</span>
<span class=normal>1123</span>
<span class=normal>1124</span>
<span class=normal>1125</span>
<span class=normal>1126</span>
<span class=normal>1127</span>
<span class=normal>1128</span>
<span class=normal>1129</span>
<span class=normal>1130</span>
<span class=normal>1131</span>
<span class=normal>1132</span>
<span class=normal>1133</span>
<span class=normal>1134</span>
<span class=normal>1135</span>
<span class=normal>1136</span>
<span class=normal>1137</span>
<span class=normal>1138</span>
<span class=normal>1139</span>
<span class=normal>1140</span>
<span class=normal>1141</span>
<span class=normal>1142</span>
<span class=normal>1143</span>
<span class=normal>1144</span>
<span class=normal>1145</span>
<span class=normal>1146</span>
<span class=normal>1147</span>
<span class=normal>1148</span>
<span class=normal>1149</span>
<span class=normal>1150</span>
<span class=normal>1151</span>
<span class=normal>1152</span>
<span class=normal>1153</span>
<span class=normal>1154</span>
<span class=normal>1155</span>
<span class=normal>1156</span>
<span class=normal>1157</span>
<span class=normal>1158</span>
<span class=normal>1159</span>
<span class=normal>1160</span>
<span class=normal>1161</span>
<span class=normal>1162</span>
<span class=normal>1163</span>
<span class=normal>1164</span>
<span class=normal>1165</span>
<span class=normal>1166</span>
<span class=normal>1167</span>
<span class=normal>1168</span>
<span class=normal>1169</span>
<span class=normal>1170</span>
<span class=normal>1171</span>
<span class=normal>1172</span>
<span class=normal>1173</span>
<span class=normal>1174</span>
<span class=normal>1175</span>
<span class=normal>1176</span>
<span class=normal>1177</span>
<span class=normal>1178</span>
<span class=normal>1179</span>
<span class=normal>1180</span>
<span class=normal>1181</span>
<span class=normal>1182</span>
<span class=normal>1183</span>
<span class=normal>1184</span>
<span class=normal>1185</span>
<span class=normal>1186</span>
<span class=normal>1187</span>
<span class=normal>1188</span>
<span class=normal>1189</span>
<span class=normal>1190</span>
<span class=normal>1191</span>
<span class=normal>1192</span>
<span class=normal>1193</span>
<span class=normal>1194</span>
<span class=normal>1195</span>
<span class=normal>1196</span>
<span class=normal>1197</span>
<span class=normal>1198</span>
<span class=normal>1199</span>
<span class=normal>1200</span>
<span class=normal>1201</span>
<span class=normal>1202</span>
<span class=normal>1203</span>
<span class=normal>1204</span>
<span class=normal>1205</span>
<span class=normal>1206</span>
<span class=normal>1207</span>
<span class=normal>1208</span>
<span class=normal>1209</span>
<span class=normal>1210</span>
<span class=normal>1211</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>check_names_synchronizable</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>names</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Check if entities with specific names are importable.</span>

<span class=sd>    This check should happend after removing entity or renaming entity.</span>
<span class=sd>    When entity was removed or renamed then it&#39;s name is possible to sync.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>joined_passed_names</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
        <span class=p>[</span><span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>name</span><span class=p>)</span> <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=n>names</span><span class=p>]</span>
    <span class=p>)</span>
    <span class=n>same_name_entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>entities_name_query_by_name</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joined_passed_names</span>
        <span class=p>)</span>
    <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>same_name_entities</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=n>entities_by_name</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>same_name_entities</span><span class=p>:</span>
        <span class=n>entities_by_name</span><span class=p>[</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entity</span><span class=p>)</span>

    <span class=n>synchronizable_ents</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
        <span class=s2>&quot;Deleting of entities should allow to synchronize another entities&quot;</span>
        <span class=s2>&quot; with same name.&quot;</span>
    <span class=p>))</span>
    <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>ents</span> <span class=ow>in</span> <span class=n>entities_by_name</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ents</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                <span class=s2>&quot;Name </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> still have more than one entity &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=n>name</span><span class=p>,</span> <span class=s2>&quot;| &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span>
                    <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>])</span> <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>ents</span><span class=p>]</span>
                <span class=p>)</span>
            <span class=p>))</span>
            <span class=k>continue</span>

        <span class=n>entity</span> <span class=o>=</span> <span class=n>ents</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
        <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>])</span>
        <span class=c1># TODO logging</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
            <span class=s2>&quot;Checking if can synchronize entity &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
        <span class=p>)</span>
        <span class=c1># skip if already synchronized</span>
        <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>:</span>
            <span class=c1># TODO logging</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                <span class=s2>&quot;- Entity is already synchronized (skipping) &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                    <span class=n>ent_path</span>
                <span class=p>)</span>
            <span class=p>)</span>
            <span class=k>continue</span>

        <span class=n>parent_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>parent_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>:</span>
            <span class=c1># TODO logging</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                <span class=s2>&quot;- Entity&#39;s parent entity doesn&#39;t seems to&quot;</span>
                <span class=s2>&quot; be synchronized (skipping) &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_path</span><span class=p>))</span>
            <span class=k>continue</span>

        <span class=n>synchronizable_ents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entity</span><span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>synchronizable_ents</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=n>synchronizable_ents</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
        <span class=n>synchronizable_ents</span><span class=p>,</span>
        <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>entity</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]))</span>
    <span class=p>)</span>

    <span class=n>children_queue</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>deque</span><span class=p>()</span>
    <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>synchronizable_ents</span><span class=p>:</span>
        <span class=n>parent_avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>[</span>
            <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
        <span class=p>]</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>create_entity_in_avalon</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span> <span class=n>parent_avalon_ent</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>child</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
            <span class=k>if</span> <span class=n>child</span><span class=o>.</span><span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>!=</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
                <span class=n>children_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>child</span><span class=p>)</span>

    <span class=k>while</span> <span class=n>children_queue</span><span class=p>:</span>
        <span class=n>entity</span> <span class=o>=</span> <span class=n>children_queue</span><span class=o>.</span><span class=n>popleft</span><span class=p>()</span>
        <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
        <span class=n>name</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
        <span class=n>ent_by_ftrack_id</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>ent_by_ftrack_id</span><span class=p>:</span>
            <span class=k>raise</span> <span class=ne>Exception</span><span class=p>((</span>
                <span class=s2>&quot;This is bug, parent was just synchronized to avalon&quot;</span>
                <span class=s2>&quot; but entity is already in database </span><span class=si>{}</span><span class=s2>&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>dict</span><span class=p>(</span><span class=n>entity</span><span class=p>)))</span>

        <span class=c1># Entity has duplicated name with another entity</span>
        <span class=c1># - may be renamed: in that case renaming method will handle that</span>
        <span class=n>duplicate_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_name</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>duplicate_ent</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>passed_regex</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>check_regex</span><span class=p>(</span>
            <span class=n>name</span><span class=p>,</span> <span class=s2>&quot;asset&quot;</span><span class=p>,</span> <span class=n>schema_patterns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>passed_regex</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>parent_id</span> <span class=o>=</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
        <span class=n>parent_avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>parent_id</span><span class=p>]</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>create_entity_in_avalon</span><span class=p>(</span><span class=n>entity</span><span class=p>,</span> <span class=n>parent_avalon_ent</span><span class=p>)</span>

        <span class=k>for</span> <span class=n>child</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;children&quot;</span><span class=p>]:</span>
            <span class=k>if</span> <span class=n>child</span><span class=o>.</span><span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>children_queue</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>child</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.debug_logs class="doc doc-heading"> <code class="highlight language-python"><span class=n>debug_logs</span><span class=p>()</span></code> </h3> <div class="doc doc-contents "> <p>This is debug method for printing small debugs messages.</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 99</span>
<span class=normal>100</span>
<span class=normal>101</span>
<span class=normal>102</span>
<span class=normal>103</span>
<span class=normal>104</span>
<span class=normal>105</span>
<span class=normal>106</span>
<span class=normal>107</span>
<span class=normal>108</span>
<span class=normal>109</span>
<span class=normal>110</span>
<span class=normal>111</span>
<span class=normal>112</span>
<span class=normal>113</span>
<span class=normal>114</span>
<span class=normal>115</span>
<span class=normal>116</span>
<span class=normal>117</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>debug_logs</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;This is debug method for printing small debugs messages. &quot;&quot;&quot;</span>
    <span class=n>now_datetime</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>()</span>
    <span class=n>delta</span> <span class=o>=</span> <span class=n>now_datetime</span> <span class=o>-</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time</span>
    <span class=k>if</span> <span class=n>delta</span><span class=o>.</span><span class=n>total_seconds</span><span class=p>()</span> <span class=o>&lt;</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time_expiration</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>debug_print_time</span> <span class=o>=</span> <span class=n>now_datetime</span>
    <span class=n>known_types_items</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>entityType</span><span class=p>,</span> <span class=n>entity_type</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>ent_types_msg</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>entity_type</span><span class=p>)</span>
        <span class=n>known_types_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
            <span class=s2>&quot;&lt;</span><span class=si>{}</span><span class=s2>&gt; (</span><span class=si>{}</span><span class=s2>)&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>entityType</span><span class=p>,</span> <span class=n>ent_types_msg</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=n>known_entityTypes</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>known_types_items</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
        <span class=s2>&quot;DEBUG MESSAGE: Known types </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>known_entityTypes</span><span class=p>)</span>
    <span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.get_ent_path class="doc doc-heading"> <code class="highlight language-python"><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span></code> </h3> <div class="doc doc-contents "> <pre><code>Looks for entity in ftrack with 'ftrack_id'. If found returns
concatenated paths from its 'link' elemenent's names. Describes
location of entity in tree.
</code></pre> <p>Args: ftrack_id (string): entityId of ftrack entity</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> </td> <td> <div class=doc-md-description> <p>(string) - example : "/test_project/assets/my_asset"</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>575</span>
<span class=normal>576</span>
<span class=normal>577</span>
<span class=normal>578</span>
<span class=normal>579</span>
<span class=normal>580</span>
<span class=normal>581</span>
<span class=normal>582</span>
<span class=normal>583</span>
<span class=normal>584</span>
<span class=normal>585</span>
<span class=normal>586</span>
<span class=normal>587</span>
<span class=normal>588</span>
<span class=normal>589</span>
<span class=normal>590</span>
<span class=normal>591</span>
<span class=normal>592</span>
<span class=normal>593</span>
<span class=normal>594</span>
<span class=normal>595</span>
<span class=normal>596</span>
<span class=normal>597</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>get_ent_path</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ftrack_id</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Looks for entity in ftrack with &#39;ftrack_id&#39;. If found returns</span>
<span class=sd>        concatenated paths from its &#39;link&#39; elemenent&#39;s names. Describes</span>
<span class=sd>        location of entity in tree.</span>
<span class=sd>    Args:</span>
<span class=sd>        ftrack_id (string): entityId of ftrack entity</span>

<span class=sd>    Returns:</span>
<span class=sd>        (string) - example : &quot;/test_project/assets/my_asset&quot;</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>entity</span><span class=p>:</span>
        <span class=n>entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>ftrack_id</span>
            <span class=p>)</span>
        <span class=p>)</span><span class=o>.</span><span class=n>first</span><span class=p>()</span>
        <span class=k>if</span> <span class=n>entity</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>entity</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>return</span> <span class=s2>&quot;unknown hierarchy&quot;</span>
    <span class=k>return</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=n>ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=k>for</span> <span class=n>ent</span> <span class=ow>in</span> <span class=n>entity</span><span class=p>[</span><span class=s2>&quot;link&quot;</span><span class=p>]])</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.launch class="doc doc-heading"> <code class="highlight language-python"><span class=n>launch</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span></code> </h3> <div class="doc doc-contents "> <pre><code>Main entry port for synchronization.
Goes through event (can contain multiple changes) and decides if
the event is interesting for us (interest_entTypes).
It separates changes into add|remove|update.
All task changes are handled together by refresh from ftrack.
</code></pre> <p>Args: session (object): session to ftrack event (dictionary): event content</p> <p><span class=doc-section-title>Returns:</span></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr class=doc-section-item> <td> </td> <td> <div class=doc-md-description> <p>(boolean or None)</p> </div> </td> </tr> </tbody> </table> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>599</span>
<span class=normal>600</span>
<span class=normal>601</span>
<span class=normal>602</span>
<span class=normal>603</span>
<span class=normal>604</span>
<span class=normal>605</span>
<span class=normal>606</span>
<span class=normal>607</span>
<span class=normal>608</span>
<span class=normal>609</span>
<span class=normal>610</span>
<span class=normal>611</span>
<span class=normal>612</span>
<span class=normal>613</span>
<span class=normal>614</span>
<span class=normal>615</span>
<span class=normal>616</span>
<span class=normal>617</span>
<span class=normal>618</span>
<span class=normal>619</span>
<span class=normal>620</span>
<span class=normal>621</span>
<span class=normal>622</span>
<span class=normal>623</span>
<span class=normal>624</span>
<span class=normal>625</span>
<span class=normal>626</span>
<span class=normal>627</span>
<span class=normal>628</span>
<span class=normal>629</span>
<span class=normal>630</span>
<span class=normal>631</span>
<span class=normal>632</span>
<span class=normal>633</span>
<span class=normal>634</span>
<span class=normal>635</span>
<span class=normal>636</span>
<span class=normal>637</span>
<span class=normal>638</span>
<span class=normal>639</span>
<span class=normal>640</span>
<span class=normal>641</span>
<span class=normal>642</span>
<span class=normal>643</span>
<span class=normal>644</span>
<span class=normal>645</span>
<span class=normal>646</span>
<span class=normal>647</span>
<span class=normal>648</span>
<span class=normal>649</span>
<span class=normal>650</span>
<span class=normal>651</span>
<span class=normal>652</span>
<span class=normal>653</span>
<span class=normal>654</span>
<span class=normal>655</span>
<span class=normal>656</span>
<span class=normal>657</span>
<span class=normal>658</span>
<span class=normal>659</span>
<span class=normal>660</span>
<span class=normal>661</span>
<span class=normal>662</span>
<span class=normal>663</span>
<span class=normal>664</span>
<span class=normal>665</span>
<span class=normal>666</span>
<span class=normal>667</span>
<span class=normal>668</span>
<span class=normal>669</span>
<span class=normal>670</span>
<span class=normal>671</span>
<span class=normal>672</span>
<span class=normal>673</span>
<span class=normal>674</span>
<span class=normal>675</span>
<span class=normal>676</span>
<span class=normal>677</span>
<span class=normal>678</span>
<span class=normal>679</span>
<span class=normal>680</span>
<span class=normal>681</span>
<span class=normal>682</span>
<span class=normal>683</span>
<span class=normal>684</span>
<span class=normal>685</span>
<span class=normal>686</span>
<span class=normal>687</span>
<span class=normal>688</span>
<span class=normal>689</span>
<span class=normal>690</span>
<span class=normal>691</span>
<span class=normal>692</span>
<span class=normal>693</span>
<span class=normal>694</span>
<span class=normal>695</span>
<span class=normal>696</span>
<span class=normal>697</span>
<span class=normal>698</span>
<span class=normal>699</span>
<span class=normal>700</span>
<span class=normal>701</span>
<span class=normal>702</span>
<span class=normal>703</span>
<span class=normal>704</span>
<span class=normal>705</span>
<span class=normal>706</span>
<span class=normal>707</span>
<span class=normal>708</span>
<span class=normal>709</span>
<span class=normal>710</span>
<span class=normal>711</span>
<span class=normal>712</span>
<span class=normal>713</span>
<span class=normal>714</span>
<span class=normal>715</span>
<span class=normal>716</span>
<span class=normal>717</span>
<span class=normal>718</span>
<span class=normal>719</span>
<span class=normal>720</span>
<span class=normal>721</span>
<span class=normal>722</span>
<span class=normal>723</span>
<span class=normal>724</span>
<span class=normal>725</span>
<span class=normal>726</span>
<span class=normal>727</span>
<span class=normal>728</span>
<span class=normal>729</span>
<span class=normal>730</span>
<span class=normal>731</span>
<span class=normal>732</span>
<span class=normal>733</span>
<span class=normal>734</span>
<span class=normal>735</span>
<span class=normal>736</span>
<span class=normal>737</span>
<span class=normal>738</span>
<span class=normal>739</span>
<span class=normal>740</span>
<span class=normal>741</span>
<span class=normal>742</span>
<span class=normal>743</span>
<span class=normal>744</span>
<span class=normal>745</span>
<span class=normal>746</span>
<span class=normal>747</span>
<span class=normal>748</span>
<span class=normal>749</span>
<span class=normal>750</span>
<span class=normal>751</span>
<span class=normal>752</span>
<span class=normal>753</span>
<span class=normal>754</span>
<span class=normal>755</span>
<span class=normal>756</span>
<span class=normal>757</span>
<span class=normal>758</span>
<span class=normal>759</span>
<span class=normal>760</span>
<span class=normal>761</span>
<span class=normal>762</span>
<span class=normal>763</span>
<span class=normal>764</span>
<span class=normal>765</span>
<span class=normal>766</span>
<span class=normal>767</span>
<span class=normal>768</span>
<span class=normal>769</span>
<span class=normal>770</span>
<span class=normal>771</span>
<span class=normal>772</span>
<span class=normal>773</span>
<span class=normal>774</span>
<span class=normal>775</span>
<span class=normal>776</span>
<span class=normal>777</span>
<span class=normal>778</span>
<span class=normal>779</span>
<span class=normal>780</span>
<span class=normal>781</span>
<span class=normal>782</span>
<span class=normal>783</span>
<span class=normal>784</span>
<span class=normal>785</span>
<span class=normal>786</span>
<span class=normal>787</span>
<span class=normal>788</span>
<span class=normal>789</span>
<span class=normal>790</span>
<span class=normal>791</span>
<span class=normal>792</span>
<span class=normal>793</span>
<span class=normal>794</span>
<span class=normal>795</span>
<span class=normal>796</span>
<span class=normal>797</span>
<span class=normal>798</span>
<span class=normal>799</span>
<span class=normal>800</span>
<span class=normal>801</span>
<span class=normal>802</span>
<span class=normal>803</span>
<span class=normal>804</span>
<span class=normal>805</span>
<span class=normal>806</span>
<span class=normal>807</span>
<span class=normal>808</span>
<span class=normal>809</span>
<span class=normal>810</span>
<span class=normal>811</span>
<span class=normal>812</span>
<span class=normal>813</span>
<span class=normal>814</span>
<span class=normal>815</span>
<span class=normal>816</span>
<span class=normal>817</span>
<span class=normal>818</span>
<span class=normal>819</span>
<span class=normal>820</span>
<span class=normal>821</span>
<span class=normal>822</span>
<span class=normal>823</span>
<span class=normal>824</span>
<span class=normal>825</span>
<span class=normal>826</span>
<span class=normal>827</span>
<span class=normal>828</span>
<span class=normal>829</span>
<span class=normal>830</span>
<span class=normal>831</span>
<span class=normal>832</span>
<span class=normal>833</span>
<span class=normal>834</span>
<span class=normal>835</span>
<span class=normal>836</span>
<span class=normal>837</span>
<span class=normal>838</span>
<span class=normal>839</span>
<span class=normal>840</span>
<span class=normal>841</span>
<span class=normal>842</span>
<span class=normal>843</span>
<span class=normal>844</span>
<span class=normal>845</span>
<span class=normal>846</span>
<span class=normal>847</span>
<span class=normal>848</span>
<span class=normal>849</span>
<span class=normal>850</span>
<span class=normal>851</span>
<span class=normal>852</span>
<span class=normal>853</span>
<span class=normal>854</span>
<span class=normal>855</span>
<span class=normal>856</span>
<span class=normal>857</span>
<span class=normal>858</span>
<span class=normal>859</span>
<span class=normal>860</span>
<span class=normal>861</span>
<span class=normal>862</span>
<span class=normal>863</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>launch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>session</span><span class=p>,</span> <span class=n>event</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Main entry port for synchronization.</span>
<span class=sd>        Goes through event (can contain multiple changes) and decides if</span>
<span class=sd>        the event is interesting for us (interest_entTypes).</span>
<span class=sd>        It separates changes into add|remove|update.</span>
<span class=sd>        All task changes are handled together by refresh from ftrack.</span>
<span class=sd>    Args:</span>
<span class=sd>        session (object): session to ftrack</span>
<span class=sd>        event (dictionary): event content</span>

<span class=sd>    Returns:</span>
<span class=sd>        (boolean or None)</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=c1># Try to commit and if any error happen then recreate session</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>set_process_session</span><span class=p>(</span><span class=n>session</span><span class=p>)</span>
    <span class=c1># Reset object values for each launch</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>reset_variables</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_cur_event</span> <span class=o>=</span> <span class=n>event</span>

    <span class=n>entities_by_action</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;remove&quot;</span><span class=p>:</span> <span class=p>{},</span>
        <span class=s2>&quot;update&quot;</span><span class=p>:</span> <span class=p>{},</span>
        <span class=s2>&quot;move&quot;</span><span class=p>:</span> <span class=p>{},</span>
        <span class=s2>&quot;add&quot;</span><span class=p>:</span> <span class=p>{}</span>
    <span class=p>}</span>

    <span class=n>entities_info</span> <span class=o>=</span> <span class=n>event</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entities&quot;</span><span class=p>]</span>
    <span class=n>found_actions</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>
    <span class=k>for</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>entities_info</span><span class=p>:</span>
        <span class=n>entityType</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>entityType</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>interest_entTypes</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>entity_type</span> <span class=o>=</span> <span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;entity_type&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>entity_type</span> <span class=ow>or</span> <span class=n>entity_type</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>ignore_ent_types</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=k>if</span> <span class=n>entity_type</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span><span class=p>[</span><span class=n>entityType</span><span class=p>]:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>debug_sync_types</span><span class=p>[</span><span class=n>entityType</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>entity_type</span><span class=p>)</span>

        <span class=n>action</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;action&quot;</span><span class=p>]</span>
        <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityId&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>((</span>
                <span class=s2>&quot;BUG REPORT: Entity info has `entityId` as `list` </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span>
            <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ent_info</span><span class=p>))</span>
            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
                <span class=k>continue</span>
            <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>ftrack_id</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>

        <span class=c1># Skip deleted projects</span>
        <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;remove&quot;</span> <span class=ow>and</span> <span class=n>entityType</span> <span class=o>==</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>True</span>

        <span class=c1># task modified, collect parent id of task, handle separately</span>
        <span class=k>if</span> <span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
            <span class=n>changes</span> <span class=o>=</span> <span class=n>ent_info</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;changes&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>{}</span>
            <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;move&quot;</span><span class=p>:</span>
                <span class=n>parent_changes</span> <span class=o>=</span> <span class=n>changes</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>parent_changes</span><span class=p>[</span><span class=s2>&quot;new&quot;</span><span class=p>])</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>parent_changes</span><span class=p>[</span><span class=s2>&quot;old&quot;</span><span class=p>])</span>

            <span class=k>elif</span> <span class=s2>&quot;typeid&quot;</span> <span class=ow>in</span> <span class=n>changes</span> <span class=ow>or</span> <span class=s2>&quot;name&quot;</span> <span class=ow>in</span> <span class=n>changes</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;parentId&quot;</span><span class=p>])</span>
            <span class=k>continue</span>

        <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;move&quot;</span><span class=p>:</span>
            <span class=n>ent_keys</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span>
            <span class=c1># Separate update info from move action</span>
            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>ent_keys</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
                <span class=n>_ent_info</span> <span class=o>=</span> <span class=n>ent_info</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
                <span class=k>for</span> <span class=n>ent_key</span> <span class=ow>in</span> <span class=n>ent_keys</span><span class=p>:</span>
                    <span class=k>if</span> <span class=n>ent_key</span> <span class=o>==</span> <span class=s2>&quot;parent_id&quot;</span><span class=p>:</span>
                        <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                        <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>
                    <span class=k>else</span><span class=p>:</span>
                        <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                        <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>
                <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;update&quot;</span><span class=p>][</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>_ent_info</span>
        <span class=c1># regular change process handles all other than Tasks</span>
        <span class=n>found_actions</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
        <span class=n>entities_by_action</span><span class=p>[</span><span class=n>action</span><span class=p>][</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ent_info</span>

    <span class=n>found_actions</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>found_actions</span><span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>found_actions</span> <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=p>:</span>
        <span class=k>return</span> <span class=kc>True</span>

    <span class=c1># Check if auto sync was turned on/off</span>
    <span class=n>updated</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;update&quot;</span><span class=p>]</span>
    <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>updated</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=c1># filter project</span>
        <span class=k>if</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span> <span class=o>!=</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>changes</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>CUST_ATTR_AUTO_SYNC</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>changes</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>auto_sync</span> <span class=o>=</span> <span class=n>changes</span><span class=p>[</span><span class=n>CUST_ATTR_AUTO_SYNC</span><span class=p>][</span><span class=s2>&quot;new&quot;</span><span class=p>]</span>
        <span class=n>turned_on</span> <span class=o>=</span> <span class=n>auto_sync</span> <span class=o>==</span> <span class=s2>&quot;1&quot;</span>
        <span class=n>ft_project</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
        <span class=n>username</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_get_username</span><span class=p>(</span><span class=n>session</span><span class=p>,</span> <span class=n>event</span><span class=p>)</span>
        <span class=n>message</span> <span class=o>=</span> <span class=p>(</span>
            <span class=s2>&quot;Auto sync was turned </span><span class=si>{}</span><span class=s2> for project </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> by </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>.&quot;</span>
        <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=s2>&quot;on&quot;</span> <span class=k>if</span> <span class=n>turned_on</span> <span class=k>else</span> <span class=s2>&quot;off&quot;</span><span class=p>,</span>
            <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>],</span>
            <span class=n>username</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=n>turned_on</span><span class=p>:</span>
            <span class=n>message</span> <span class=o>+=</span> <span class=s2>&quot; Triggering syncToAvalon action.&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=n>message</span><span class=p>)</span>

        <span class=k>if</span> <span class=n>turned_on</span><span class=p>:</span>
            <span class=c1># Trigger sync to avalon action if auto sync was turned on</span>
            <span class=n>selection</span> <span class=o>=</span> <span class=p>[{</span>
                <span class=s2>&quot;entityId&quot;</span><span class=p>:</span> <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span>
                <span class=s2>&quot;entityType&quot;</span><span class=p>:</span> <span class=s2>&quot;show&quot;</span>
            <span class=p>}]</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>trigger_action</span><span class=p>(</span>
                <span class=n>action_name</span><span class=o>=</span><span class=s2>&quot;sync.to.avalon.server&quot;</span><span class=p>,</span>
                <span class=n>event</span><span class=o>=</span><span class=n>event</span><span class=p>,</span>
                <span class=n>selection</span><span class=o>=</span><span class=n>selection</span>
            <span class=p>)</span>
        <span class=c1># Exit for both cases</span>
        <span class=k>return</span> <span class=kc>True</span>

    <span class=c1># Filter updated data by changed keys</span>
    <span class=n>updated</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>filter_updated</span><span class=p>(</span><span class=n>updated</span><span class=p>)</span>

    <span class=c1># skip most of events where nothing has changed for avalon</span>
    <span class=k>if</span> <span class=p>(</span>
        <span class=nb>len</span><span class=p>(</span><span class=n>found_actions</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span>
        <span class=ow>and</span> <span class=n>found_actions</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;update&quot;</span>
        <span class=ow>and</span> <span class=ow>not</span> <span class=n>updated</span>
        <span class=ow>and</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
    <span class=p>):</span>
        <span class=k>return</span> <span class=kc>True</span>

    <span class=n>ft_project</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
    <span class=c1># Check if auto-sync custom attribute exists</span>
    <span class=k>if</span> <span class=n>CUST_ATTR_AUTO_SYNC</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>]:</span>
        <span class=c1># TODO should we sent message to someone?</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>error</span><span class=p>((</span>
            <span class=s2>&quot;Custom attribute </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> is not created or user </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> used&quot;</span>
            <span class=s2>&quot; for Event server don&#39;t have permissions to access it!&quot;</span>
        <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>CUST_ATTR_AUTO_SYNC</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>session</span><span class=o>.</span><span class=n>api_user</span><span class=p>))</span>
        <span class=k>return</span> <span class=kc>True</span>

    <span class=c1># Skip if auto-sync is not set</span>
    <span class=n>auto_sync</span> <span class=o>=</span> <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>CUST_ATTR_AUTO_SYNC</span><span class=p>]</span>
    <span class=k>if</span> <span class=n>auto_sync</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>True</span><span class=p>:</span>
        <span class=k>return</span> <span class=kc>True</span>

    <span class=n>debug_msg</span> <span class=o>=</span> <span class=s2>&quot;Updated: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>updated</span><span class=p>))</span>
    <span class=n>debug_action_map</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;add&quot;</span><span class=p>:</span> <span class=s2>&quot;Created&quot;</span><span class=p>,</span>
        <span class=s2>&quot;remove&quot;</span><span class=p>:</span> <span class=s2>&quot;Removed&quot;</span><span class=p>,</span>
        <span class=s2>&quot;move&quot;</span><span class=p>:</span> <span class=s2>&quot;Moved&quot;</span>
    <span class=p>}</span>
    <span class=k>for</span> <span class=n>action</span><span class=p>,</span> <span class=n>infos</span> <span class=ow>in</span> <span class=n>entities_by_action</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&quot;update&quot;</span><span class=p>:</span>
            <span class=k>continue</span>
        <span class=n>_action</span> <span class=o>=</span> <span class=n>debug_action_map</span><span class=p>[</span><span class=n>action</span><span class=p>]</span>
        <span class=n>debug_msg</span> <span class=o>+=</span> <span class=s2>&quot;| </span><span class=si>{}</span><span class=s2>: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>_action</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>infos</span><span class=p>))</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Project changes &lt;</span><span class=si>{}</span><span class=s2>&gt;: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
        <span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>],</span> <span class=n>debug_msg</span>
    <span class=p>))</span>
    <span class=c1># Get ftrack entities - find all ftrack ids first</span>
    <span class=n>ftrack_ids</span> <span class=o>=</span> <span class=nb>set</span><span class=p>(</span><span class=n>updated</span><span class=o>.</span><span class=n>keys</span><span class=p>())</span>

    <span class=k>for</span> <span class=n>action</span><span class=p>,</span> <span class=n>_ftrack_ids</span> <span class=ow>in</span> <span class=n>entities_by_action</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=c1># skip updated (already prepared) and removed (not exist in ftrack)</span>
        <span class=k>if</span> <span class=n>action</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&quot;remove&quot;</span><span class=p>,</span> <span class=s2>&quot;update&quot;</span><span class=p>):</span>
            <span class=n>ftrack_ids</span> <span class=o>|=</span> <span class=nb>set</span><span class=p>(</span><span class=n>_ftrack_ids</span><span class=p>)</span>

    <span class=c1># collect entity records data which might not be in event</span>
    <span class=k>if</span> <span class=n>ftrack_ids</span><span class=p>:</span>
        <span class=n>joined_ids</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span><span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>id</span><span class=p>)</span> <span class=k>for</span> <span class=nb>id</span> <span class=ow>in</span> <span class=n>ftrack_ids</span><span class=p>])</span>
        <span class=n>ftrack_entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ft_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joined_ids</span><span class=p>)</span>
        <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
        <span class=k>for</span> <span class=n>entity</span> <span class=ow>in</span> <span class=n>ftrack_entities</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=n>entity</span>

    <span class=c1># Filter updates where name is changing</span>
    <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>updated</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>ent_keys</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span>
        <span class=c1># Seprate update info from rename</span>
        <span class=k>if</span> <span class=s2>&quot;name&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ent_keys</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>_ent_info</span> <span class=o>=</span> <span class=n>copy</span><span class=o>.</span><span class=n>deepcopy</span><span class=p>(</span><span class=n>ent_info</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>ent_key</span> <span class=ow>in</span> <span class=n>ent_keys</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>ent_key</span> <span class=o>==</span> <span class=s2>&quot;name&quot;</span><span class=p>:</span>
                <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ent_key</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
                <span class=n>_ent_info</span><span class=p>[</span><span class=s2>&quot;keys&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=n>ent_key</span><span class=p>)</span>

        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_renamed</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>_ent_info</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;remove&quot;</span><span class=p>]</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;move&quot;</span><span class=p>]</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_added</span> <span class=o>=</span> <span class=n>entities_by_action</span><span class=p>[</span><span class=s2>&quot;add&quot;</span><span class=p>]</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span> <span class=o>=</span> <span class=n>updated</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>debug_logs</span><span class=p>()</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Synchronization begins&quot;</span><span class=p>)</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>time_1</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
        <span class=c1># 1.) Process removed - may affect all other actions</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_removed</span><span class=p>()</span>
        <span class=n>time_2</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
        <span class=c1># 2.) Process renamed - may affect added</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_renamed</span><span class=p>()</span>
        <span class=n>time_3</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
        <span class=c1># 3.) Process added - moved entity may be moved to new entity</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_added</span><span class=p>()</span>
        <span class=n>time_4</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
        <span class=c1># 4.) Process moved</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_moved</span><span class=p>()</span>
        <span class=n>time_5</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
        <span class=c1># 5.) Process updated</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_updated</span><span class=p>()</span>
        <span class=n>time_6</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
        <span class=c1># 6.) Process changes in hierarchy or hier custom attribues</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_hier_cleanup</span><span class=p>()</span>
        <span class=n>time_7</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>process_task_updates</span><span class=p>()</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>update_entities</span><span class=p>()</span>
        <span class=n>time_8</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>

        <span class=n>time_removed</span> <span class=o>=</span> <span class=n>time_2</span> <span class=o>-</span> <span class=n>time_1</span>
        <span class=n>time_renamed</span> <span class=o>=</span> <span class=n>time_3</span> <span class=o>-</span> <span class=n>time_2</span>
        <span class=n>time_added</span> <span class=o>=</span> <span class=n>time_4</span> <span class=o>-</span> <span class=n>time_3</span>
        <span class=n>time_moved</span> <span class=o>=</span> <span class=n>time_5</span> <span class=o>-</span> <span class=n>time_4</span>
        <span class=n>time_updated</span> <span class=o>=</span> <span class=n>time_6</span> <span class=o>-</span> <span class=n>time_5</span>
        <span class=n>time_cleanup</span> <span class=o>=</span> <span class=n>time_7</span> <span class=o>-</span> <span class=n>time_6</span>
        <span class=n>time_task_updates</span> <span class=o>=</span> <span class=n>time_8</span> <span class=o>-</span> <span class=n>time_7</span>
        <span class=n>time_total</span> <span class=o>=</span> <span class=n>time_8</span> <span class=o>-</span> <span class=n>time_1</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
            <span class=s2>&quot;Process time: </span><span class=si>{:.2f}</span><span class=s2> &lt;</span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, &quot;</span>
            <span class=s2>&quot;</span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>, </span><span class=si>{:.2f}</span><span class=s2>&gt;&quot;</span>
        <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=n>time_total</span><span class=p>,</span> <span class=n>time_removed</span><span class=p>,</span> <span class=n>time_renamed</span><span class=p>,</span> <span class=n>time_added</span><span class=p>,</span>
            <span class=n>time_moved</span><span class=p>,</span> <span class=n>time_updated</span><span class=p>,</span> <span class=n>time_cleanup</span><span class=p>,</span> <span class=n>time_task_updates</span>
        <span class=p>))</span>

    <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
        <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;An error has happened during synchronization&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;error&quot;</span><span class=p>][</span><span class=n>msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>((</span>
            <span class=nb>str</span><span class=p>(</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>())</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&lt;br&gt;&quot;</span><span class=p>)</span>
        <span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;&amp;nbsp;&quot;</span><span class=p>))</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>report</span><span class=p>()</span>
    <span class=k>return</span> <span class=kc>True</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_moved class="doc doc-heading"> <code class="highlight language-python"><span class=n>process_moved</span><span class=p>()</span></code> </h3> <div class="doc doc-contents "> <p>Handles moved entities to different place in hiearchy. (Not tasks - handled separately.)</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1750</span>
<span class=normal>1751</span>
<span class=normal>1752</span>
<span class=normal>1753</span>
<span class=normal>1754</span>
<span class=normal>1755</span>
<span class=normal>1756</span>
<span class=normal>1757</span>
<span class=normal>1758</span>
<span class=normal>1759</span>
<span class=normal>1760</span>
<span class=normal>1761</span>
<span class=normal>1762</span>
<span class=normal>1763</span>
<span class=normal>1764</span>
<span class=normal>1765</span>
<span class=normal>1766</span>
<span class=normal>1767</span>
<span class=normal>1768</span>
<span class=normal>1769</span>
<span class=normal>1770</span>
<span class=normal>1771</span>
<span class=normal>1772</span>
<span class=normal>1773</span>
<span class=normal>1774</span>
<span class=normal>1775</span>
<span class=normal>1776</span>
<span class=normal>1777</span>
<span class=normal>1778</span>
<span class=normal>1779</span>
<span class=normal>1780</span>
<span class=normal>1781</span>
<span class=normal>1782</span>
<span class=normal>1783</span>
<span class=normal>1784</span>
<span class=normal>1785</span>
<span class=normal>1786</span>
<span class=normal>1787</span>
<span class=normal>1788</span>
<span class=normal>1789</span>
<span class=normal>1790</span>
<span class=normal>1791</span>
<span class=normal>1792</span>
<span class=normal>1793</span>
<span class=normal>1794</span>
<span class=normal>1795</span>
<span class=normal>1796</span>
<span class=normal>1797</span>
<span class=normal>1798</span>
<span class=normal>1799</span>
<span class=normal>1800</span>
<span class=normal>1801</span>
<span class=normal>1802</span>
<span class=normal>1803</span>
<span class=normal>1804</span>
<span class=normal>1805</span>
<span class=normal>1806</span>
<span class=normal>1807</span>
<span class=normal>1808</span>
<span class=normal>1809</span>
<span class=normal>1810</span>
<span class=normal>1811</span>
<span class=normal>1812</span>
<span class=normal>1813</span>
<span class=normal>1814</span>
<span class=normal>1815</span>
<span class=normal>1816</span>
<span class=normal>1817</span>
<span class=normal>1818</span>
<span class=normal>1819</span>
<span class=normal>1820</span>
<span class=normal>1821</span>
<span class=normal>1822</span>
<span class=normal>1823</span>
<span class=normal>1824</span>
<span class=normal>1825</span>
<span class=normal>1826</span>
<span class=normal>1827</span>
<span class=normal>1828</span>
<span class=normal>1829</span>
<span class=normal>1830</span>
<span class=normal>1831</span>
<span class=normal>1832</span>
<span class=normal>1833</span>
<span class=normal>1834</span>
<span class=normal>1835</span>
<span class=normal>1836</span>
<span class=normal>1837</span>
<span class=normal>1838</span>
<span class=normal>1839</span>
<span class=normal>1840</span>
<span class=normal>1841</span>
<span class=normal>1842</span>
<span class=normal>1843</span>
<span class=normal>1844</span>
<span class=normal>1845</span>
<span class=normal>1846</span>
<span class=normal>1847</span>
<span class=normal>1848</span>
<span class=normal>1849</span>
<span class=normal>1850</span>
<span class=normal>1851</span>
<span class=normal>1852</span>
<span class=normal>1853</span>
<span class=normal>1854</span>
<span class=normal>1855</span>
<span class=normal>1856</span>
<span class=normal>1857</span>
<span class=normal>1858</span>
<span class=normal>1859</span>
<span class=normal>1860</span>
<span class=normal>1861</span>
<span class=normal>1862</span>
<span class=normal>1863</span>
<span class=normal>1864</span>
<span class=normal>1865</span>
<span class=normal>1866</span>
<span class=normal>1867</span>
<span class=normal>1868</span>
<span class=normal>1869</span>
<span class=normal>1870</span>
<span class=normal>1871</span>
<span class=normal>1872</span>
<span class=normal>1873</span>
<span class=normal>1874</span>
<span class=normal>1875</span>
<span class=normal>1876</span>
<span class=normal>1877</span>
<span class=normal>1878</span>
<span class=normal>1879</span>
<span class=normal>1880</span>
<span class=normal>1881</span>
<span class=normal>1882</span>
<span class=normal>1883</span>
<span class=normal>1884</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>process_moved</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Handles moved entities to different place in hiearchy.</span>
<span class=sd>        (Not tasks - handled separately.)</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
        <span class=s2>&quot;Processing moved entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span><span class=p>))</span>
    <span class=p>)</span>

    <span class=n>ftrack_moved</span> <span class=o>=</span> <span class=p>{</span><span class=n>k</span><span class=p>:</span> <span class=n>v</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span> <span class=n>v</span> <span class=ow>in</span> <span class=nb>sorted</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span><span class=o>.</span><span class=n>items</span><span class=p>(),</span>
        <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>line</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span>
            <span class=p>(</span><span class=n>line</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;data&quot;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[])</span>
        <span class=p>))</span>
    <span class=p>)}</span>

    <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ftrack_moved</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_ent</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>new_parent_id</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>][</span><span class=s2>&quot;parent_id&quot;</span><span class=p>][</span><span class=s2>&quot;new&quot;</span><span class=p>]</span>

        <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>changeability_by_mongo_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
            <span class=n>par_av_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>new_parent_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>par_av_ent</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=c1># TODO report</span>
                <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]]</span>
                <span class=n>ent_path_items</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>])</span>
                <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>

                <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;New parent of entity is not synchronized to avalon&quot;</span>
                <span class=p>)</span>
                <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Parent in Avalon can&#39;t be changed. That&quot;</span>
                    <span class=s2>&quot; may cause issues. Please fix parent or move entity&quot;</span>
                    <span class=s2>&quot; under valid entity.&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>

                <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>))</span>
                <span class=k>continue</span>

            <span class=c1># THIS MUST HAPPEND AFTER CREATING NEW ENTITIES !!!!</span>
            <span class=c1># - because may be moved to new created entity</span>
            <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

            <span class=n>vis_par_id</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]]</span>
            <span class=k>if</span> <span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>!=</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
                <span class=n>vis_par_id</span> <span class=o>=</span> <span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                <span class=n>ent_path_items</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>])</span>
                <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>par_av_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>vis_par_id</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>moved_in_avalon</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>

            <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
            <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>((</span>
                <span class=s2>&quot;Parent of entity (</span><span class=si>{}</span><span class=s2>) was changed in avalon &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>),</span> <span class=n>ent_path</span><span class=p>)</span>
            <span class=p>)</span>

        <span class=k>else</span><span class=p>:</span>
            <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
            <span class=n>avalon_parent_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>avalon_parent_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>avalon_parent_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;parent&quot;</span><span class=p>]</span>

            <span class=n>avalon_parent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>avalon_parent_id</span><span class=p>]</span>
            <span class=n>parent_id</span> <span class=o>=</span> <span class=n>avalon_parent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>

            <span class=c1># For cases when parent was deleted at the same time</span>
            <span class=k>if</span> <span class=n>parent_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span><span class=p>:</span>
                <span class=n>parent_id</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span><span class=p>[</span><span class=n>parent_id</span><span class=p>]</span>
                <span class=p>)</span>

            <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>ftrack_ent</span><span class=p>:</span>
                <span class=n>ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>ftrack_id</span>
                    <span class=p>)</span>
                <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>ftrack_ent</span>

            <span class=k>if</span> <span class=n>parent_id</span> <span class=o>==</span> <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]:</span>
                <span class=k>continue</span>

            <span class=n>ftrack_ent</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>parent_id</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
                <span class=c1># TODO logging</span>
                <span class=c1># TODO report</span>
                <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;Entity was moved back&quot;</span>
                <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Entity can&#39;t be moved when&quot;</span>
                    <span class=s2>&quot; it or its children contain published data&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;info&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span><span class=s2>&quot;</span><span class=si>{}</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>))</span>

            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rollback</span><span class=p>()</span>
                <span class=c1># TODO logging</span>
                <span class=c1># TODO report</span>
                <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;Couldn&#39;t moved the entity back to its original parent&quot;</span>
                <span class=p>)</span>
                <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Moved back because it is not possible to&quot;</span>
                    <span class=s2>&quot; move with an entity or it&#39;s parents, &quot;</span>
                    <span class=s2>&quot; if it already contained published data.&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                <span class=n>error_traceback</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=nb>str</span><span class=p>(</span><span class=n>traceback</span><span class=o>.</span><span class=n>format_exc</span><span class=p>())</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&lt;br&gt;&quot;</span><span class=p>)</span>
                <span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>,</span> <span class=s2>&quot;&amp;nbsp;&quot;</span><span class=p>)</span>

                <span class=n>item_msg</span> <span class=o>=</span> <span class=n>ent_path</span> <span class=o>+</span> <span class=s2>&quot;&lt;br&gt;&quot;</span> <span class=o>+</span> <span class=n>error_traceback</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>item_msg</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>: </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span><span class=p>),</span>
                    <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                <span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_removed class="doc doc-heading"> <code class="highlight language-python"><span class=n>process_removed</span><span class=p>()</span></code> </h3> <div class="doc doc-contents "> <p>Handles removed entities (not removed tasks - handle separately).</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal> 885</span>
<span class=normal> 886</span>
<span class=normal> 887</span>
<span class=normal> 888</span>
<span class=normal> 889</span>
<span class=normal> 890</span>
<span class=normal> 891</span>
<span class=normal> 892</span>
<span class=normal> 893</span>
<span class=normal> 894</span>
<span class=normal> 895</span>
<span class=normal> 896</span>
<span class=normal> 897</span>
<span class=normal> 898</span>
<span class=normal> 899</span>
<span class=normal> 900</span>
<span class=normal> 901</span>
<span class=normal> 902</span>
<span class=normal> 903</span>
<span class=normal> 904</span>
<span class=normal> 905</span>
<span class=normal> 906</span>
<span class=normal> 907</span>
<span class=normal> 908</span>
<span class=normal> 909</span>
<span class=normal> 910</span>
<span class=normal> 911</span>
<span class=normal> 912</span>
<span class=normal> 913</span>
<span class=normal> 914</span>
<span class=normal> 915</span>
<span class=normal> 916</span>
<span class=normal> 917</span>
<span class=normal> 918</span>
<span class=normal> 919</span>
<span class=normal> 920</span>
<span class=normal> 921</span>
<span class=normal> 922</span>
<span class=normal> 923</span>
<span class=normal> 924</span>
<span class=normal> 925</span>
<span class=normal> 926</span>
<span class=normal> 927</span>
<span class=normal> 928</span>
<span class=normal> 929</span>
<span class=normal> 930</span>
<span class=normal> 931</span>
<span class=normal> 932</span>
<span class=normal> 933</span>
<span class=normal> 934</span>
<span class=normal> 935</span>
<span class=normal> 936</span>
<span class=normal> 937</span>
<span class=normal> 938</span>
<span class=normal> 939</span>
<span class=normal> 940</span>
<span class=normal> 941</span>
<span class=normal> 942</span>
<span class=normal> 943</span>
<span class=normal> 944</span>
<span class=normal> 945</span>
<span class=normal> 946</span>
<span class=normal> 947</span>
<span class=normal> 948</span>
<span class=normal> 949</span>
<span class=normal> 950</span>
<span class=normal> 951</span>
<span class=normal> 952</span>
<span class=normal> 953</span>
<span class=normal> 954</span>
<span class=normal> 955</span>
<span class=normal> 956</span>
<span class=normal> 957</span>
<span class=normal> 958</span>
<span class=normal> 959</span>
<span class=normal> 960</span>
<span class=normal> 961</span>
<span class=normal> 962</span>
<span class=normal> 963</span>
<span class=normal> 964</span>
<span class=normal> 965</span>
<span class=normal> 966</span>
<span class=normal> 967</span>
<span class=normal> 968</span>
<span class=normal> 969</span>
<span class=normal> 970</span>
<span class=normal> 971</span>
<span class=normal> 972</span>
<span class=normal> 973</span>
<span class=normal> 974</span>
<span class=normal> 975</span>
<span class=normal> 976</span>
<span class=normal> 977</span>
<span class=normal> 978</span>
<span class=normal> 979</span>
<span class=normal> 980</span>
<span class=normal> 981</span>
<span class=normal> 982</span>
<span class=normal> 983</span>
<span class=normal> 984</span>
<span class=normal> 985</span>
<span class=normal> 986</span>
<span class=normal> 987</span>
<span class=normal> 988</span>
<span class=normal> 989</span>
<span class=normal> 990</span>
<span class=normal> 991</span>
<span class=normal> 992</span>
<span class=normal> 993</span>
<span class=normal> 994</span>
<span class=normal> 995</span>
<span class=normal> 996</span>
<span class=normal> 997</span>
<span class=normal> 998</span>
<span class=normal> 999</span>
<span class=normal>1000</span>
<span class=normal>1001</span>
<span class=normal>1002</span>
<span class=normal>1003</span>
<span class=normal>1004</span>
<span class=normal>1005</span>
<span class=normal>1006</span>
<span class=normal>1007</span>
<span class=normal>1008</span>
<span class=normal>1009</span>
<span class=normal>1010</span>
<span class=normal>1011</span>
<span class=normal>1012</span>
<span class=normal>1013</span>
<span class=normal>1014</span>
<span class=normal>1015</span>
<span class=normal>1016</span>
<span class=normal>1017</span>
<span class=normal>1018</span>
<span class=normal>1019</span>
<span class=normal>1020</span>
<span class=normal>1021</span>
<span class=normal>1022</span>
<span class=normal>1023</span>
<span class=normal>1024</span>
<span class=normal>1025</span>
<span class=normal>1026</span>
<span class=normal>1027</span>
<span class=normal>1028</span>
<span class=normal>1029</span>
<span class=normal>1030</span>
<span class=normal>1031</span>
<span class=normal>1032</span>
<span class=normal>1033</span>
<span class=normal>1034</span>
<span class=normal>1035</span>
<span class=normal>1036</span>
<span class=normal>1037</span>
<span class=normal>1038</span>
<span class=normal>1039</span>
<span class=normal>1040</span>
<span class=normal>1041</span>
<span class=normal>1042</span>
<span class=normal>1043</span>
<span class=normal>1044</span>
<span class=normal>1045</span>
<span class=normal>1046</span>
<span class=normal>1047</span>
<span class=normal>1048</span>
<span class=normal>1049</span>
<span class=normal>1050</span>
<span class=normal>1051</span>
<span class=normal>1052</span>
<span class=normal>1053</span>
<span class=normal>1054</span>
<span class=normal>1055</span>
<span class=normal>1056</span>
<span class=normal>1057</span>
<span class=normal>1058</span>
<span class=normal>1059</span>
<span class=normal>1060</span>
<span class=normal>1061</span>
<span class=normal>1062</span>
<span class=normal>1063</span>
<span class=normal>1064</span>
<span class=normal>1065</span>
<span class=normal>1066</span>
<span class=normal>1067</span>
<span class=normal>1068</span>
<span class=normal>1069</span>
<span class=normal>1070</span>
<span class=normal>1071</span>
<span class=normal>1072</span>
<span class=normal>1073</span>
<span class=normal>1074</span>
<span class=normal>1075</span>
<span class=normal>1076</span>
<span class=normal>1077</span>
<span class=normal>1078</span>
<span class=normal>1079</span>
<span class=normal>1080</span>
<span class=normal>1081</span>
<span class=normal>1082</span>
<span class=normal>1083</span>
<span class=normal>1084</span>
<span class=normal>1085</span>
<span class=normal>1086</span>
<span class=normal>1087</span>
<span class=normal>1088</span>
<span class=normal>1089</span>
<span class=normal>1090</span>
<span class=normal>1091</span>
<span class=normal>1092</span>
<span class=normal>1093</span>
<span class=normal>1094</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>process_removed</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Handles removed entities (not removed tasks - handle separately).</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span><span class=p>:</span>
        <span class=k>return</span>
    <span class=n>ent_infos</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
        <span class=s2>&quot;Processing removed entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=n>ent_infos</span><span class=p>))</span>
    <span class=p>)</span>
    <span class=n>removable_ids</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>recreate_ents</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>removed_names</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>removed</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>entity_type</span> <span class=o>=</span> <span class=n>removed</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>entity_type</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
            <span class=k>continue</span>

        <span class=n>removed_name</span> <span class=o>=</span> <span class=n>removed</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>][</span><span class=s2>&quot;name&quot;</span><span class=p>][</span><span class=s2>&quot;old&quot;</span><span class=p>]</span>

        <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_ent</span><span class=p>:</span>
            <span class=k>continue</span>
        <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>changeability_by_mongo_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
            <span class=n>removable_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>mongo_id</span><span class=p>)</span>
            <span class=n>removed_names</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>removed_name</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>recreate_ents</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_ent</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>removable_ids</span><span class=p>:</span>
        <span class=c1># TODO logging</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>&quot;Assets marked as archived &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>removed_names</span><span class=p>)</span>
        <span class=p>))</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>update_many</span><span class=p>(</span>
            <span class=p>{</span><span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;$in&quot;</span><span class=p>:</span> <span class=n>removable_ids</span><span class=p>},</span> <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;asset&quot;</span><span class=p>},</span>
            <span class=p>{</span><span class=s2>&quot;$set&quot;</span><span class=p>:</span> <span class=p>{</span><span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=s2>&quot;archived_asset&quot;</span><span class=p>}}</span>
        <span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>remove_cached_by_key</span><span class=p>(</span><span class=s2>&quot;id&quot;</span><span class=p>,</span> <span class=n>removable_ids</span><span class=p>)</span>

    <span class=k>if</span> <span class=n>recreate_ents</span><span class=p>:</span>
        <span class=c1># sort removed entities by parents len</span>
        <span class=c1># - length of parents determine hierarchy level</span>
        <span class=n>recreate_ents</span> <span class=o>=</span> <span class=nb>sorted</span><span class=p>(</span>
            <span class=n>recreate_ents</span><span class=p>,</span>
            <span class=n>key</span><span class=o>=</span><span class=p>(</span><span class=k>lambda</span> <span class=n>item</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span>
                <span class=p>(</span><span class=n>item</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;data&quot;</span><span class=p>,</span> <span class=p>{})</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;parents&quot;</span><span class=p>)</span> <span class=ow>or</span> <span class=p>[])</span>
            <span class=p>))</span>
        <span class=p>)</span>
        <span class=c1># TODO logging</span>
        <span class=c1># TODO report</span>
        <span class=n>recreate_msg</span> <span class=o>=</span> <span class=p>(</span>
            <span class=s2>&quot;Deleted entity was recreated||Entity was recreated because&quot;</span>
            <span class=s2>&quot; it or its children contain published data&quot;</span>
        <span class=p>)</span>
        <span class=n>proj</span><span class=p>,</span> <span class=n>ents</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_entities</span>
        <span class=k>for</span> <span class=n>avalon_entity</span> <span class=ow>in</span> <span class=n>recreate_ents</span><span class=p>:</span>
            <span class=n>old_ftrack_id</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span>
            <span class=n>vis_par</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
            <span class=k>if</span> <span class=n>vis_par</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>vis_par</span> <span class=o>=</span> <span class=n>proj</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
            <span class=n>parent_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span>

            <span class=n>parent_ftrack_id</span> <span class=o>=</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>handle_missing_ftrack_id</span><span class=p>(</span><span class=n>parent_ent</span><span class=p>)</span>
                <span class=n>parent_ftrack_id</span> <span class=o>=</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>)</span>
                <span class=k>if</span> <span class=n>parent_ftrack_id</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                    <span class=k>continue</span>

            <span class=n>parent_ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span>
                <span class=n>parent_ftrack_id</span>
            <span class=p>)</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>parent_ftrack_ent</span><span class=p>:</span>
                <span class=k>if</span> <span class=n>parent_ent</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;project&quot;</span><span class=p>:</span>
                    <span class=n>parent_ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=n>parent_ftrack_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
                        <span class=bp>self</span><span class=o>.</span><span class=n>entities_query_by_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                            <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>parent_ftrack_id</span>
                        <span class=p>)</span>
                    <span class=p>)</span><span class=o>.</span><span class=n>one</span><span class=p>()</span>
            <span class=n>entity_type</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span>
            <span class=n>new_entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>create</span><span class=p>(</span><span class=n>entity_type</span><span class=p>,</span> <span class=p>{</span>
                <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>],</span>
                <span class=s2>&quot;parent&quot;</span><span class=p>:</span> <span class=n>parent_ftrack_ent</span>
            <span class=p>})</span>
            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=c1># TODO report</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rolback</span><span class=p>()</span>
                <span class=n>ent_path_items</span> <span class=o>=</span> <span class=p>[</span><span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;full_name&quot;</span><span class=p>]]</span>
                <span class=n>ent_path_items</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span>
                    <span class=n>par</span> <span class=k>for</span> <span class=n>par</span> <span class=ow>in</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;parents&quot;</span><span class=p>]</span>
                <span class=p>])</span>
                <span class=n>ent_path_items</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>])</span>
                <span class=n>ent_path</span> <span class=o>=</span> <span class=s2>&quot;/&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>ent_path_items</span><span class=p>)</span>

                <span class=n>error_msg</span> <span class=o>=</span> <span class=s2>&quot;Couldn&#39;t recreate entity in ftrack&quot;</span>
                <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Trying to recreate because it or its children&quot;</span>
                    <span class=s2>&quot; contain published data&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>. Process session commit failed! &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span>
                    <span class=p>),</span>
                    <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                <span class=p>)</span>
                <span class=k>continue</span>

            <span class=n>new_entity_id</span> <span class=o>=</span> <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]</span>
            <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_entity_id</span>

            <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>val</span><span class=p>:</span>
                    <span class=k>continue</span>
                <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>]:</span>
                    <span class=k>continue</span>

                <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>val</span>

            <span class=n>new_entity</span><span class=p>[</span><span class=s2>&quot;custom_attributes&quot;</span><span class=p>][</span><span class=n>CUST_ATTR_KEY_SERVER_ID</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                <span class=nb>str</span><span class=p>(</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>])</span>
            <span class=p>)</span>
            <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>new_entity_id</span><span class=p>)</span>

            <span class=k>try</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
            <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
                <span class=c1># TODO logging</span>
                <span class=c1># TODO report</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>rolback</span><span class=p>()</span>
                <span class=n>error_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;Couldn&#39;t update custom attributes after recreation&quot;</span>
                    <span class=s2>&quot; of entity in ftrack&quot;</span>
                <span class=p>)</span>
                <span class=n>report_msg</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>||Entity was recreated because it or its children&quot;</span>
                    <span class=s2>&quot; contain published data&quot;</span>
                <span class=p>)</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>error_msg</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;warning&quot;</span><span class=p>][</span><span class=n>report_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
                    <span class=s2>&quot;</span><span class=si>{}</span><span class=s2>. Process session commit failed! &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                        <span class=n>error_msg</span><span class=p>,</span> <span class=n>ent_path</span>
                    <span class=p>),</span>
                    <span class=n>exc_info</span><span class=o>=</span><span class=kc>True</span>
                <span class=p>)</span>
                <span class=k>continue</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span><span class=p>[</span><span class=s2>&quot;info&quot;</span><span class=p>][</span><span class=n>recreate_msg</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ent_path</span><span class=p>)</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span><span class=p>[</span><span class=n>old_ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_entity_id</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>

            <span class=n>found_idx</span> <span class=o>=</span> <span class=kc>None</span>
            <span class=n>proj_doc</span><span class=p>,</span> <span class=n>asset_docs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span>
            <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>asset_doc</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>asset_docs</span><span class=p>):</span>
                <span class=k>if</span> <span class=n>asset_doc</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]:</span>
                    <span class=n>found_idx</span> <span class=o>=</span> <span class=n>idx</span>
                    <span class=k>break</span>

            <span class=k>if</span> <span class=n>found_idx</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=c1># Prepare updates dict for mongo update</span>
            <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]]:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

            <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;ftrackId&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                <span class=n>new_entity_id</span>
            <span class=p>)</span>
            <span class=c1># Update cached entities</span>
            <span class=n>asset_docs</span><span class=p>[</span><span class=n>found_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=n>proj_doc</span><span class=p>,</span> <span class=n>asset_docs</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>vis_par</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;visualParent&quot;</span><span class=p>]</span>
                <span class=n>children</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span>
                <span class=n>found_idx</span> <span class=o>=</span> <span class=kc>None</span>
                <span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>_entity</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>children</span><span class=p>):</span>
                    <span class=k>if</span> <span class=n>_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]:</span>
                        <span class=n>found_idx</span> <span class=o>=</span> <span class=n>idx</span>
                        <span class=k>break</span>
                <span class=n>children</span><span class=p>[</span><span class=n>found_idx</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span><span class=p>[</span><span class=n>vis_par</span><span class=p>]</span> <span class=o>=</span> <span class=n>children</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>old_ftrack_id</span><span class=p>)</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span><span class=p>[</span><span class=n>new_entity_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                    <span class=n>avalon_entity</span>
                <span class=p>)</span>

            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
                <span class=n>name</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span>

    <span class=c1># Check if entities with same name can be synchronized</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>removed_names</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>check_names_synchronizable</span><span class=p>(</span><span class=n>removed_names</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_task_updates class="doc doc-heading"> <code class="highlight language-python"><span class=n>process_task_updates</span><span class=p>()</span></code> </h3> <div class="doc doc-contents "> <pre><code>Pull task information for selected ftrack ids to replace stored
existing in Avalon.
Solves problem of changing type (even Status in the future) of
task without storing ftrack id for task in the DB. (Which doesn't
bring much advantage currently and it could be troublesome for
all hosts or plugins (for example Nuke) to collect and store.
</code></pre> <p>Returns: None</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2372</span>
<span class=normal>2373</span>
<span class=normal>2374</span>
<span class=normal>2375</span>
<span class=normal>2376</span>
<span class=normal>2377</span>
<span class=normal>2378</span>
<span class=normal>2379</span>
<span class=normal>2380</span>
<span class=normal>2381</span>
<span class=normal>2382</span>
<span class=normal>2383</span>
<span class=normal>2384</span>
<span class=normal>2385</span>
<span class=normal>2386</span>
<span class=normal>2387</span>
<span class=normal>2388</span>
<span class=normal>2389</span>
<span class=normal>2390</span>
<span class=normal>2391</span>
<span class=normal>2392</span>
<span class=normal>2393</span>
<span class=normal>2394</span>
<span class=normal>2395</span>
<span class=normal>2396</span>
<span class=normal>2397</span>
<span class=normal>2398</span>
<span class=normal>2399</span>
<span class=normal>2400</span>
<span class=normal>2401</span>
<span class=normal>2402</span>
<span class=normal>2403</span>
<span class=normal>2404</span>
<span class=normal>2405</span>
<span class=normal>2406</span>
<span class=normal>2407</span>
<span class=normal>2408</span>
<span class=normal>2409</span>
<span class=normal>2410</span>
<span class=normal>2411</span>
<span class=normal>2412</span>
<span class=normal>2413</span>
<span class=normal>2414</span>
<span class=normal>2415</span>
<span class=normal>2416</span>
<span class=normal>2417</span>
<span class=normal>2418</span>
<span class=normal>2419</span>
<span class=normal>2420</span>
<span class=normal>2421</span>
<span class=normal>2422</span>
<span class=normal>2423</span>
<span class=normal>2424</span>
<span class=normal>2425</span>
<span class=normal>2426</span>
<span class=normal>2427</span>
<span class=normal>2428</span>
<span class=normal>2429</span>
<span class=normal>2430</span>
<span class=normal>2431</span>
<span class=normal>2432</span>
<span class=normal>2433</span>
<span class=normal>2434</span>
<span class=normal>2435</span>
<span class=normal>2436</span>
<span class=normal>2437</span>
<span class=normal>2438</span>
<span class=normal>2439</span>
<span class=normal>2440</span>
<span class=normal>2441</span>
<span class=normal>2442</span>
<span class=normal>2443</span>
<span class=normal>2444</span>
<span class=normal>2445</span>
<span class=normal>2446</span>
<span class=normal>2447</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>process_task_updates</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Pull task information for selected ftrack ids to replace stored</span>
<span class=sd>        existing in Avalon.</span>
<span class=sd>        Solves problem of changing type (even Status in the future) of</span>
<span class=sd>        task without storing ftrack id for task in the DB. (Which doesn&#39;t</span>
<span class=sd>        bring much advantage currently and it could be troublesome for</span>
<span class=sd>        all hosts or plugins (for example Nuke) to collect and store.</span>
<span class=sd>    Returns:</span>
<span class=sd>        None</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
        <span class=s2>&quot;Processing task changes for parents: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
        <span class=p>)</span>
    <span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=n>joined_ids</span> <span class=o>=</span> <span class=s2>&quot;, &quot;</span><span class=o>.</span><span class=n>join</span><span class=p>([</span>
        <span class=s2>&quot;</span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
    <span class=p>])</span>
    <span class=n>task_entities</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>task_entities_query_by_parent_id</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>cur_project</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>],</span> <span class=n>joined_ids</span>
        <span class=p>)</span>
    <span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>

    <span class=n>ftrack_mongo_mapping_found</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=n>not_found_ids</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=c1># Make sure all parents have updated tasks, as they may not have any</span>
    <span class=n>tasks_per_ftrack_id</span> <span class=o>=</span> <span class=p>{</span>
        <span class=n>ftrack_id</span><span class=p>:</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span>
    <span class=p>}</span>

    <span class=c1># Query all task types at once</span>
    <span class=n>task_types</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>process_session</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>task_types_query</span><span class=p>)</span><span class=o>.</span><span class=n>all</span><span class=p>()</span>
    <span class=n>task_types_by_id</span> <span class=o>=</span> <span class=p>{</span>
        <span class=n>task_type</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>]:</span> <span class=n>task_type</span>
        <span class=k>for</span> <span class=n>task_type</span> <span class=ow>in</span> <span class=n>task_types</span>
    <span class=p>}</span>

    <span class=c1># prepare all tasks per parentId, eg. Avalon asset record</span>
    <span class=k>for</span> <span class=n>task_entity</span> <span class=ow>in</span> <span class=n>task_entities</span><span class=p>:</span>
        <span class=n>task_type</span> <span class=o>=</span> <span class=n>task_types_by_id</span><span class=p>[</span><span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;type_id&quot;</span><span class=p>]]</span>
        <span class=n>ftrack_id</span> <span class=o>=</span> <span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;parent_id&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>ftrack_id</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>tasks_per_ftrack_id</span><span class=p>:</span>
            <span class=n>tasks_per_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>

        <span class=n>passed_regex</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>check_regex</span><span class=p>(</span>
            <span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>],</span> <span class=s2>&quot;task&quot;</span><span class=p>,</span>
            <span class=n>schema_patterns</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span>
        <span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>passed_regex</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;id&quot;</span><span class=p>])</span>
            <span class=k>continue</span>

        <span class=n>tasks_per_ftrack_id</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>][</span><span class=n>task_entity</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span> <span class=o>=</span> <span class=p>{</span>
            <span class=s2>&quot;type&quot;</span><span class=p>:</span> <span class=n>task_type</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span>
        <span class=p>}</span>

    <span class=c1># find avalon entity by parentId</span>
    <span class=c1># should be there as create was run first</span>
    <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>tasks_per_ftrack_id</span><span class=o>.</span><span class=n>keys</span><span class=p>():</span>
        <span class=n>avalon_entity</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_entity</span><span class=p>:</span>
            <span class=n>not_found_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>continue</span>
        <span class=n>ftrack_mongo_mapping_found</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_entity</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_update_avalon_tasks</span><span class=p>(</span>
        <span class=n>ftrack_mongo_mapping_found</span><span class=p>,</span>
        <span class=n>tasks_per_ftrack_id</span>
    <span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.process_updated class="doc doc-heading"> <code class="highlight language-python"><span class=n>process_updated</span><span class=p>()</span></code> </h3> <div class="doc doc-contents "> <p>Only custom attributes changes should get here</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>1886</span>
<span class=normal>1887</span>
<span class=normal>1888</span>
<span class=normal>1889</span>
<span class=normal>1890</span>
<span class=normal>1891</span>
<span class=normal>1892</span>
<span class=normal>1893</span>
<span class=normal>1894</span>
<span class=normal>1895</span>
<span class=normal>1896</span>
<span class=normal>1897</span>
<span class=normal>1898</span>
<span class=normal>1899</span>
<span class=normal>1900</span>
<span class=normal>1901</span>
<span class=normal>1902</span>
<span class=normal>1903</span>
<span class=normal>1904</span>
<span class=normal>1905</span>
<span class=normal>1906</span>
<span class=normal>1907</span>
<span class=normal>1908</span>
<span class=normal>1909</span>
<span class=normal>1910</span>
<span class=normal>1911</span>
<span class=normal>1912</span>
<span class=normal>1913</span>
<span class=normal>1914</span>
<span class=normal>1915</span>
<span class=normal>1916</span>
<span class=normal>1917</span>
<span class=normal>1918</span>
<span class=normal>1919</span>
<span class=normal>1920</span>
<span class=normal>1921</span>
<span class=normal>1922</span>
<span class=normal>1923</span>
<span class=normal>1924</span>
<span class=normal>1925</span>
<span class=normal>1926</span>
<span class=normal>1927</span>
<span class=normal>1928</span>
<span class=normal>1929</span>
<span class=normal>1930</span>
<span class=normal>1931</span>
<span class=normal>1932</span>
<span class=normal>1933</span>
<span class=normal>1934</span>
<span class=normal>1935</span>
<span class=normal>1936</span>
<span class=normal>1937</span>
<span class=normal>1938</span>
<span class=normal>1939</span>
<span class=normal>1940</span>
<span class=normal>1941</span>
<span class=normal>1942</span>
<span class=normal>1943</span>
<span class=normal>1944</span>
<span class=normal>1945</span>
<span class=normal>1946</span>
<span class=normal>1947</span>
<span class=normal>1948</span>
<span class=normal>1949</span>
<span class=normal>1950</span>
<span class=normal>1951</span>
<span class=normal>1952</span>
<span class=normal>1953</span>
<span class=normal>1954</span>
<span class=normal>1955</span>
<span class=normal>1956</span>
<span class=normal>1957</span>
<span class=normal>1958</span>
<span class=normal>1959</span>
<span class=normal>1960</span>
<span class=normal>1961</span>
<span class=normal>1962</span>
<span class=normal>1963</span>
<span class=normal>1964</span>
<span class=normal>1965</span>
<span class=normal>1966</span>
<span class=normal>1967</span>
<span class=normal>1968</span>
<span class=normal>1969</span>
<span class=normal>1970</span>
<span class=normal>1971</span>
<span class=normal>1972</span>
<span class=normal>1973</span>
<span class=normal>1974</span>
<span class=normal>1975</span>
<span class=normal>1976</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>process_updated</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Only custom attributes changes should get here</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
        <span class=s2>&quot;Processing updated entities: </span><span class=si>{}</span><span class=s2>&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=nb>str</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span><span class=p>))</span>
    <span class=p>)</span>

    <span class=n>ent_infos</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span>
    <span class=n>ftrack_mongo_mapping</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=n>not_found_ids</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_ftrack_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>avalon_ent</span><span class=p>:</span>
            <span class=n>not_found_ids</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
            <span class=k>continue</span>

        <span class=n>ftrack_mongo_mapping</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;_id&quot;</span><span class=p>]</span>

    <span class=k>for</span> <span class=n>ftrack_id</span> <span class=ow>in</span> <span class=n>not_found_ids</span><span class=p>:</span>
        <span class=n>ent_infos</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>ent_infos</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=n>cust_attrs</span><span class=p>,</span> <span class=n>hier_attrs</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_cust_attrs</span>
    <span class=n>hier_attrs_by_key</span> <span class=o>=</span> <span class=p>{</span>
        <span class=n>attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]:</span> <span class=n>attr</span>
        <span class=k>for</span> <span class=n>attr</span> <span class=ow>in</span> <span class=n>hier_attrs</span>
    <span class=p>}</span>
    <span class=n>cust_attrs_by_obj_id</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>
    <span class=k>for</span> <span class=n>cust_attr</span> <span class=ow>in</span> <span class=n>cust_attrs</span><span class=p>:</span>
        <span class=n>key</span> <span class=o>=</span> <span class=n>cust_attr</span><span class=p>[</span><span class=s2>&quot;key&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=n>key</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;avalon_&quot;</span><span class=p>):</span>
            <span class=k>continue</span>

        <span class=n>ca_ent_type</span> <span class=o>=</span> <span class=n>cust_attr</span><span class=p>[</span><span class=s2>&quot;entity_type&quot;</span><span class=p>]</span>

        <span class=k>if</span> <span class=n>ca_ent_type</span> <span class=o>==</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
            <span class=n>cust_attrs_by_obj_id</span><span class=p>[</span><span class=n>ca_ent_type</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>cust_attr</span>

        <span class=k>elif</span> <span class=n>ca_ent_type</span> <span class=o>==</span> <span class=s2>&quot;task&quot;</span><span class=p>:</span>
            <span class=n>obj_id</span> <span class=o>=</span> <span class=n>cust_attr</span><span class=p>[</span><span class=s2>&quot;object_type_id&quot;</span><span class=p>]</span>
            <span class=n>cust_attrs_by_obj_id</span><span class=p>[</span><span class=n>obj_id</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>cust_attr</span>

    <span class=k>for</span> <span class=n>ftrack_id</span><span class=p>,</span> <span class=n>ent_info</span> <span class=ow>in</span> <span class=n>ent_infos</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>mongo_id</span> <span class=o>=</span> <span class=n>ftrack_mongo_mapping</span><span class=p>[</span><span class=n>ftrack_id</span><span class=p>]</span>
        <span class=n>entType</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;entityType&quot;</span><span class=p>]</span>
        <span class=n>ent_path</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_ent_path</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>entType</span> <span class=o>==</span> <span class=s2>&quot;show&quot;</span><span class=p>:</span>
            <span class=n>ent_cust_attrs</span> <span class=o>=</span> <span class=n>cust_attrs_by_obj_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;show&quot;</span><span class=p>)</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>obj_type_id</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;objectTypeId&quot;</span><span class=p>]</span>
            <span class=n>ent_cust_attrs</span> <span class=o>=</span> <span class=n>cust_attrs_by_obj_id</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>obj_type_id</span><span class=p>)</span>

        <span class=c1># ftrack&#39;s entity_type does not have defined custom attributes</span>
        <span class=k>if</span> <span class=n>ent_cust_attrs</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=n>ent_cust_attrs</span> <span class=o>=</span> <span class=p>{}</span>

        <span class=n>ent_changes</span> <span class=o>=</span> <span class=n>ent_info</span><span class=p>[</span><span class=s2>&quot;changes&quot;</span><span class=p>]</span>
        <span class=k>if</span> <span class=s2>&quot;description&quot;</span> <span class=ow>in</span> <span class=n>ent_changes</span><span class=p>:</span>
            <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=s2>&quot;description&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span>
                <span class=n>ent_changes</span><span class=p>[</span><span class=s2>&quot;description&quot;</span><span class=p>][</span><span class=s2>&quot;new&quot;</span><span class=p>]</span> <span class=ow>or</span> <span class=s2>&quot;&quot;</span>
            <span class=p>)</span>

        <span class=k>for</span> <span class=n>key</span><span class=p>,</span> <span class=n>values</span> <span class=ow>in</span> <span class=n>ent_changes</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
            <span class=k>if</span> <span class=n>key</span> <span class=ow>in</span> <span class=n>hier_attrs_by_key</span><span class=p>:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>hier_cust_attrs_changes</span><span class=p>[</span><span class=n>key</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ftrack_id</span><span class=p>)</span>
                <span class=k>continue</span>

            <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>ent_cust_attrs</span><span class=p>:</span>
                <span class=k>continue</span>

            <span class=n>value</span> <span class=o>=</span> <span class=n>values</span><span class=p>[</span><span class=s2>&quot;new&quot;</span><span class=p>]</span>
            <span class=n>new_value</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>convert_value_by_cust_attr_conf</span><span class=p>(</span>
                <span class=n>value</span><span class=p>,</span> <span class=n>ent_cust_attrs</span><span class=p>[</span><span class=n>key</span><span class=p>]</span>
            <span class=p>)</span>

            <span class=k>if</span> <span class=s2>&quot;data&quot;</span> <span class=ow>not</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]:</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>][</span><span class=s2>&quot;data&quot;</span><span class=p>][</span><span class=n>key</span><span class=p>]</span> <span class=o>=</span> <span class=n>new_value</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span>
                <span class=s2>&quot;Setting data value of </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> to </span><span class=se>\&quot;</span><span class=si>{}</span><span class=se>\&quot;</span><span class=s2> &lt;</span><span class=si>{}</span><span class=s2>&gt;&quot;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span>
                    <span class=n>key</span><span class=p>,</span> <span class=n>new_value</span><span class=p>,</span> <span class=n>ent_path</span>
                <span class=p>)</span>
            <span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.reset_variables class="doc doc-heading"> <code class="highlight language-python"><span class=n>reset_variables</span><span class=p>()</span></code> </h3> <div class="doc doc-contents "> <p>Reset variables so each event callback has clear env.</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>469</span>
<span class=normal>470</span>
<span class=normal>471</span>
<span class=normal>472</span>
<span class=normal>473</span>
<span class=normal>474</span>
<span class=normal>475</span>
<span class=normal>476</span>
<span class=normal>477</span>
<span class=normal>478</span>
<span class=normal>479</span>
<span class=normal>480</span>
<span class=normal>481</span>
<span class=normal>482</span>
<span class=normal>483</span>
<span class=normal>484</span>
<span class=normal>485</span>
<span class=normal>486</span>
<span class=normal>487</span>
<span class=normal>488</span>
<span class=normal>489</span>
<span class=normal>490</span>
<span class=normal>491</span>
<span class=normal>492</span>
<span class=normal>493</span>
<span class=normal>494</span>
<span class=normal>495</span>
<span class=normal>496</span>
<span class=normal>497</span>
<span class=normal>498</span>
<span class=normal>499</span>
<span class=normal>500</span>
<span class=normal>501</span>
<span class=normal>502</span>
<span class=normal>503</span>
<span class=normal>504</span>
<span class=normal>505</span>
<span class=normal>506</span>
<span class=normal>507</span>
<span class=normal>508</span>
<span class=normal>509</span>
<span class=normal>510</span>
<span class=normal>511</span>
<span class=normal>512</span>
<span class=normal>513</span>
<span class=normal>514</span>
<span class=normal>515</span>
<span class=normal>516</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>reset_variables</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;Reset variables so each event callback has clear env.&quot;&quot;&quot;</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_cur_project</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_cust_attrs</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_cust_attr_types_by_id</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_id</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_parent_id</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_ftrack_id</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_ents_by_name</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_asset_ids_with_subsets</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_changeability_by_mongo_id</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_id</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_avalon_archived_by_name</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>_ent_types_by_name</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_ents_by_id</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>obj_id_ent_type_map</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_recreated_mapping</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_added</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_moved</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_renamed</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_updated</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>ftrack_removed</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=c1># set of ftrack ids with modified tasks</span>
    <span class=c1># handled separately by full wipeout and replace from ftrack</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>modified_tasks_ftrackids</span> <span class=o>=</span> <span class=nb>set</span><span class=p>()</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>moved_in_avalon</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>renamed_in_avalon</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>hier_cust_attrs_changes</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>duplicated</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>regex_failed</span> <span class=o>=</span> <span class=p>[]</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>regex_schemas</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>updates</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>report_items</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>&quot;info&quot;</span><span class=p>:</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>),</span>
        <span class=s2>&quot;warning&quot;</span><span class=p>:</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>),</span>
        <span class=s2>&quot;error&quot;</span><span class=p>:</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>
    <span class=p>}</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> <div class="doc doc-object doc-function"> <h3 id=services.processor.processor.handlers_to_convert.event_sync_to_avalon.SyncToAvalonEvent.update_entities class="doc doc-heading"> <code class="highlight language-python"><span class=n>update_entities</span><span class=p>()</span></code> </h3> <div class="doc doc-contents "> <p>Update Avalon entities by mongo bulk changes. Expects self.updates which are transfered to $set part of update command. Resets self.updates afterwards.</p> <details class=quote> <summary>Source code in <code>services/processor/processor/handlers_to_convert/event_sync_to_avalon.py</code></summary> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal>2449</span>
<span class=normal>2450</span>
<span class=normal>2451</span>
<span class=normal>2452</span>
<span class=normal>2453</span>
<span class=normal>2454</span>
<span class=normal>2455</span>
<span class=normal>2456</span>
<span class=normal>2457</span>
<span class=normal>2458</span>
<span class=normal>2459</span>
<span class=normal>2460</span>
<span class=normal>2461</span>
<span class=normal>2462</span>
<span class=normal>2463</span>
<span class=normal>2464</span>
<span class=normal>2465</span>
<span class=normal>2466</span>
<span class=normal>2467</span>
<span class=normal>2468</span>
<span class=normal>2469</span></pre></div></td><td class=code><div><pre><span></span><code><span class=k>def</span><span class=w> </span><span class=nf>update_entities</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Update Avalon entities by mongo bulk changes.</span>
<span class=sd>        Expects self.updates which are transfered to $set part of update</span>
<span class=sd>        command.</span>
<span class=sd>        Resets self.updates afterwards.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>mongo_changes_bulk</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=k>for</span> <span class=n>mongo_id</span><span class=p>,</span> <span class=n>changes</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>updates</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
        <span class=n>avalon_ent</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>avalon_ents_by_id</span><span class=p>[</span><span class=n>mongo_id</span><span class=p>]</span>
        <span class=n>is_project</span> <span class=o>=</span> <span class=n>avalon_ent</span><span class=p>[</span><span class=s2>&quot;type&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=s2>&quot;project&quot;</span>
        <span class=n>change_data</span> <span class=o>=</span> <span class=n>avalon_sync</span><span class=o>.</span><span class=n>from_dict_to_set</span><span class=p>(</span><span class=n>changes</span><span class=p>,</span> <span class=n>is_project</span><span class=p>)</span>
        <span class=n>mongo_changes_bulk</span><span class=o>.</span><span class=n>append</span><span class=p>(</span>
            <span class=n>UpdateOne</span><span class=p>({</span><span class=s2>&quot;_id&quot;</span><span class=p>:</span> <span class=n>mongo_id</span><span class=p>},</span> <span class=n>change_data</span><span class=p>)</span>
        <span class=p>)</span>

    <span class=k>if</span> <span class=ow>not</span> <span class=n>mongo_changes_bulk</span><span class=p>:</span>
        <span class=k>return</span>

    <span class=bp>self</span><span class=o>.</span><span class=n>dbcon</span><span class=o>.</span><span class=n>bulk_write</span><span class=p>(</span><span class=n>mongo_changes_bulk</span><span class=p>)</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>updates</span> <span class=o>=</span> <span class=n>collections</span><span class=o>.</span><span class=n>defaultdict</span><span class=p>(</span><span class=nb>dict</span><span class=p>)</span>
</code></pre></div></td></tr></table></div> </details> </div> </div> </div> </div> </div> </div> </div> </div> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../../../..", "features": ["navigation.sections", "navigation.path", "navigation.prune"], "search": "../../../../../assets/javascripts/workers/search.f8cc74c7.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../../../../assets/javascripts/bundle.c8b220af.min.js></script> </body> </html>